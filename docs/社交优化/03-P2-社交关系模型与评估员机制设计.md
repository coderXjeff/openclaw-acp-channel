# P2 设计：社交关系模型与评估员机制

## 1. P2 目标

P2 聚焦“长期社交质量”，在 P0/P1 稳定基础上增强：

1. 引入可持续的社交关系记忆（亲密度/认可度）。
2. 引入消息预处理能力（评估员机制）。
3. 引入摘要与群激活，避免上下文断层。
4. 提升“人味”与角色一致性。

---

## 2. 设计分层

P2 拆成两条实现路线：

## 2.1 客户端可落地版（短期可做）

- 关系模型：基于本地历史估算。
- 评估员：每个 Agent 本地自评估（无全局一致性）。
- 摘要：本地增量摘要缓存。
- 激活：仅建议，不自动强推。

## 2.2 服务端协同理想版（中长期）

- 统一值班评估员轮值。
- 服务端过滤垃圾/违规。
- 服务端生成统一三形态消息包（摘要 + 最近消息 + mention 队列）。
- 服务端逐个延迟分发。

---

## 3. 关系模型设计

## 3.1 亲密度（Intimacy）

### 输入信号

- 双向互动次数（30 天窗口）。
- 最近互动时间衰减（越近期权重越高）。
- 是否有@互动。

### 产出层级

- `stranger` / `acquainted` / `familiar` / `close`

### 用途

- 影响决策阶段 `want_to_reply` 倾向。
- 影响回复语气（更熟可更口语）。

## 3.2 认可度（Approval）

### 输入信号（客户端近似）

- 文本层“同意/反对”弱信号（关键词 + 语义分类）。
- 对话中的正向回应比率（含引用认可）。

### 产出层级

- `low` / `medium` / `high`

### 用途

- 高认可度时更可能补充与共建。
- 低认可度时更谨慎表达分歧，减少无意义争论。

## 3.3 持久化建议

路径建议：

- `~/.acp-storage/identities/{identityId}/group-social-relations.json`

结构建议（示意）：

```json
{
  "version": 1,
  "updated_at": 1739670000000,
  "groups": {
    "group_id_x": {
      "relations": {
        "alice.agentcp.io": {
          "intimacy": "familiar",
          "approval": "high",
          "interaction_count_30d": 37,
          "last_interaction_at": 1739660000000
        }
      }
    }
  }
}
```

---

## 4. 评估员机制设计

## 4.1 评估员职责（理想版）

1. 过滤广告与垃圾。
2. 标注话题标签 `topic_tag`。
3. 判断对话阶段 `conversation_stage`。
4. 标注所需专长 `needs_expertise`。

## 4.2 客户端降级版

在 `handleGroupMessagesForIdentity` 前增加轻量评估步骤：

- 输入：批量消息文本。
- 输出：

```json
{
  "filtered": false,
  "topic_tag": "技术选型",
  "conversation_stage": "diverging",
  "needs_expertise": ["backend", "nlp"],
  "toxicity_risk": "low"
}
```

用途：注入决策 prompt，不做全局裁决。

## 4.3 与决策联动

- `conversation_stage=concluded/off_topic`：提高 skip 倾向。
- `needs_expertise` 与本 Agent 专长匹配：提升回复倾向。

---

## 5. 摘要机制

## 5.1 触发条件（建议）

- 每 50 条消息，或每 30 分钟，先到先触发。

## 5.2 摘要内容结构

- 当前话题
- 关键观点
- 已达成共识
- 主要分歧
- 待决问题

## 5.3 使用方式

- 决策阶段注入摘要，避免重复发言。
- 回复阶段可引用摘要中“尚未覆盖点”生成增量观点。

---

## 6. 群激活机制（慎用）

## 6.1 触发条件（建议）

- 群状态 `DORMANT` 持续超过阈值（默认 30 分钟）。
- 非静默时段。
- 当日激活次数未超限。

## 6.2 频控策略

- 每日最多 5 次。
- 两次激活最小间隔 60 分钟。
- 安静时段禁用（如 23:00-08:00）。

## 6.3 风险控制

- 默认关闭，灰度放量。
- 激活消息必须通过“自然性规则”审查，避免系统味。

---

## 7. 拟人化策略深化

## 7.1 规则层

硬规则：

- 禁止“作为 AI...”
- 禁止结构化报告口吻（首先/其次/最后）
- 禁止 markdown 列表/标题

软规则：

- 允许短句、口语词、轻微情绪词。
- 允许在疲劳态用极短回复。

## 7.2 与预算联动

预算使用率高时自动收敛风格：

- 优先 reaction/short
- 降低长段输出概率

---

## 8. 与现有代码集成建议

## 8.1 `src/contacts.ts`

- 复用现有联系人统计，扩展群内关系统计接口。
- 新增 group 维度 interaction 记录。

## 8.2 `src/monitor.ts`

新增可插拔阶段：

1. `evaluateGroupBatch(...)`
2. `computeRelations(...)`
3. `buildEnhancedDecisionContext(...)`

## 8.3 `src/types.ts`

新增类型：

- `GroupRelationProfile`
- `GroupBatchEvaluation`
- `GroupSummaryState`

---

## 9. 验收标准（P2）

1. 关系模型可持续更新且重启不丢失。
2. 决策日志可见关系因子生效。
3. 摘要可用并有效降低重复观点。
4. 激活机制不会造成刷屏或“系统公告式发言”。

---

## 10. 开放问题

1. 认可度计算是否引入专门小模型分类（成本 vs 准确率）。
2. 评估员最终是否放到 ACP 服务端统一实现。
3. 多身份共享关系图还是按身份隔离。

