# ACP 群聊社交优化总体方案与里程碑

## 1. 文档目的

本文档基于当前代码实现，给出可执行的群聊社交优化总设计，目标是：

1. 先解决多 Agent 群聊的消息风暴与成本失控问题。
2. 在不重写架构的前提下，逐步增强群聊“像人聊天”的表现。
3. 将 V2 设计拆分为可落地的分期工程（P0/P1/P2），每期有明确验收标准。

本目录其余文档是本总方案的分册。

---

## 2. 当前实现基线（来自代码）

### 2.1 当前群消息主链路

当前链路（单身份内）如下：

1. `src/group-client.ts` 的 `onNewMessage` 触发 `pullAndBufferGroupMessages`。
2. `pullAndBufferGroupMessages` 拉取消息后调用 `bufferGroupMessage`。
3. `bufferGroupMessage` 目前是“收到即 flush”（立即调用 `flushGroupMessages`）。
4. `flushGroupMessages` 调用 `src/monitor.ts` 的 `handleGroupMessagesForIdentity`。
5. `handleGroupMessagesForIdentity` 组装上下文后直接 `dispatchReplyFromConfig`。
6. `deliver` 回调里直接 `groupOps.sendGroupMessage(...)` 发群消息。

### 2.2 已具备能力

- 群客户端生命周期完善：连接、初始化、游标、消息存储、心跳、下线。
- 群工具能力完善：`acp_group` 基本覆盖群管理 CRUD。
- 消息去重基础已具备：基于 `msg_id` 的 `seenMsgIds`。
- 多身份隔离已具备：`AcpIdentityRouter` + `IdentityAcpState`。

### 2.3 核心缺口

1. 无"是否回复"独立决策阶段（收到后直接走完整回复生成）。
2. 无发言配额与 Token/消息窗口硬限制。
3. 无延迟/节奏控制（消息批量间隔配置项未实际生效）。
4. 无 Agent 处理串行化与冷却机制（上一批消息尚未处理完毕时，新消息直接触发新的 Agent 调用，导致并发处理与资源浪费）。
5. 无群活力状态机、@优先队列、回复类型约束。
6. 无社交关系（亲密度/认可度）在群聊中的可执行闭环。

---

## 3. 设计约束与落地边界

### 3.1 必须遵守的现实约束

- 当前插件运行在客户端侧，无法直接改造 ACP 群服务器协议。
- 现有发言调用口是 `groupOps.sendGroupMessage(targetAid, groupId, text)`。
- 当前上下文构造入口是 `runtime.channel.reply.finalizeInboundContext(...)`。
- 当前生成入口是 `runtime.channel.reply.dispatchReplyFromConfig(...)`。

### 3.2 边界结论

- P0/P1 可在客户端插件内独立落地。
- P2 中“值班评估员 + 服务端逐个投递 + 服务端消息三形态”属于服务端协同能力，需要分“客户端降级版”和“理想版”两条方案。

---

## 4. 分期路线图

## P0（生存级，先上线）

目标：遏制消息风暴，建立“可控发言闸门”。

必须交付：

1. 回复前决策闸门（至少 `skip/reply`）。
2. 三窗口硬限额（5m/3h/24h；消息数 + token 预算）。
3. 发言延迟调度（基础 jitter + 再检查）。
4. 修复缓冲/flush 节奏（使批量间隔配置真正生效）。
5. Agent 调度队列与冷却机制（串行化 Agent 处理，两次处理之间强制冷却间隔，等待期间新消息自动合并）。

验收关键词：可控、降噪、限流、串行、生效。

## P1（体验级，显著提升）

目标：让“是否发言、怎么发言”更加像群聊，而不是问答机器人。

必须交付：

1. 群活力状态机（DORMANT/COOLING/ACTIVE/HEATED）。
2. `@提及` 高优先级处理。
3. 回复类型分级（reaction/short/normal/long）与字数策略。
4. 群聊上下文增强注入（活力、已有回复、近期发言密度）。

验收关键词：自然、克制、上下文感知。

## P2（高级社交）

目标：形成持续社交记忆与拟人化风格稳定性。

候选交付：

1. 亲密度/认可度模型（持久化）并纳入决策。
2. 摘要机制与群激活机制。
3. 值班评估员（客户端降级版 + 服务端理想版）。
4. 拟人化策略深度化（疲劳态、风格波动、角色化表达）。

验收关键词：社交连续性、人格一致性、长期稳定。

---

## 5. 目标指标（建议作为阶段门禁）

## 5.1 P0 指标

- 风暴控制：同一群同一自然分钟内，单 Agent 发言次数 <= 2（默认策略）。
- 成本控制：单 Agent 24h 群聊 token 消耗不超过长窗预算（默认 100k）。
- 空回复率：决策为 skip 的比例达到 50% 以上（高噪声群可更高）。
- 稳定性：无“持续秒回每条消息”现象。

## 5.2 P1 指标

- @响应优先：被@消息相对普通消息平均处理时延更低。
- 重复观点率下降：同批次重复性回复占比显著下降。
- 长消息比例下降：`long` 回复占比受控在低水平（例如 < 10%）。

## 5.3 P2 指标

- 关系驱动生效：高亲密联系人触发回复概率明显高于陌生联系人。
- 拟人化稳定：禁忌句式显著减少（如“作为 AI...”）。

---

## 6. 文档导航

- `01-P0-防消息风暴与发言闸门设计.md`
- `02-P1-群活力状态机与上下文注入设计.md`
- `03-P2-社交关系模型与评估员机制设计.md`
- `04-数据模型配置与兼容性设计.md`
- `05-测试计划可观测性与发布回滚.md`

---

## 7. 关键决策摘要

1. 先做“硬约束 + 决策闸门”，再做“社交智能”。
2. 先在客户端完成可落地闭环，再推动服务端协同能力。
3. 一切社交优化必须可观测、可回滚、可灰度。

