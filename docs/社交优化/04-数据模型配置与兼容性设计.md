# 数据模型、配置与兼容性设计（P0-P2 通用）

## 1. 目标

定义群聊社交优化所需的数据模型与配置扩展，确保：

1. 与现有 `types.ts` / `config-schema.ts` 兼容。
2. 可灰度、可回滚、可逐步启用。
3. 多身份隔离场景下状态不串。

---

## 2. 现有可复用结构

现有关键结构：

- `IdentityAcpState`
- `GroupMessageBuffer`
- `AcpSessionConfig.groupMessageIntervalMs`
- `Contact`（有 interactionCount、creditScore）

这些结构可扩展，不建议重建平行体系。

---

## 3. 类型扩展设计

## 3.1 新增顶层运行时结构

建议在 `IdentityAcpState` 中新增：

```ts
groupSocialStates: Map<string, GroupSocialState>;
```

## 3.2 GroupSocialState

```ts
interface GroupSocialState {
  groupId: string;
  version: number;
  lastUpdatedAt: number;

  // P0
  usageEvents: OutgoingUsageEvent[];
  pendingSends: Record<string, PendingSend>;
  lastSpeakAt: number | null;

  // P1
  vitality: GroupVitalityState;
  mentionQueue: MentionTask[];
  recentInboundEvents: InboundEvent[];
  replyTypeStats: ReplyTypeStats;

  // P2
  relations?: Record<string, GroupRelationProfile>;
  summary?: GroupSummaryState;
}
```

## 3.3 关键子类型

```ts
interface OutgoingUsageEvent {
  ts: number;
  msgChars: number;
  estTokens: number;
  decisionTokens?: number;
  generationTokens?: number;
  replyType?: "reaction" | "short" | "normal" | "long";
  isMentionReply?: boolean;
}

interface GroupVitalityState {
  state: "DORMANT" | "COOLING" | "ACTIVE" | "HEATED";
  messagesIn5m: number;
  uniqueSpeakersIn5m: number;
  myMessagesIn5m: number;
  updatedAt: number;
}

interface MentionTask {
  msgId?: number;
  sender: string;
  ts: number;
  contentPreview: string;
  priority: number;
}
```

---

## 4. 配置扩展设计

## 4.1 新配置块

建议新增 `groupSocial`，位置可选：

1. `channels.acp.groupSocial`（推荐）
2. `channels.acp.session.groupSocial`（保持 session 聚合）

建议使用独立块，减少 `session` 语义膨胀。

## 4.2 配置草案

```yaml
groupSocial:
  enabled: true

  batching:
    enabled: true
    interval_ms: 15000
    max_batch_messages: 50

  decision:
    enabled: true
    parse_fail_strategy: "skip"   # skip | fallback_reply
    model_timeout_ms: 12000

  limits:
    enabled: true
    short_window:
      duration_ms: 300000
      max_messages: 5
      max_tokens: 2000
    medium_window:
      duration_ms: 10800000
      max_messages: 30
      max_tokens: 30000
    long_window:
      duration_ms: 86400000
      max_messages: 100
      max_tokens: 100000

  delay:
    enabled: true
    fast_ms: [2000, 6000]
    normal_ms: [8000, 20000]
    slow_ms: [20000, 60000]

  vitality:
    enabled: false
    heated_threshold_5m: 15

  mention:
    enabled: false
    reserve_budget_ratio: 0.2

  style:
    enabled: false
    max_chars_per_message: 500
```

---

## 5. 默认值与兼容策略

## 5.1 默认策略

- `groupSocial.enabled=false`（首次上线保守）
- 灰度阶段按身份或群名单开启

## 5.2 向后兼容

1. 未配置 `groupSocial` 时，完全保持当前行为。
2. `groupMessageIntervalMs` 与 `groupSocial.batching.interval_ms` 冲突时：
   - 若 `groupSocial.batching.enabled=true`，优先 `groupSocial`。
   - 否则沿用 `groupMessageIntervalMs`。

## 5.3 版本化

持久化数据带 `version` 字段：

- `version=1` 为初始格式。
- 未来迁移时增加 `migrateGroupSocialState(v1->v2)`。

---

## 6. 持久化设计

## 6.1 路径建议

按身份隔离：

- `~/.acp-storage/identities/{identityId}/group-social-state.json`

## 6.2 写入策略

- 内存为主，定时落盘（如每 30s）+ 关键事件落盘（发送后）。
- 防抖写入，避免高频 IO。

## 6.3 启动恢复

- 启动时加载并做版本校验。
- 数据损坏时备份原文件并冷启动（空状态）。

---

## 7. 观测字段（为测试与运营准备）

每次批处理建议输出结构化日志字段：

- `identity_id`
- `group_id`
- `batch_size`
- `decision.want_to_reply`
- `decision.reply_type`
- `decision.delay_hint`
- `budget_usage_ratio`
- `budget_blocked` (bool)
- `vitality_state`
- `is_mention_batch`
- `send_result`

---

## 8. 安全与隐私

1. 群社交状态仅本地持久化，不向外暴露。
2. 不在群消息中泄露预算状态、决策原因、内部评分。
3. 日志中对消息正文做长度截断。

---

## 9. 配置 Schema 变更建议

在 `src/config-schema.ts` 添加：

- `groupSocial` object
- 子属性最小值校验（duration/token/message）
- 枚举校验（parse_fail_strategy）

注意：

- 增加 schema 不应破坏旧配置解析。
- 所有新增项必须有 default。

