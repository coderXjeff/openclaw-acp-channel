# 测试计划、可观测性与发布回滚

## 1. 文档目标

为群聊社交优化（P0/P1/P2）提供统一的测试与上线方案，确保：

1. 可验证（功能与指标）。
2. 可观测（日志与统计）。
3. 可回滚（故障不扩大）。

---

## 2. 测试分层

## 2.1 单元测试

重点覆盖纯函数与策略模块：

1. 窗口预算计算
2. 活力状态判定
3. delay 映射
4. reply_type 约束与裁剪
5. mention 识别

建议新增测试文件：

- `test/group-social-budget.test.ts`
- `test/group-social-vitality.test.ts`
- `test/group-social-decision-parse.test.ts`

## 2.2 集成测试（本地模拟）

目标：覆盖 `group-client -> monitor` 链路。

场景：

1. 消息批量间隔生效。
2. 决策为 skip 时不触发发送。
3. 超预算时发送被拦截。
4. delay 到期后二次预算检查。
5. mention 消息优先处理（P1）。

## 2.3 压测与对比测试

构造 3~10 Agent 的模拟高频群消息流，对比“优化前后”：

- 每分钟发送条数
- 每分钟估算 token
- skip 比例
- 平均回复延迟

---

## 3. 关键验收用例（P0 必测）

1. **批处理生效**
   - 输入：10 秒内 5 条消息。
   - 期望：不会产生 5 次独立回复生成调用。

2. **预算拦截生效**
   - 输入：连续触发直到短窗超限。
   - 期望：后续发送被阻止，并有预算日志。

3. **解析失败保守跳过**
   - 输入：决策模型返回非法 JSON。
   - 期望：默认 skip，不发送。

4. **延迟复检生效**
   - 输入：延迟期间预算被他处消耗。
   - 期望：到期后复检失败，不发送。

---

## 4. 可观测性设计

## 4.1 日志分层

1. `INFO`: 关键行为（批次、决策、发送）
2. `WARN`: 降级路径（解析失败、策略 fallback）
3. `ERROR`: 发送失败、状态读写失败

## 4.2 指标建议

按 `(identityId, groupId)` 聚合：

- `group_batches_total`
- `group_decision_skip_total`
- `group_decision_reply_total`
- `group_budget_block_total`
- `group_send_success_total`
- `group_send_fail_total`
- `group_est_tokens_total`
- `group_reply_delay_ms_histogram`

## 4.3 调试开关

新增可选开关：

- `groupSocial.debug=true`

开启后打印：

- 决策输入摘要
- 决策输出 JSON
- 预算窗口详情
- 延迟调度详情

---

## 5. 灰度发布策略

## 5.1 发布阶段

1. 阶段 A：仅开启 batching（不启用决策与预算）
2. 阶段 B：开启预算闸门（决策仍关闭）
3. 阶段 C：开启决策闸门 + delay
4. 阶段 D：开启 P1 特性（活力/mention/reply_type）

## 5.2 灰度维度

- 按 identityId 灰度
- 按 groupId 白名单灰度
- 按时间窗口灰度（工作时段先开）

---

## 6. 回滚策略

## 6.1 软回滚（推荐）

通过配置快速关闭：

- `groupSocial.enabled=false`
- 或逐项关闭 `decision/limits/delay/vitality`

## 6.2 硬回滚

若功能异常严重：

1. 回退到前一版本构建。
2. 清理新增持久化状态文件（保留备份）。

## 6.3 回滚判定阈值

任一满足即回滚：

- 发送失败率激增（如 > 20%）
- 误伤率高（应答消息大面积被 skip）
- 资源消耗不降反升超过阈值

---

## 7. 运行手册（值班建议）

出现“群回复异常少”时排查顺序：

1. 看 `budget_block_total` 是否激增。
2. 看决策解析失败率。
3. 看 delay 任务积压。
4. 看 groupOps 可用性与连接状态。

出现“群仍很吵”时排查顺序：

1. 看 batching 是否启用。
2. 看 decision 是否实际生效。
3. 看 skip 比例是否过低。
4. 看预算阈值是否配置过宽。

---

## 8. 版本门禁建议

每一期发布前必须满足：

1. 单测通过。
2. 核心集成场景通过。
3. 灰度指标达到目标阈值。
4. 已验证配置回滚开关有效。

