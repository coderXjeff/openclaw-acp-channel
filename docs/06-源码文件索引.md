# ACP Channel 插件 - 源码文件索引

## 文件清单

本文档列出项目中所有源码文件及其核心职责，方便快速定位代码。

---

## 入口文件

### `index.ts`

| 项目 | 说明 |
|------|------|
| 职责 | 插件注册与初始化 |
| 关键导入 | `node-polyfill`（必须首先导入）、`channel`、`monitor` |
| 关键操作 | 注册 Channel 插件、解析账户、启动监听器 |

---

## 核心源码 (`src/`)

### `src/acp-client.ts`

| 项目 | 说明 |
|------|------|
| 职责 | ACP 网络通信封装 |
| 代码量 | ~366 行 |
| 导出 | `AcpClient` 类 |
| 核心方法 | `connect()`, `sendMessage()`, `sendReply()`, `uploadAgentMdFromFile()`, `disconnect()` |
| 依赖 | `acp-ts` 库 |
| 数据结构 | `Map<targetAid, AcpSession>` — 会话复用映射 |

### `src/channel.ts`

| 项目 | 说明 |
|------|------|
| 职责 | OpenClaw Channel 适配器定义 |
| 代码量 | ~226 行 |
| 导出 | `acpChannelPlugin` 对象 |
| 包含适配器 | `acpMeta`, `acpCapabilities`, `acpConfigAdapter`, `acpConfigSchemaAdapter`, `acpOutboundAdapter`, `acpMessagingAdapter`, `acpMessageActions` |

### `src/monitor.ts`

| 项目 | 说明 |
|------|------|
| 职责 | 入站消息监听与会话生命周期管理 |
| 代码量 | ~770 行（最大模块） |
| 导出 | `startAcpMonitor()`, `handleInboundMessage()`, `syncAgentMd()` 等 |
| 核心功能 | 消息监听、会话管理、4 层终止控制、agent.md 缓存、权限检查 |
| 数据结构 | `Map<sessionId, AcpSessionState>` — 会话状态映射 |

### `src/actions.ts`

| 项目 | 说明 |
|------|------|
| 职责 | 消息操作处理 |
| 代码量 | ~130 行 |
| 导出 | 操作处理函数 |
| 支持操作 | `send`（发送消息）、`sync-agent-md`（同步 agent.md） |

### `src/outbound.ts`

| 项目 | 说明 |
|------|------|
| 职责 | 出站消息发送封装 |
| 代码量 | ~26 行 |
| 导出 | `sendAcpMessage()` |

### `src/types.ts`

| 项目 | 说明 |
|------|------|
| 职责 | 全局 TypeScript 类型定义 |
| 代码量 | ~103 行 |
| 核心类型 | `AcpChannelConfig`, `AcpSessionConfig`, `ResolvedAcpAccount`, `AcpInboundMessage`, `AcpSessionState` |

### `src/config-schema.ts`

| 项目 | 说明 |
|------|------|
| 职责 | 配置 JSON Schema 定义 |
| 代码量 | ~110 行 |
| 导出 | 配置 Schema 对象 |
| 用途 | 配置验证、UI 表单生成 |

### `src/plugin-types.ts`

| 项目 | 说明 |
|------|------|
| 职责 | 插件框架类型定义 |
| 代码量 | ~105 行 |
| 核心类型 | OpenClaw 插件接口类型 |

### `src/runtime.ts`

| 项目 | 说明 |
|------|------|
| 职责 | 运行时状态管理 |
| 代码量 | ~19 行 |
| 导出 | 运行时状态存取函数 |

### `src/node-polyfill.ts`

| 项目 | 说明 |
|------|------|
| 职责 | Node.js 环境下的浏览器 API 兼容层 |
| 代码量 | ~90 行 |
| 核心功能 | 基于文件系统实现 `localStorage` |
| 存储路径 | `~/.acp-storage/localStorage.json` |

---

## 配置文件

| 文件 | 用途 |
|------|------|
| `package.json` | 项目元数据、依赖、OpenClaw 扩展入口声明 |
| `tsconfig.json` | TypeScript 编译配置（ES2022, NodeNext, strict） |
| `openclaw.plugin.json` | OpenClaw 插件声明（ID、Channel、Skill） |
| `.gitignore` | Git 忽略规则 |

---

## 文档与资源

| 文件 | 用途 |
|------|------|
| `README.md` | 项目主文档 |
| `docs/gap-analysis.md` | 功能差距分析 |
| `skill/acp/SKILL.md` | OpenClaw Skill 主文档 |
| `skill/acp/resources/install-full.md` | 完整安装指南 |
| `skill/acp/resources/install-quick.md` | 快速安装指南 |
| `skill/acp/resources/usage-guide.md` | 使用指南 |
| `prompts/install-acp.md` | 安装提示词模板 |

---

## 模块依赖关系

```
index.ts
  ├── src/node-polyfill.ts    (必须首先导入)
  ├── src/channel.ts
  │     ├── src/types.ts
  │     ├── src/config-schema.ts
  │     ├── src/plugin-types.ts
  │     ├── src/outbound.ts
  │     │     └── src/acp-client.ts
  │     └── src/actions.ts
  │           └── src/acp-client.ts
  └── src/monitor.ts
        ├── src/types.ts
        ├── src/runtime.ts
        └── src/acp-client.ts
              └── acp-ts (外部库)
```
