# agent.md 重构 — 实现方案（经代码验证版）

> 本文档基于对 OpenClaw 源码（`/home/ykj/openclaw`）和 ACP 插件源码的实际分析编写，
> 每项方案均标注了可行性评估和技术依据。

---

## 零、可行性总评

经过对 OpenClaw 插件 API、workspace 文件体系、acp-ts 库的逐一验证，
原设计文档中的方案**大部分可行，但有几处关键假设需要修正**：

| 设计项 | 可行性 | 说明 |
|--------|--------|------|
| 移除 GroupSystemPrompt 注入 | **可行** | 纯 ACP 插件内部改动 |
| 从 workspace 文件自动生成 agent.md | **可行但需绕路** | PluginRuntime 未暴露 workspace API，需自行读文件 |
| 调用 `loadWorkspaceBootstrapFiles()` | **不可行** | 该函数未通过 PluginRuntime 暴露给插件 |
| 调用 `buildWorkspaceSkillsPrompt()` | **不可行** | 同上，未暴露 |
| 调用 `parseIdentityMarkdown()` | **不可行** | 同上，未暴露 |
| 使用 `api.on()` 注册钩子 | **可行** | API 存在且支持 14 种钩子 |
| 使用 `api.registerTool()` | **可行** | API 存在 |
| 使用 `api.registerCommand()` | **可行** | API 存在 |
| 通过 HTTP GET 获取远程 agent.md | **可行** | acp-ts 不提供，但标准 HTTP 请求即可 |
| 联系人管理（本地 JSON） | **可行** | 纯本地功能，无外部依赖 |
| 信用评级体系 | **可行** | 纯本地计算，无外部依赖 |

---

## 一、关键事实（代码验证结果）

### 1.1 OpenClaw 插件 API 实际能力

**来源**：`/home/ykj/openclaw/src/plugins/types.ts`

`OpenClawPluginApi` 提供以下注册方法（均已验证存在）：

```
api.registerChannel()    ✅ 当前已使用
api.registerTool()       ✅ 可用，未使用
api.registerCommand()    ✅ 可用，未使用
api.registerHook()       ✅ 可用，未使用
api.on()                 ✅ 可用，未使用（registerHook 的类型安全版本）
api.registerHttpHandler()✅ 可用
api.registerHttpRoute()  ✅ 可用
api.registerService()    ✅ 可用
```

当前 ACP 插件的 `register()` 函数（`index.ts`）只用了 `api.registerChannel()`，
其余能力完全未利用。

### 1.2 可用的插件钩子（14 种）

**来源**：`/home/ykj/openclaw/src/plugins/types.ts:287-301`

```
before_agent_start   — 可注入 systemPrompt / prependContext
agent_end            — 可获取 messages, success, durationMs
session_start        — 会话开始
session_end          — 会话结束
gateway_start        — 网关启动，收到 { port }
gateway_stop         — 网关停止，收到 { reason }
message_received     — 收到消息
message_sending      — 发送前（可修改/取消）
message_sent         — 发送后
before_tool_call     — 工具调用前（可阻止）
after_tool_call      — 工具调用后
before_compaction    — 压缩前
after_compaction     — 压缩后
tool_result_persist  — 工具结果持久化前
```

**关键发现**：`before_agent_start` 钩子的上下文包含 `workspaceDir`：

```typescript
// PluginHookAgentContext
{
  agentId?: string;
  sessionKey?: string;
  workspaceDir?: string;    // ← 可以拿到 workspace 目录！
  messageProvider?: string;
}
```

这意味着虽然 PluginRuntime 没有暴露 workspace API，但通过 `before_agent_start`
钩子可以间接获取 workspace 目录路径，然后自行读取文件。

### 1.3 Workspace 文件实际存在情况

**来源**：文件系统扫描 `/home/ykj/.openclaw/workspace/`

| 文件 | 存在 | 内容 |
|------|------|------|
| IDENTITY.md | ✅ | 名字、emoji、风格 |
| SOUL.md | ✅ | 人格、边界、哲学 |
| AGENTS.md | ✅ | 工作流、群聊行为 |
| TOOLS.md | ✅ | 本地工具配置 |
| HEARTBEAT.md | ✅ | 定期检查任务（当前为空） |
| USER.md | ✅ | 主人信息（需脱敏） |
| MEMORY.md | ❌ | 不存在（有 memory/ 目录） |
| BOOTSTRAP.md | ❌ | 不存在（首次运行后删除） |

### 1.4 OpenClaw 内部函数的可访问性

**来源**：`/home/ykj/openclaw/src/plugins/runtime/types.ts`

| 函数 | 从源码导出 | PluginRuntime 暴露 | 插件可直接调用 |
|------|-----------|-------------------|--------------|
| `loadWorkspaceBootstrapFiles()` | ✅ | ❌ | ❌ |
| `resolveBootstrapContextForRun()` | ✅ | ❌ | ❌ |
| `parseIdentityMarkdown()` | ✅ | ❌ | ❌ |
| `loadSkillEntries()` | ❌ (私有) | ❌ | ❌ |
| `buildWorkspaceSkillsPrompt()` | ✅ | ❌ | ❌ |

**结论**：不能调用 OpenClaw 内部的解析函数，必须自己实现文件读取和解析。

### 1.5 acp-ts 库能力

**来源**：`/home/ykj/.openclaw/extensions/acp/node_modules/acp-ts/`

| 功能 | 支持 |
|------|------|
| WebSocket 消息通信 | ✅ |
| 上传 agent.md (`uploadAgentMd`) | ✅ |
| 上传 agent.md 文件 (`uploadAgentMdFromFile`) | ✅ |
| 同步自己的公共文件 (`syncPublicFiles`) | ✅ |
| HTTP GET 获取其他 agent 的 agent.md | ❌ |
| 从其他 agent 下载文件 | ❌ (downloadFile 是私有方法) |

获取远程 agent.md 需要自行发 HTTP 请求到 `https://{aid}/agent.md`。

---

## 二、修正后的分阶段实施计划

### Phase 1：agent.md 自动生成与发布

**可行性：✅ 完全可行**

#### 1.1 新增 `src/agent-md-builder.ts`

自行实现文件读取和解析（不依赖 OpenClaw 内部函数）：

```typescript
import fs from "fs";
import path from "path";
import crypto from "crypto";

interface AgentMdSources {
  identity?: string;
  soul?: string;
  agents?: string;
  tools?: string;
  heartbeat?: string;
  user?: string;       // 脱敏后
  skills?: string;     // 技能目录下的 SKILL.md 汇总
}

// 自行实现，不依赖 parseIdentityMarkdown()
function parseIdentity(content: string): {
  name?: string; emoji?: string; style?: string;
} {
  // 简单的 key: value 解析
}

// 自行实现 USER.md 脱敏
function sanitizeUserMd(raw: string): string {
  // 只保留语言、时区等公开信息
}

function buildAgentMd(sources: AgentMdSources): string;
function computeSourcesHash(sources: AgentMdSources): string;
```

#### 1.2 新增 `src/agent-md-sources.ts`

直接用 `fs.readFileSync` 读取 workspace 文件：

```typescript
function loadAgentMdSources(workspaceDir: string): AgentMdSources {
  const read = (name: string) => {
    const p = path.join(workspaceDir, name);
    return fs.existsSync(p) ? fs.readFileSync(p, "utf8") : undefined;
  };
  return {
    identity: read("IDENTITY.md"),
    soul: read("SOUL.md"),
    agents: read("AGENTS.md"),
    tools: read("TOOLS.md"),
    heartbeat: read("HEARTBEAT.md"),
    user: sanitizeUserMd(read("USER.md") ?? ""),
    skills: loadSkillSummaries(workspaceDir),
  };
}
```

**workspace 目录获取方式**：两种途径

1. **配置方式**：在 `AcpChannelConfig` 中新增 `workspaceDir` 字段，用户手动配置
2. **钩子方式**：通过 `api.on("before_agent_start", (event, ctx) => { ... })` 从 `ctx.workspaceDir` 获取

推荐方案：**两者结合**。配置优先，钩子作为自动发现的补充。

#### 1.3 修改 `src/types.ts`

```typescript
interface AcpChannelConfig {
  // ... 保留现有字段
  agentMdPath?: string;
  workspaceDir?: string;          // 新增：workspace 目录路径
}
```

不需要为每个来源文件单独配置路径——它们都在 workspace 目录下，路径是固定的。

#### 1.4 修改 `src/monitor.ts`

- 移除 `GroupSystemPrompt: agentMdContent` 注入
- 替换 `checkAndUploadAgentMd()` 为多来源哈希检测

#### 1.5 修改 `src/index.ts`

利用 `api.on()` 注册钩子，在 `before_agent_start` 时自动发现 workspaceDir：

```typescript
register(api: OpenClawPluginApi) {
  setAcpRuntime(api.runtime);
  api.registerChannel({ plugin: acpChannelPlugin as any });

  // 新增：通过钩子获取 workspaceDir
  api.on("before_agent_start", async (event, ctx) => {
    if (ctx.workspaceDir) {
      setWorkspaceDir(ctx.workspaceDir);
      await checkAndSyncAgentMdIfChanged(ctx.workspaceDir);
    }
  });

  // 新增：gateway 启动时全量同步
  api.on("gateway_start", async () => {
    await buildAndSyncAgentMd();
  });
}
```

#### 1.6 技能信息获取的限制

`loadSkillEntries()` 是私有函数，`buildWorkspaceSkillsPrompt()` 未暴露。

**替代方案**：自行扫描 skills 目录下的 SKILL.md 文件。
技能目录位于 `{workspaceDir}/skills/`，每个子目录包含一个 `SKILL.md`。
可以用 `fs.readdirSync` + `fs.readFileSync` 遍历读取。

但有一个问题：**插件技能的来源优先级**（extra < bundled < managed < workspace < plugin）
无法完整复现，因为 bundled/managed 目录路径不可知。

**务实做法**：只读取 workspace 下的技能，不追求完整的技能列表。
这已经覆盖了用户自定义的技能，足够作为名片展示。

---

### Phase 2：读取其他 Agent 的 agent.md

**可行性：✅ 可行，需自行实现 HTTP 请求**

#### 2.1 新增 `src/agent-md-fetcher.ts`

acp-ts 不提供远程 agent.md 获取功能，需要自行用 HTTP GET：

```typescript
// agent.md 的 URL 格式：https://{aid}/agent.md
// 例如：https://translator.aid.pub/agent.md

async function fetchRemoteAgentMd(aid: string): Promise<string | null> {
  const url = `https://${aid}/agent.md`;
  const resp = await fetch(url);  // Node 22+ 内置 fetch
  if (!resp.ok) return null;
  return resp.text();
}
```

**依赖**：Node.js 22+（项目已要求 >=22.12.0），内置 `fetch`，无需额外依赖。

#### 2.2 新增 `src/agent-md-parser.ts`

自行实现结构化 Markdown 解析。由于 agent.md 格式是我们自己定义的，
解析器可以针对性地处理 `## Basic Info`、`## Capabilities` 等固定段落。

#### 2.3 缓存策略

内存缓存 + 本地文件持久化（`~/.acp-storage/remote-agent-md/`），无外部依赖。

#### 2.4 待验证：URL 格式

需要确认 `https://{aid}/agent.md` 是否是 ACP 网络的实际端点。
当前 `uploadAgentMd()` 上传后的访问 URL 需要从 acp-ts 的服务端确认。

---

### Phase 3：联系人管理

**可行性：✅ 完全可行**

纯本地功能，无外部 API 依赖。

#### 3.1 新增 `src/contacts.ts`

ContactManager 类，本地 JSON 持久化。实现方案与原文档一致，无需修改。

#### 3.2 注册管理命令

利用 `api.registerCommand()` 注册联系人管理命令：

```typescript
api.registerCommand({
  name: "acp-contacts",
  description: "管理 ACP 联系人",
  acceptsArgs: true,
  handler: async (ctx) => { ... },
});
```

#### 3.3 注册 Agent 工具

利用 `api.registerTool()` 让 AI 可以主动管理联系人：

```typescript
api.registerTool(acpManageContactsTool);
```

---

### Phase 4：信用评级体系

**可行性：✅ 可行，但自动评估部分有限制**

#### 4.1 评分计算

纯本地计算，与原文档一致。

#### 4.2 自动评估的限制

设计文档中的"回答质量评估"和"能力一致性检查"需要 AI 参与判断。
在当前架构下，ACP 插件处于 Channel 层，**无法主动调用 AI 进行评估**。

**务实做法**：

- 自动记录交互次数、频率等客观指标
- 主人手动评分作为主要信用来源
- 通过 `session_end` 钩子记录会话统计（时长、轮次等）
- AI 自动评估留待后续版本（需要 OpenClaw 提供相关 API）

#### 4.3 集成到钩子

```typescript
api.on("session_end", async (event, ctx) => {
  // 更新联系人的交互统计
  // 但无法在此处调用 AI 评估质量
});
```

---

### Phase 5：插件钩子集成

**可行性：✅ 可行**

当前 `index.ts` 只用了 `api.registerChannel()`。
需要扩展为同时使用 `api.on()`、`api.registerTool()`、`api.registerCommand()`。

#### 5.1 完整的注册代码

```typescript
register(api: OpenClawPluginApi) {
  setAcpRuntime(api.runtime);
  api.registerChannel({ plugin: acpChannelPlugin as any });

  // 钩子
  api.on("gateway_start", handleGatewayStart);
  api.on("gateway_stop", handleGatewayStop);
  api.on("before_agent_start", handleBeforeAgentStart);
  api.on("session_end", handleSessionEnd);

  // 工具（让 AI 可以操作）
  api.registerTool(acpFetchAgentMdTool);
  api.registerTool(acpManageContactsTool);

  // 命令（让用户可以操作）
  api.registerCommand({
    name: "acp-sync",
    description: "手动同步 agent.md 到 ACP 网络",
    handler: handleSyncCommand,
  });
  api.registerCommand({
    name: "acp-contacts",
    description: "管理 ACP 联系人",
    acceptsArgs: true,
    handler: handleContactsCommand,
  });
}
```

---

## 三、文件变更清单（修正版）

### 新增文件

| 文件 | 职责 | Phase |
|------|------|-------|
| `src/agent-md-builder.ts` | agent.md 组装 + 自实现的 identity 解析 | 1 |
| `src/agent-md-sources.ts` | workspace 文件直接读取 | 1 |
| `src/agent-md-fetcher.ts` | HTTP GET 远程 agent.md + 缓存 | 2 |
| `src/agent-md-parser.ts` | 结构化 Markdown 解析 | 2 |
| `src/contacts.ts` | 联系人管理 + JSON 持久化 | 3 |
| `src/credit.ts` | 信用评分计算（客观指标 + 手动评分） | 4 |

### 修改文件

| 文件 | 变更 | Phase |
|------|------|-------|
| `src/index.ts` | 新增 `api.on()` 钩子、`api.registerTool()`、`api.registerCommand()` | 1, 3, 5 |
| `src/types.ts` | 新增 `workspaceDir` 配置、联系人类型 | 1, 3 |
| `src/config-schema.ts` | 新增 `workspaceDir` Schema | 1 |
| `src/monitor.ts` | 移除 GroupSystemPrompt 注入，接入新生成逻辑 | 1 |
| `src/actions.ts` | 新增联系人管理 action | 3 |
| `src/channel.ts` | 新增 action 声明 | 3 |

---

## 四、原设计文档中的"空谈"部分

以下是原设计文档中**写得好看但实际无法直接实现**的部分：

### 4.1 直接调用 OpenClaw 内部函数

原文档写的：
```typescript
const identity = loadIdentityMd(workspaceDir);
const skillSnapshot = buildWorkspaceSkillsPrompt(workspaceDir, { config });
```

**现实**：这些函数虽然从源码导出，但 PluginRuntime 没有暴露给插件。
插件无法 `import { loadWorkspaceBootstrapFiles } from "openclaw/..."` 来调用。

**解决方案**：自行用 `fs.readFileSync` 读取文件，自行实现简化版解析。

### 4.2 完整的技能列表

原文档假设可以获取所有来源（extra/bundled/managed/workspace/plugin）的技能。

**现实**：插件只能读取 workspace 下的 skills 目录，无法获取 bundled 和 managed 技能。

**解决方案**：只展示 workspace 技能，这已经是用户最关心的自定义技能。

### 4.3 AI 自动评估信用

原文档设计了"回答质量评估"和"能力一致性检查"。

**现实**：Channel 层插件无法主动调用 AI 进行评估。
`session_end` 钩子只能拿到统计数据，不能让 AI 打分。

**解决方案**：Phase 4 先实现客观指标 + 手动评分，AI 评估留待后续。

### 4.4 `resolveBootstrapContextForRun()` 后的统一检测

原文档建议在此函数执行后收集所有来源做哈希。

**现实**：插件无法 hook 到这个函数的执行。

**解决方案**：在 `before_agent_start` 钩子中自行读取文件并计算哈希。
`before_agent_start` 的 `ctx.workspaceDir` 提供了 workspace 路径，
时机上也接近 `resolveBootstrapContextForRun()` 的执行点。

---

## 五、风险与注意事项（修正版）

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 移除 GroupSystemPrompt 后行为失控 | Agent 回复质量下降 | 提供配置开关 `injectAsSystemPrompt: true/false`，默认 false |
| workspace 目录路径不确定 | 无法读取来源文件 | 配置 + `before_agent_start` 钩子双重获取 |
| 自实现的 identity 解析与 OpenClaw 不一致 | 名片信息偏差 | 保持解析逻辑简单，只提取 name/emoji/style |
| 远程 agent.md URL 格式未确认 | 获取失败 | 需要与 ACP 服务端确认端点格式 |
| `before_agent_start` 钩子中 workspaceDir 可能为空 | 无法自动发现 | 回退到配置的 workspaceDir |
| 技能列表不完整（只有 workspace 技能） | 名片能力展示不全 | 文档说明限制，后续争取 PluginRuntime 暴露技能 API |
