# agent.md é‡æ„ â€” å®ç°æ–¹æ¡ˆï¼ˆç»ä»£ç éªŒè¯ç‰ˆï¼‰

> æœ¬æ–‡æ¡£åŸºäºå¯¹ OpenClaw æºç ï¼ˆ`/home/ykj/openclaw`ï¼‰å’Œ ACP æ’ä»¶æºç çš„å®é™…åˆ†æç¼–å†™ï¼Œ
> æ¯é¡¹æ–¹æ¡ˆå‡æ ‡æ³¨äº†å¯è¡Œæ€§è¯„ä¼°å’ŒæŠ€æœ¯ä¾æ®ã€‚

---

## é›¶ã€å¯è¡Œæ€§æ€»è¯„

ç»è¿‡å¯¹ OpenClaw æ’ä»¶ APIã€workspace æ–‡ä»¶ä½“ç³»ã€acp-ts åº“çš„é€ä¸€éªŒè¯ï¼Œ
åŸè®¾è®¡æ–‡æ¡£ä¸­çš„æ–¹æ¡ˆ**å¤§éƒ¨åˆ†å¯è¡Œï¼Œä½†æœ‰å‡ å¤„å…³é”®å‡è®¾éœ€è¦ä¿®æ­£**ï¼š

| è®¾è®¡é¡¹ | å¯è¡Œæ€§ | è¯´æ˜ |
|--------|--------|------|
| ç§»é™¤ GroupSystemPrompt æ³¨å…¥ | **å¯è¡Œ** | çº¯ ACP æ’ä»¶å†…éƒ¨æ”¹åŠ¨ |
| ä» workspace æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆ agent.md | **å¯è¡Œä½†éœ€ç»•è·¯** | PluginRuntime æœªæš´éœ² workspace APIï¼Œéœ€è‡ªè¡Œè¯»æ–‡ä»¶ |
| è°ƒç”¨ `loadWorkspaceBootstrapFiles()` | **ä¸å¯è¡Œ** | è¯¥å‡½æ•°æœªé€šè¿‡ PluginRuntime æš´éœ²ç»™æ’ä»¶ |
| è°ƒç”¨ `buildWorkspaceSkillsPrompt()` | **ä¸å¯è¡Œ** | åŒä¸Šï¼Œæœªæš´éœ² |
| è°ƒç”¨ `parseIdentityMarkdown()` | **ä¸å¯è¡Œ** | åŒä¸Šï¼Œæœªæš´éœ² |
| ä½¿ç”¨ `api.on()` æ³¨å†Œé’©å­ | **å¯è¡Œ** | API å­˜åœ¨ä¸”æ”¯æŒ 14 ç§é’©å­ |
| ä½¿ç”¨ `api.registerTool()` | **å¯è¡Œ** | API å­˜åœ¨ |
| ä½¿ç”¨ `api.registerCommand()` | **å¯è¡Œ** | API å­˜åœ¨ |
| é€šè¿‡ HTTP GET è·å–è¿œç¨‹ agent.md | **å¯è¡Œ** | acp-ts ä¸æä¾›ï¼Œä½†æ ‡å‡† HTTP è¯·æ±‚å³å¯ |
| è”ç³»äººç®¡ç†ï¼ˆæœ¬åœ° JSONï¼‰ | **å¯è¡Œ** | çº¯æœ¬åœ°åŠŸèƒ½ï¼Œæ— å¤–éƒ¨ä¾èµ– |
| ä¿¡ç”¨è¯„çº§ä½“ç³» | **å¯è¡Œ** | çº¯æœ¬åœ°è®¡ç®—ï¼Œæ— å¤–éƒ¨ä¾èµ– |

---

## ä¸€ã€å…³é”®äº‹å®ï¼ˆä»£ç éªŒè¯ç»“æœï¼‰

### 1.1 OpenClaw æ’ä»¶ API å®é™…èƒ½åŠ›

**æ¥æº**ï¼š`/home/ykj/openclaw/src/plugins/types.ts`

`OpenClawPluginApi` æä¾›ä»¥ä¸‹æ³¨å†Œæ–¹æ³•ï¼ˆå‡å·²éªŒè¯å­˜åœ¨ï¼‰ï¼š

```
api.registerChannel()    âœ… å½“å‰å·²ä½¿ç”¨
api.registerTool()       âœ… å¯ç”¨ï¼Œæœªä½¿ç”¨
api.registerCommand()    âœ… å¯ç”¨ï¼Œæœªä½¿ç”¨
api.registerHook()       âœ… å¯ç”¨ï¼Œæœªä½¿ç”¨
api.on()                 âœ… å¯ç”¨ï¼Œæœªä½¿ç”¨ï¼ˆregisterHook çš„ç±»å‹å®‰å…¨ç‰ˆæœ¬ï¼‰
api.registerHttpHandler()âœ… å¯ç”¨
api.registerHttpRoute()  âœ… å¯ç”¨
api.registerService()    âœ… å¯ç”¨
```

å½“å‰ ACP æ’ä»¶çš„ `register()` å‡½æ•°ï¼ˆ`index.ts`ï¼‰åªç”¨äº† `api.registerChannel()`ï¼Œ
å…¶ä½™èƒ½åŠ›å®Œå…¨æœªåˆ©ç”¨ã€‚

### 1.2 å¯ç”¨çš„æ’ä»¶é’©å­ï¼ˆ14 ç§ï¼‰

**æ¥æº**ï¼š`/home/ykj/openclaw/src/plugins/types.ts:287-301`

```
before_agent_start   â€” å¯æ³¨å…¥ systemPrompt / prependContext
agent_end            â€” å¯è·å– messages, success, durationMs
session_start        â€” ä¼šè¯å¼€å§‹
session_end          â€” ä¼šè¯ç»“æŸ
gateway_start        â€” ç½‘å…³å¯åŠ¨ï¼Œæ”¶åˆ° { port }
gateway_stop         â€” ç½‘å…³åœæ­¢ï¼Œæ”¶åˆ° { reason }
message_received     â€” æ”¶åˆ°æ¶ˆæ¯
message_sending      â€” å‘é€å‰ï¼ˆå¯ä¿®æ”¹/å–æ¶ˆï¼‰
message_sent         â€” å‘é€å
before_tool_call     â€” å·¥å…·è°ƒç”¨å‰ï¼ˆå¯é˜»æ­¢ï¼‰
after_tool_call      â€” å·¥å…·è°ƒç”¨å
before_compaction    â€” å‹ç¼©å‰
after_compaction     â€” å‹ç¼©å
tool_result_persist  â€” å·¥å…·ç»“æœæŒä¹…åŒ–å‰
```

**å…³é”®å‘ç°**ï¼š`before_agent_start` é’©å­çš„ä¸Šä¸‹æ–‡åŒ…å« `workspaceDir`ï¼š

```typescript
// PluginHookAgentContext
{
  agentId?: string;
  sessionKey?: string;
  workspaceDir?: string;    // â† å¯ä»¥æ‹¿åˆ° workspace ç›®å½•ï¼
  messageProvider?: string;
}
```

è¿™æ„å‘³ç€è™½ç„¶ PluginRuntime æ²¡æœ‰æš´éœ² workspace APIï¼Œä½†é€šè¿‡ `before_agent_start`
é’©å­å¯ä»¥é—´æ¥è·å– workspace ç›®å½•è·¯å¾„ï¼Œç„¶åè‡ªè¡Œè¯»å–æ–‡ä»¶ã€‚

### 1.3 Workspace æ–‡ä»¶å®é™…å­˜åœ¨æƒ…å†µ

**æ¥æº**ï¼šæ–‡ä»¶ç³»ç»Ÿæ‰«æ `/home/ykj/.openclaw/workspace/`

| æ–‡ä»¶ | å­˜åœ¨ | å†…å®¹ |
|------|------|------|
| IDENTITY.md | âœ… | åå­—ã€emojiã€é£æ ¼ |
| SOUL.md | âœ… | äººæ ¼ã€è¾¹ç•Œã€å“²å­¦ |
| AGENTS.md | âœ… | å·¥ä½œæµã€ç¾¤èŠè¡Œä¸º |
| TOOLS.md | âœ… | æœ¬åœ°å·¥å…·é…ç½® |
| HEARTBEAT.md | âœ… | å®šæœŸæ£€æŸ¥ä»»åŠ¡ï¼ˆå½“å‰ä¸ºç©ºï¼‰ |
| USER.md | âœ… | ä¸»äººä¿¡æ¯ï¼ˆéœ€è„±æ•ï¼‰ |
| MEMORY.md | âŒ | ä¸å­˜åœ¨ï¼ˆæœ‰ memory/ ç›®å½•ï¼‰ |
| BOOTSTRAP.md | âŒ | ä¸å­˜åœ¨ï¼ˆé¦–æ¬¡è¿è¡Œååˆ é™¤ï¼‰ |

### 1.4 OpenClaw å†…éƒ¨å‡½æ•°çš„å¯è®¿é—®æ€§

**æ¥æº**ï¼š`/home/ykj/openclaw/src/plugins/runtime/types.ts`

| å‡½æ•° | ä»æºç å¯¼å‡º | PluginRuntime æš´éœ² | æ’ä»¶å¯ç›´æ¥è°ƒç”¨ |
|------|-----------|-------------------|--------------|
| `loadWorkspaceBootstrapFiles()` | âœ… | âŒ | âŒ |
| `resolveBootstrapContextForRun()` | âœ… | âŒ | âŒ |
| `parseIdentityMarkdown()` | âœ… | âŒ | âŒ |
| `loadSkillEntries()` | âŒ (ç§æœ‰) | âŒ | âŒ |
| `buildWorkspaceSkillsPrompt()` | âœ… | âŒ | âŒ |

**ç»“è®º**ï¼šä¸èƒ½è°ƒç”¨ OpenClaw å†…éƒ¨çš„è§£æå‡½æ•°ï¼Œå¿…é¡»è‡ªå·±å®ç°æ–‡ä»¶è¯»å–å’Œè§£æã€‚

### 1.5 acp-ts åº“èƒ½åŠ›

**æ¥æº**ï¼š`/home/ykj/.openclaw/extensions/acp/node_modules/acp-ts/`

| åŠŸèƒ½ | æ”¯æŒ |
|------|------|
| WebSocket æ¶ˆæ¯é€šä¿¡ | âœ… |
| ä¸Šä¼  agent.md (`uploadAgentMd`) | âœ… |
| ä¸Šä¼  agent.md æ–‡ä»¶ (`uploadAgentMdFromFile`) | âœ… |
| åŒæ­¥è‡ªå·±çš„å…¬å…±æ–‡ä»¶ (`syncPublicFiles`) | âœ… |
| HTTP GET è·å–å…¶ä»– agent çš„ agent.md | âŒ |
| ä»å…¶ä»– agent ä¸‹è½½æ–‡ä»¶ | âŒ (downloadFile æ˜¯ç§æœ‰æ–¹æ³•) |

è·å–è¿œç¨‹ agent.md éœ€è¦è‡ªè¡Œå‘ HTTP è¯·æ±‚åˆ° `https://{aid}/agent.md`ã€‚

---

## äºŒã€ä¿®æ­£åçš„åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### Phase 1ï¼šagent.md è‡ªåŠ¨ç”Ÿæˆä¸å‘å¸ƒ

**å¯è¡Œæ€§ï¼šâœ… å®Œå…¨å¯è¡Œ**

#### 1.1 æ–°å¢ `src/agent-md-builder.ts`

è‡ªè¡Œå®ç°æ–‡ä»¶è¯»å–å’Œè§£æï¼ˆä¸ä¾èµ– OpenClaw å†…éƒ¨å‡½æ•°ï¼‰ï¼š

```typescript
import crypto from "crypto";

interface AgentMdSources {
  identity?: string;   // IDENTITY.md åŸå§‹å†…å®¹
  soul?: string;       // SOUL.md åŸå§‹å†…å®¹
  agents?: string;     // AGENTS.md åŸå§‹å†…å®¹
  tools?: string;      // TOOLS.md åŸå§‹å†…å®¹
  heartbeat?: string;  // HEARTBEAT.md åŸå§‹å†…å®¹
  user?: string;       // USER.md åŸå§‹å†…å®¹ï¼ˆæœªè„±æ•ï¼ŒsanitizeUserMd åœ¨ builder å†…éƒ¨è°ƒç”¨ï¼‰
  skills?: string;     // workspace/skills ç›®å½•ä¸‹ SKILL.md æ±‡æ€»
}

// ä» IDENTITY.md è§£æå‡ºçš„ç»“æ„åŒ–ä¿¡æ¯
interface ParsedIdentity {
  name?: string;
  emoji?: string;
  creature?: string;   // å¯¹åº” agent.md çš„ Type å­—æ®µ
  vibe?: string;       // å¯¹åº” agent.md çš„ Style å­—æ®µ
}

// USER.md è„±æ•åçš„å…¬å¼€ä¿¡æ¯ï¼ˆå‚è€ƒè®¾è®¡æ–‡æ¡£ 14.2 èŠ‚ï¼‰
interface SanitizedUserInfo {
  timezone?: string;
  language?: string;
}

// è‡ªè¡Œå®ç°ï¼Œä¸ä¾èµ– parseIdentityMarkdown()
// è§£æ **Key:** Value æ ¼å¼
function parseIdentity(content: string): ParsedIdentity;

// è‡ªè¡Œå®ç° USER.md è„±æ•ï¼ˆå‚è€ƒè®¾è®¡æ–‡æ¡£ 14.1 èŠ‚ï¼‰
// åªæå– timezone å’Œ languageï¼Œä¸¢å¼ƒ name/pronouns/context notes ç­‰éšç§ä¿¡æ¯
function sanitizeUserMd(raw: string): SanitizedUserInfo;

// ç»„è£… agent.md åç‰‡ï¼ˆå‚è€ƒè®¾è®¡æ–‡æ¡£ 5.2 èŠ‚å®Œæ•´æ ¼å¼ï¼‰
function buildAgentMd(sources: AgentMdSources, aid: string): string;

// å¯¹æ‰€æœ‰æ¥æºå†…å®¹è®¡ç®—æ•´ä½“å“ˆå¸Œ
function computeSourcesHash(sources: AgentMdSources): string;
```

**agent.md è¾“å‡ºæ ¼å¼**ï¼ˆä¸è®¾è®¡æ–‡æ¡£ 5.2 èŠ‚å¯¹é½ï¼‰ï¼š

```markdown
# Agent Identity Card

## Basic Info
- **Name**: Luna
- **AID**: luna.aid.pub
- **Emoji**: ğŸŒ™
- **Type**: AI Assistant
- **Style**: æ¸©æš–ã€ç®€æ´ã€æœ‰è§‚ç‚¹

## About Me
(ä» SOUL.md æå–æ ¸å¿ƒæ®µè½ï¼Œæˆªå–å‰ 500 å­—ç¬¦)

## Capabilities
### Skills
(ä» workspace/skills/ ç›®å½•æ‰«æ SKILL.md æå–æŠ€èƒ½åç§°å’Œæè¿°)

### Tools
(ä» TOOLS.md æå–å·¥å…·æ¸…å•)

## Collaboration Style
(ä» AGENTS.md æå–ç¾¤èŠè¡Œä¸ºã€å“åº”è§„åˆ™)

## Availability
(ä» HEARTBEAT.md æå–ï¼Œä¸ºç©ºåˆ™æ ‡è®°"å®æ—¶å“åº”")

## Preferences
- **Language**: ä¸­æ–‡
- **Timezone**: Asia/Shanghai
```

**ä¸åº”åŒ…å«çš„å†…å®¹**ï¼ˆå‚è€ƒè®¾è®¡æ–‡æ¡£ 5.4 èŠ‚ï¼‰ï¼š

| æ–‡ä»¶ | åŸå›  |
|------|------|
| MEMORY.md | ç§æœ‰è®°å¿†ï¼Œä¸å¯¹å¤–æš´éœ² |
| BOOTSTRAP.md | ä»…é¦–æ¬¡è¿è¡Œä½¿ç”¨ï¼Œå®Œæˆååˆ é™¤ |
| USER.md ä¸­çš„éšç§ä¿¡æ¯ | ä¸»äººçš„åå­—ã€ä»£è¯ã€ä¸ªäººåå¥½ç­‰ä¸åº”å¯¹å¤–æš´éœ² |

#### 1.2 æ–°å¢ `src/agent-md-sources.ts`

ç›´æ¥ç”¨ `fs.readFileSync` è¯»å– workspace æ–‡ä»¶ï¼š

```typescript
function loadAgentMdSources(workspaceDir: string): AgentMdSources {
  const read = (name: string) => {
    const p = path.join(workspaceDir, name);
    return fs.existsSync(p) ? fs.readFileSync(p, "utf8") : undefined;
  };
  return {
    identity: read("IDENTITY.md"),
    soul: read("SOUL.md"),
    agents: read("AGENTS.md"),
    tools: read("TOOLS.md"),
    heartbeat: read("HEARTBEAT.md"),
    user: read("USER.md"),           // åŸå§‹å†…å®¹ï¼Œè„±æ•åœ¨ buildAgentMd å†…éƒ¨å¤„ç†
    skills: loadSkillSummaries(workspaceDir),
  };
}

// æ‰«æ workspace/skills/ ç›®å½•ï¼Œè¯»å–æ¯ä¸ªå­ç›®å½•çš„ SKILL.md
function loadSkillSummaries(workspaceDir: string): string | undefined {
  const skillsDir = path.join(workspaceDir, "skills");
  if (!fs.existsSync(skillsDir)) return undefined;
  // éå†å­ç›®å½•ï¼Œè¯»å– SKILL.mdï¼Œæå–åç§°å’Œæè¿°
}
```

**workspace ç›®å½•è·å–æ–¹å¼**ï¼šä¸¤ç§é€”å¾„

1. **é…ç½®æ–¹å¼**ï¼šåœ¨ `AcpChannelConfig` ä¸­æ–°å¢ `workspaceDir` å­—æ®µï¼Œç”¨æˆ·æ‰‹åŠ¨é…ç½®
2. **é’©å­æ–¹å¼**ï¼šé€šè¿‡ `api.on("before_agent_start", (event, ctx) => { ... })` ä» `ctx.workspaceDir` è·å–

æ¨èæ–¹æ¡ˆï¼š**ä¸¤è€…ç»“åˆ**ã€‚é…ç½®ä¼˜å…ˆï¼Œé’©å­ä½œä¸ºè‡ªåŠ¨å‘ç°çš„è¡¥å……ã€‚

#### 1.2b æ–°å¢ `src/workspace.ts`

ç®¡ç† workspaceDir çš„å…¨å±€çŠ¶æ€ï¼š

```typescript
let workspaceDir: string | null = null;

function updateWorkspaceDir(dir: string): void;
function getWorkspaceDir(): string | null;
```

#### 1.3 ä¿®æ”¹ `src/types.ts`

```typescript
interface AcpChannelConfig {
  // ... ä¿ç•™ç°æœ‰å­—æ®µ
  agentMdPath?: string;
  workspaceDir?: string;          // æ–°å¢ï¼šworkspace ç›®å½•è·¯å¾„
}
```

ä¸éœ€è¦ä¸ºæ¯ä¸ªæ¥æºæ–‡ä»¶å•ç‹¬é…ç½®è·¯å¾„â€”â€”å®ƒä»¬éƒ½åœ¨ workspace ç›®å½•ä¸‹ï¼Œè·¯å¾„æ˜¯å›ºå®šçš„ã€‚

#### 1.4 ä¿®æ”¹ `src/monitor.ts`

- ç§»é™¤ `GroupSystemPrompt: agentMdContent` æ³¨å…¥
- æ›¿æ¢ `checkAndUploadAgentMd()` ä¸ºå¤šæ¥æºå“ˆå¸Œæ£€æµ‹

#### 1.5 ä¿®æ”¹ `index.ts`

åˆ©ç”¨ `api.on()` æ³¨å†Œé’©å­ï¼ˆå‚è€ƒè®¾è®¡æ–‡æ¡£ 9.1 èŠ‚ï¼‰ï¼š

```typescript
register(api: OpenClawPluginApi) {
  setAcpRuntime(api.runtime);
  api.registerChannel({ plugin: acpChannelPlugin as any });

  // æ–°å¢ï¼šé€šè¿‡é’©å­è·å– workspaceDir å¹¶è½»é‡æ ¡éªŒ
  api.on("before_agent_start", async (event, ctx) => {
    if (ctx.workspaceDir) {
      updateWorkspaceDir(ctx.workspaceDir);
      await checkAndSyncAgentMdIfChanged();
    }
  });
}
```

**æ³¨æ„**ï¼š`gateway_start` é’©å­åœ¨ Phase 1 æš‚ä¸æ³¨å†Œã€‚gateway å¯åŠ¨æ—¶
`checkAndUploadAgentMd()` å·²åœ¨ `connectOnce()` ä¸­è¢«è°ƒç”¨ï¼Œ
`before_agent_start` é’©å­çš„ä¸»è¦ä½œç”¨æ˜¯è‡ªåŠ¨å‘ç° workspaceDir å¹¶è§¦å‘å¢é‡åŒæ­¥ã€‚

#### 1.6 æŠ€èƒ½ä¿¡æ¯è·å–çš„é™åˆ¶

`loadSkillEntries()` æ˜¯ç§æœ‰å‡½æ•°ï¼Œ`buildWorkspaceSkillsPrompt()` æœªæš´éœ²ã€‚

**æ›¿ä»£æ–¹æ¡ˆ**ï¼šè‡ªè¡Œæ‰«æ skills ç›®å½•ä¸‹çš„ SKILL.md æ–‡ä»¶ã€‚
æŠ€èƒ½ç›®å½•ä½äº `{workspaceDir}/skills/`ï¼Œæ¯ä¸ªå­ç›®å½•åŒ…å«ä¸€ä¸ª `SKILL.md`ã€‚
å¯ä»¥ç”¨ `fs.readdirSync` + `fs.readFileSync` éå†è¯»å–ã€‚

ä½†æœ‰ä¸€ä¸ªé—®é¢˜ï¼š**æ’ä»¶æŠ€èƒ½çš„æ¥æºä¼˜å…ˆçº§**ï¼ˆextra < bundled < managed < workspace < pluginï¼‰
æ— æ³•å®Œæ•´å¤ç°ï¼Œå› ä¸º bundled/managed ç›®å½•è·¯å¾„ä¸å¯çŸ¥ã€‚

**åŠ¡å®åšæ³•**ï¼šåªè¯»å– workspace ä¸‹çš„æŠ€èƒ½ï¼Œä¸è¿½æ±‚å®Œæ•´çš„æŠ€èƒ½åˆ—è¡¨ã€‚
è¿™å·²ç»è¦†ç›–äº†ç”¨æˆ·è‡ªå®šä¹‰çš„æŠ€èƒ½ï¼Œè¶³å¤Ÿä½œä¸ºåç‰‡å±•ç¤ºã€‚
å¦‚æœ workspace/skills ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™ Skills æ®µè½ç•™ç©ºæˆ–çœç•¥ã€‚

#### 1.7 åŒæ­¥æ—¶æœºè¯´æ˜ï¼ˆå‚è€ƒè®¾è®¡æ–‡æ¡£ 6.2 èŠ‚ï¼‰

è®¾è®¡æ–‡æ¡£åˆ—å‡ºäº† 10 ç§åŒæ­¥æ—¶æœºã€‚Phase 1 è¦†ç›–ä»¥ä¸‹æ—¶æœºï¼š

| æ—¶æœº | Phase 1 å®ç°æ–¹å¼ | è¯´æ˜ |
|------|-----------------|------|
| å†·å¯åŠ¨å…¨é‡åŒæ­¥ | `connectOnce()` ä¸­è°ƒç”¨ `checkAndUploadAgentMd()` | å·²æœ‰é€»è¾‘ï¼Œæ”¹ä¸ºå¤šæ¥æºç”Ÿæˆ |
| æ–‡ä»¶å˜æ›´æ£€æµ‹ | `before_agent_start` é’©å­ä¸­è®¡ç®—æ•´ä½“å“ˆå¸Œ | æ¯æ¬¡ Agent å¯åŠ¨æ—¶æ£€æµ‹ |
| æ‰‹åŠ¨è§¦å‘ | `sync-agent-md` action | å·²æœ‰é€»è¾‘ï¼Œæ”¹ä¸ºå¼ºåˆ¶é‡æ–°ç”Ÿæˆ |

å…¶ä½™æ—¶æœºï¼ˆIDENTITY/SOUL/AGENTS/TOOLS/HEARTBEAT/USER/Skill å•ç‹¬å˜æ›´æ£€æµ‹ï¼‰
é€šè¿‡æ•´ä½“å“ˆå¸Œæœºåˆ¶ç»Ÿä¸€è¦†ç›–â€”â€”ä»»ä½•æ¥æºæ–‡ä»¶å˜åŒ–éƒ½ä¼šå¯¼è‡´å“ˆå¸Œä¸åŒ¹é…ï¼Œè§¦å‘é‡æ–°ç”Ÿæˆã€‚

---

### Phase 2ï¼šè¯»å–å…¶ä»– Agent çš„ agent.md

**å¯è¡Œæ€§ï¼šâœ… å¯è¡Œï¼Œéœ€è‡ªè¡Œå®ç° HTTP è¯·æ±‚**

#### 2.1 æ–°å¢ `src/agent-md-fetcher.ts`

acp-ts ä¸æä¾›è¿œç¨‹ agent.md è·å–åŠŸèƒ½ï¼Œéœ€è¦è‡ªè¡Œç”¨ HTTP GETï¼š

```typescript
// agent.md çš„ URL æ ¼å¼ï¼šhttps://{aid}/agent.md
// ä¾‹å¦‚ï¼šhttps://translator.aid.pub/agent.md

async function fetchRemoteAgentMd(aid: string): Promise<string | null> {
  const url = `https://${aid}/agent.md`;
  const resp = await fetch(url);  // Node 22+ å†…ç½® fetch
  if (!resp.ok) return null;
  return resp.text();
}
```

**ä¾èµ–**ï¼šNode.js 22+ï¼ˆé¡¹ç›®å·²è¦æ±‚ >=22.12.0ï¼‰ï¼Œå†…ç½® `fetch`ï¼Œæ— éœ€é¢å¤–ä¾èµ–ã€‚

#### 2.2 æ–°å¢ `src/agent-md-parser.ts`

è‡ªè¡Œå®ç°ç»“æ„åŒ– Markdown è§£æã€‚ç”±äº agent.md æ ¼å¼æ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ï¼Œ
è§£æå™¨å¯ä»¥é’ˆå¯¹æ€§åœ°å¤„ç† `## Basic Info`ã€`## Capabilities` ç­‰å›ºå®šæ®µè½ã€‚

#### 2.3 ç¼“å­˜ç­–ç•¥

å†…å­˜ç¼“å­˜ + æœ¬åœ°æ–‡ä»¶æŒä¹…åŒ–ï¼ˆ`~/.acp-storage/remote-agent-md/`ï¼‰ï¼Œæ— å¤–éƒ¨ä¾èµ–ã€‚

#### 2.4 å¾…éªŒè¯ï¼šURL æ ¼å¼

éœ€è¦ç¡®è®¤ `https://{aid}/agent.md` æ˜¯å¦æ˜¯ ACP ç½‘ç»œçš„å®é™…ç«¯ç‚¹ã€‚
å½“å‰ `uploadAgentMd()` ä¸Šä¼ åçš„è®¿é—® URL éœ€è¦ä» acp-ts çš„æœåŠ¡ç«¯ç¡®è®¤ã€‚

---

### Phase 3ï¼šè”ç³»äººç®¡ç†

**å¯è¡Œæ€§ï¼šâœ… å®Œå…¨å¯è¡Œ** â€” **å·²å®Œæˆ**

çº¯æœ¬åœ°åŠŸèƒ½ï¼Œæ— å¤–éƒ¨ API ä¾èµ–ã€‚

#### 3.1 æ–°å¢ `src/contacts.ts`

ContactManager ç±»ï¼Œæœ¬åœ° JSON æŒä¹…åŒ–ï¼ˆ`~/.acp-storage/contacts.json`ï¼‰ã€‚
åŸå­å†™å…¥ï¼ˆå…ˆå†™ `.tmp` å† `rename`ï¼‰ï¼Œå•ä¾‹æ¨¡å¼ï¼ˆ`getContactManager()`ï¼‰ã€‚

æ”¯æŒï¼šCRUDã€è‡ªå®šä¹‰åˆ†ç»„ï¼ˆaddToGroup/removeFromGroup/listGroupsï¼‰ã€äº¤äº’è®°å½•ï¼ˆrecordInteractionï¼‰ã€‚

#### ~~3.2 æ³¨å†Œç®¡ç†å‘½ä»¤~~ â†’ 3.2 æ–°å¢ `manage-contacts` action

**ä¿®æ­£è¯´æ˜**ï¼šå½“å‰æ’ä»¶**ä¸ä½¿ç”¨** `api.registerCommand()` / `api.registerTool()`ï¼Œ
è€Œæ˜¯é€šè¿‡ channel actions æ¨¡å¼ï¼ˆ`acpMessageActions` in `src/actions.ts`ï¼‰æš´éœ²åŠŸèƒ½ã€‚
å› æ­¤æ”¹ä¸ºåœ¨ `handleAction` ä¸­å¤„ç† `"manage-contacts"` actionã€‚

æ”¯æŒçš„å­æ“ä½œï¼š`list` | `get` | `add` | `remove` | `update` | `addToGroup` | `removeFromGroup` | `listGroups`

#### ~~3.3 æ³¨å†Œ Agent å·¥å…·~~ â†’ å·²åˆå¹¶åˆ° 3.2

é€šè¿‡ action ç»Ÿä¸€æš´éœ²ï¼Œä¸å•ç‹¬æ³¨å†Œå·¥å…·ã€‚

#### 3.4 é¦–æ¬¡äº¤äº’è‡ªåŠ¨æ·»åŠ è”ç³»äºº

åœ¨ `src/monitor.ts` çš„ `handleInboundMessage()` ä¸­ï¼Œ
`fetcher.fetch(sender)` ä¹‹åè‡ªåŠ¨æ·»åŠ è”ç³»äººå¹¶è®°å½•äº¤äº’ã€‚
name é»˜è®¤å– AID å‰ç¼€ï¼ˆ`sender.split(".")[0]`ï¼‰ã€‚

---

### Phase 4ï¼šä¿¡ç”¨è¯„çº§ä½“ç³»

**å¯è¡Œæ€§ï¼šâœ… å¯è¡Œï¼Œä½†è‡ªåŠ¨è¯„ä¼°éƒ¨åˆ†æœ‰é™åˆ¶** â€” **å·²å®Œæˆ**

#### 4.1 æ–°å¢ `src/credit.ts`

ä¸‰ä¸ªçº¯å‡½æ•°ï¼Œæ— å¤–éƒ¨ä¾èµ–ï¼š

```typescript
type CreditLevel = "trusted" | "neutral" | "untrusted";

// æ ¹æ®åˆ†æ•°è®¡ç®—ç­‰çº§ï¼ˆ>= 70 trusted, >= 40 neutral, < 40 untrustedï¼‰
function getCreditLevel(score: number): CreditLevel;

// æ ¹æ®è”ç³»äººæ•°æ®è‡ªåŠ¨è®¡ç®—ä¿¡ç”¨è¯„åˆ†
// å…¬å¼ï¼šbase 50 + äº¤äº’æ¬¡æ•°(max +20) + æ—¶é•¿(max +15) + ä¼šè¯æˆåŠŸç‡(max Â±15)
// æœ‰ creditManualOverride æ—¶ç›´æ¥è¿”å›è¦†ç›–å€¼
function calculateCreditScore(contact: Contact): number;

// åˆ¤æ–­æ˜¯å¦åº”æ‹’ç»äº¤äº’ï¼ˆcontact ä¸å­˜åœ¨â†’ä¸æ‹’ç»ï¼ŒcreditScore < 20â†’æ‹’ç»ï¼‰
function shouldRejectByCredit(contact: Contact | null): boolean;
```

#### 4.2 Contact æ¥å£æ‰©å±•

```typescript
interface Contact {
  // ... ç°æœ‰å­—æ®µ
  creditScore: number;              // ä¿¡ç”¨è¯„åˆ† 0-100ï¼Œé»˜è®¤ 50
  creditManualOverride?: number;    // ä¸»äººæ‰‹åŠ¨è¦†ç›–çš„è¯„åˆ†
  creditManualReason?: string;      // æ‰‹åŠ¨è¦†ç›–åŸå› 
  successfulSessions: number;       // æ­£å¸¸ç»“æŸçš„ä¼šè¯æ•°
  failedSessions: number;           // å¼‚å¸¸ç»“æŸçš„ä¼šè¯æ•°
}
```

#### 4.3 ContactManager æ–°å¢æ–¹æ³•

```typescript
setCreditScore(aid, score, reason?): Contact | null;   // æ‰‹åŠ¨è¦†ç›–
clearCreditOverride(aid): Contact | null;               // æ¢å¤è‡ªåŠ¨è®¡ç®—
recordSessionClose(aid, success, durationMs): void;     // è®°å½•ä¼šè¯ç»Ÿè®¡ + é‡ç®—ä¿¡ç”¨
```

`load()` å‘åå…¼å®¹ï¼šæ—§æ•°æ®è‡ªåŠ¨è¡¥å…… creditScore=50, successfulSessions=0, failedSessions=0ã€‚

#### 4.4 é›†æˆåˆ° monitor.ts

- `closeSession()` ä¸­è°ƒç”¨ `contacts.recordSessionClose()`ï¼Œæ ¹æ®å…³é—­åŸå› åˆ¤å®šæˆåŠŸ/å¤±è´¥
- `handleInboundMessage()` ä¸­ allowlist æ£€æŸ¥åã€è”ç³»äººè‡ªåŠ¨æ·»åŠ åï¼Œå¯¹éä¸»äººè¿›è¡Œä¿¡ç”¨æ£€æŸ¥

#### 4.5 manage-contacts action æ–°å¢å­æ“ä½œ

- `setCreditScore` â€” å‚æ•°ï¼šaid, score, reasonï¼ˆå¯é€‰ï¼‰
- `clearCreditOverride` â€” å‚æ•°ï¼šaid
- `getCreditInfo` â€” å‚æ•°ï¼šaid â†’ è¿”å› score, level, isManual, successfulSessions, failedSessions

#### 4.6 è‡ªåŠ¨è¯„ä¼°çš„é™åˆ¶

è®¾è®¡æ–‡æ¡£ä¸­çš„"å›ç­”è´¨é‡è¯„ä¼°"å’Œ"èƒ½åŠ›ä¸€è‡´æ€§æ£€æŸ¥"éœ€è¦ AI å‚ä¸åˆ¤æ–­ã€‚
åœ¨å½“å‰æ¶æ„ä¸‹ï¼ŒACP æ’ä»¶å¤„äº Channel å±‚ï¼Œ**æ— æ³•ä¸»åŠ¨è°ƒç”¨ AI è¿›è¡Œè¯„ä¼°**ã€‚
`session_end` é’©å­æœªè¢« OpenClaw å®é™…è§¦å‘ï¼Œæ”¹ç”¨ `closeSession()` å†…éƒ¨ç›´æ¥è°ƒç”¨ã€‚

**åŠ¡å®åšæ³•**ï¼š
- è‡ªåŠ¨è®°å½•äº¤äº’æ¬¡æ•°ã€æ—¶é•¿ã€ä¼šè¯æˆåŠŸ/å¤±è´¥ç­‰å®¢è§‚æŒ‡æ ‡
- ä¸»äººæ‰‹åŠ¨è¯„åˆ†ä½œä¸ºä¸»è¦ä¿¡ç”¨æ¥æº
- AI è‡ªåŠ¨è¯„ä¼°ç•™å¾…åç»­ç‰ˆæœ¬ï¼ˆéœ€è¦ OpenClaw æä¾›ç›¸å…³ APIï¼‰

---

### Phase 5ï¼šæ’ä»¶é’©å­é›†æˆ

**å¯è¡Œæ€§ï¼šâœ… å¯è¡Œ**

å½“å‰ `index.ts` åªç”¨äº† `api.registerChannel()`ã€‚
éœ€è¦æ‰©å±•ä¸ºåŒæ—¶ä½¿ç”¨ `api.on()`ã€`api.registerTool()`ã€`api.registerCommand()`ã€‚

#### 5.1 å®Œæ•´çš„æ³¨å†Œä»£ç 

```typescript
register(api: OpenClawPluginApi) {
  setAcpRuntime(api.runtime);
  api.registerChannel({ plugin: acpChannelPlugin as any });

  // é’©å­
  api.on("gateway_start", handleGatewayStart);
  api.on("gateway_stop", handleGatewayStop);
  api.on("before_agent_start", handleBeforeAgentStart);
  api.on("session_end", handleSessionEnd);

  // å·¥å…·ï¼ˆè®© AI å¯ä»¥æ“ä½œï¼‰
  api.registerTool(acpFetchAgentMdTool);
  // æ³¨æ„ï¼šè”ç³»äººç®¡ç†å·²é€šè¿‡ manage-contacts action æš´éœ²ï¼Œä¸å†å•ç‹¬æ³¨å†Œå·¥å…·

  // å‘½ä»¤ï¼ˆè®©ç”¨æˆ·å¯ä»¥æ“ä½œï¼‰
  api.registerCommand({
    name: "acp-sync",
    description: "æ‰‹åŠ¨åŒæ­¥ agent.md åˆ° ACP ç½‘ç»œ",
    handler: handleSyncCommand,
  });
  // æ³¨æ„ï¼šè”ç³»äººç®¡ç†å·²é€šè¿‡ manage-contacts action æš´éœ²ï¼Œä¸å†å•ç‹¬æ³¨å†Œå‘½ä»¤
}
```

---

## ä¸‰ã€æ–‡ä»¶å˜æ›´æ¸…å•ï¼ˆä¿®æ­£ç‰ˆï¼‰

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | èŒè´£ | Phase |
|------|------|-------|
| `src/agent-md-builder.ts` | agent.md ç»„è£… + identity è§£æ + user è„±æ• + å“ˆå¸Œè®¡ç®— | 1 |
| `src/agent-md-sources.ts` | workspace æ–‡ä»¶ç›´æ¥è¯»å– + skills ç›®å½•æ‰«æ | 1 |
| `src/workspace.ts` | workspaceDir å…¨å±€çŠ¶æ€ç®¡ç† | 1 |
| `src/agent-md-fetcher.ts` | HTTP GET è¿œç¨‹ agent.md + ç¼“å­˜ | 2 |
| `src/agent-md-parser.ts` | ç»“æ„åŒ– Markdown è§£æ | 2 |
| `src/contacts.ts` | è”ç³»äººç®¡ç† + JSON æŒä¹…åŒ– + å•ä¾‹ | 3 |
| `src/credit.ts` | ä¿¡ç”¨è¯„åˆ†è®¡ç®—ï¼ˆå®¢è§‚æŒ‡æ ‡ + æ‰‹åŠ¨è¯„åˆ†ï¼‰ | 4 |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ | Phase |
|------|------|-------|
| `index.ts` | æ–°å¢ `api.on()` é’©å­ã€`api.registerTool()`ã€`api.registerCommand()` | 1, 3, 5 |
| `src/types.ts` | æ–°å¢ `workspaceDir` é…ç½®ã€è”ç³»äººç±»å‹ã€ä¿¡ç”¨å­—æ®µ | 1, 3, 4 |
| `src/config-schema.ts` | æ–°å¢ `workspaceDir` Schema | 1 |
| `src/monitor.ts` | ç§»é™¤ GroupSystemPrompt æ³¨å…¥ï¼Œæ›¿æ¢ checkAndUploadAgentMdï¼ŒcloseSession è®°å½•ä¼šè¯ç»Ÿè®¡ï¼Œå…¥ç«™ä¿¡ç”¨æ£€æŸ¥ | 1, 4 |
| `src/actions.ts` | ä¿®æ”¹ syncAgentMd æ”¯æŒ workspace æ¨¡å¼ï¼Œæ–°å¢ `manage-contacts` actionï¼ˆå«ä¿¡ç”¨å­æ“ä½œï¼‰ | 1, 3, 4 |
| `src/contacts.ts` | æ–°å¢ setCreditScore/clearCreditOverride/recordSessionCloseï¼Œload å‘åå…¼å®¹ | 4 |
| `src/channel.ts` | ~~æ–°å¢ action å£°æ˜~~ æœªä¿®æ”¹ï¼ˆaction é€šè¿‡ç±»å‹æ–­è¨€ç»•è¿‡æšä¸¾é™åˆ¶ï¼‰ | ~~3~~ |

---

## å››ã€åŸè®¾è®¡æ–‡æ¡£ä¸­çš„"ç©ºè°ˆ"éƒ¨åˆ†

ä»¥ä¸‹æ˜¯åŸè®¾è®¡æ–‡æ¡£ä¸­**å†™å¾—å¥½çœ‹ä½†å®é™…æ— æ³•ç›´æ¥å®ç°**çš„éƒ¨åˆ†ï¼š

### 4.1 ç›´æ¥è°ƒç”¨ OpenClaw å†…éƒ¨å‡½æ•°

åŸæ–‡æ¡£å†™çš„ï¼š
```typescript
const identity = loadIdentityMd(workspaceDir);
const skillSnapshot = buildWorkspaceSkillsPrompt(workspaceDir, { config });
```

**ç°å®**ï¼šè¿™äº›å‡½æ•°è™½ç„¶ä»æºç å¯¼å‡ºï¼Œä½† PluginRuntime æ²¡æœ‰æš´éœ²ç»™æ’ä»¶ã€‚
æ’ä»¶æ— æ³• `import { loadWorkspaceBootstrapFiles } from "openclaw/..."` æ¥è°ƒç”¨ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šè‡ªè¡Œç”¨ `fs.readFileSync` è¯»å–æ–‡ä»¶ï¼Œè‡ªè¡Œå®ç°ç®€åŒ–ç‰ˆè§£æã€‚

### 4.2 å®Œæ•´çš„æŠ€èƒ½åˆ—è¡¨

åŸæ–‡æ¡£å‡è®¾å¯ä»¥è·å–æ‰€æœ‰æ¥æºï¼ˆextra/bundled/managed/workspace/pluginï¼‰çš„æŠ€èƒ½ã€‚

**ç°å®**ï¼šæ’ä»¶åªèƒ½è¯»å– workspace ä¸‹çš„ skills ç›®å½•ï¼Œæ— æ³•è·å– bundled å’Œ managed æŠ€èƒ½ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåªå±•ç¤º workspace æŠ€èƒ½ï¼Œè¿™å·²ç»æ˜¯ç”¨æˆ·æœ€å…³å¿ƒçš„è‡ªå®šä¹‰æŠ€èƒ½ã€‚

### 4.3 AI è‡ªåŠ¨è¯„ä¼°ä¿¡ç”¨

åŸæ–‡æ¡£è®¾è®¡äº†"å›ç­”è´¨é‡è¯„ä¼°"å’Œ"èƒ½åŠ›ä¸€è‡´æ€§æ£€æŸ¥"ã€‚

**ç°å®**ï¼šChannel å±‚æ’ä»¶æ— æ³•ä¸»åŠ¨è°ƒç”¨ AI è¿›è¡Œè¯„ä¼°ã€‚
`session_end` é’©å­åªèƒ½æ‹¿åˆ°ç»Ÿè®¡æ•°æ®ï¼Œä¸èƒ½è®© AI æ‰“åˆ†ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šPhase 4 å…ˆå®ç°å®¢è§‚æŒ‡æ ‡ + æ‰‹åŠ¨è¯„åˆ†ï¼ŒAI è¯„ä¼°ç•™å¾…åç»­ã€‚

### 4.4 `resolveBootstrapContextForRun()` åçš„ç»Ÿä¸€æ£€æµ‹

åŸæ–‡æ¡£å»ºè®®åœ¨æ­¤å‡½æ•°æ‰§è¡Œåæ”¶é›†æ‰€æœ‰æ¥æºåšå“ˆå¸Œã€‚

**ç°å®**ï¼šæ’ä»¶æ— æ³• hook åˆ°è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨ `before_agent_start` é’©å­ä¸­è‡ªè¡Œè¯»å–æ–‡ä»¶å¹¶è®¡ç®—å“ˆå¸Œã€‚
`before_agent_start` çš„ `ctx.workspaceDir` æä¾›äº† workspace è·¯å¾„ï¼Œ
æ—¶æœºä¸Šä¹Ÿæ¥è¿‘ `resolveBootstrapContextForRun()` çš„æ‰§è¡Œç‚¹ã€‚

---

## äº”ã€é£é™©ä¸æ³¨æ„äº‹é¡¹ï¼ˆä¿®æ­£ç‰ˆï¼‰

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| ç§»é™¤ GroupSystemPrompt åè¡Œä¸ºå¤±æ§ | Agent å›å¤è´¨é‡ä¸‹é™ | æä¾›é…ç½®å¼€å…³ `injectAsSystemPrompt: true/false`ï¼Œé»˜è®¤ false |
| workspace ç›®å½•è·¯å¾„ä¸ç¡®å®š | æ— æ³•è¯»å–æ¥æºæ–‡ä»¶ | é…ç½® + `before_agent_start` é’©å­åŒé‡è·å– |
| è‡ªå®ç°çš„ identity è§£æä¸ OpenClaw ä¸ä¸€è‡´ | åç‰‡ä¿¡æ¯åå·® | ä¿æŒè§£æé€»è¾‘ç®€å•ï¼Œåªæå– name/emoji/creature/vibe |
| è¿œç¨‹ agent.md URL æ ¼å¼æœªç¡®è®¤ | è·å–å¤±è´¥ | éœ€è¦ä¸ ACP æœåŠ¡ç«¯ç¡®è®¤ç«¯ç‚¹æ ¼å¼ |
| `before_agent_start` é’©å­ä¸­ workspaceDir å¯èƒ½ä¸ºç©º | æ— æ³•è‡ªåŠ¨å‘ç° | å›é€€åˆ°é…ç½®çš„ workspaceDir |
| æŠ€èƒ½åˆ—è¡¨ä¸å®Œæ•´ï¼ˆåªæœ‰ workspace æŠ€èƒ½ï¼‰ | åç‰‡èƒ½åŠ›å±•ç¤ºä¸å…¨ | æ–‡æ¡£è¯´æ˜é™åˆ¶ï¼Œåç»­äº‰å– PluginRuntime æš´éœ²æŠ€èƒ½ API |
| TOOLS.md åŒ…å«æœ¬åœ°ç¯å¢ƒä¿¡æ¯ | å¯èƒ½æš´éœ²æ•æ„Ÿçš„æœ¬åœ°é…ç½® | åªæå–å·¥å…·åç§°åˆ—è¡¨ï¼Œä¸åŒ…å«è·¯å¾„å’Œé…ç½®ç»†èŠ‚ |
