# 会话键与记忆协同实现清单

> 目标：把 ACP 的 groupId/sessionId 概念与 OpenClaw 会话系统稳定对齐，解决上下文断裂

## 1. 实现目标

1. DM 会话从”短期 transport session 粒度”切换到”identity + peer 稳定粒度”。
2. Group 会话采用”identity + groupId 稳定粒度”。值班 Agent（Duty v2）作为普通群成员走相同的群消息路径，无需独立会话键。
3. transport `sessionId` 仅用于回复路由，不用于长期会话桶。
4. 引入旧 key 到新 key 的兼容迁移，避免历史瞬间丢失。

## 2. 现状代码定位

1. `src/monitor.ts`：
   - 私聊会话键构造（包含 `sessionIdShort`）。
   - 群聊会话键构造。
   - `recordInboundSession` 调用点。  
2. `src/session-rating.ts`：
   - 存在 sessionKey 生成逻辑，需和 monitor 保持一致。

## 3. 目标键规范

### 3.1 DM 键

```text
agent:{agentId}:acp:{identityId}:peer:{senderAidLower}
```

### 3.2 Group 键

```text
agent:{agentId}:acp:{identityId}:group:{groupIdLower}
```

### 3.3 Duty（v2 优先窗口模式）

Duty v2 中值班 Agent 是普通群成员，优先收到消息，不再有独立的分发/仲裁流程。
会话键直接复用 Group 键，无需单独定义：

```text
agent:{agentId}:acp:{identityId}:group:{groupIdLower}
```

## 4. 任务拆分

### 4.1 抽离 session key 生成器

1. 新增 `src/acp-session-key.ts`：
   - `buildDmSessionKey(params)`
   - `buildGroupSessionKey(params)`
   - `normalizeAid/normalizeGroupId`  
2. `monitor.ts`、`session-rating.ts` 改为统一调用，不再各自拼字符串。

### 4.2 Duty v2 说明

Duty v2（优先窗口模式）已移除 `handleDutyDispatchForIdentity` 和 `dispatch_decision` 仲裁协议。
值班 Agent 作为普通群成员接收消息，走 `handleGroupMessagesForIdentity` 路径，会话键自然复用 Group 键，无需额外改造。

### 4.3 DM 稳定键替换

1. 在 `handleInboundMessageForIdentity` 路径替换旧 DM 键。  
2. `sessionIdShort` 仍可用于日志，但不参与 key。  
3. 确保 `recordInboundSession` 与 reply 上下文均使用新键。

### 4.4 迁移机制（一次性兼容）

1. 新增 `acp/runtime/key-map.json` 存储映射与迁移标记。  
2. 新 DM key 首次命中时扫描旧前缀：
   - `agent:*:acp:*:session:{sender}:*`  
3. 迁移策略：复制最近活跃会话元数据到新 key（不删旧数据）。  
4. 记录 `acp/runtime/migration.log`，避免重复迁移。

### 4.5 观测与告警

1. 增加日志字段：`session_key_mode=stable_dm|group`。  
2. 增加迁移日志字段：`old_key/new_key/migrated_at/status`。  
3. 若迁移失败，不阻断主流程，降级继续处理当前消息。

## 5. 与记忆体系协同

1. 会话历史负责“近期上下文 + 审计流水”。  
2. `acp/**/*.md` 负责“跨窗口持久记忆”。  
3. DM 稳定键 + MEMORY 组合保证“重连后还能接续”。

## 6. 完成标准

1. 同一 peer 多次新 transport session 进入同一个 DM key。  
2. 群聊 key 不受 msg_id 变化影响。  
3. 旧 key 能自动迁移至少一次并有日志。  
4. 值班 Agent（Duty v2）复用 Group 会话键，monitor 与 session-rating 的 key 生成逻辑完全一致。
