# ACP 上下文体系需求包（2026-02-21）

> 状态：设计拆解版（待评审后进入实现）
> 范围：ACP Channel 插件内改造，不修改 OpenClaw 核心

## 1. 目标

1. 解决 ACP 私聊/群聊上下文“会话不连续 + 记忆易丢失”的问题。  
2. 建立 `workspace/acp/` 统一目录，承载 ACP 协议、身份补充、群/私聊/话题记忆。  
3. 明确 Agent 主维护机制：何时维护、如何维护、如何受权限约束。  
4. 给出可直接实施的任务清单、测试清单、上线与回滚策略。

## 2. 已对齐前提

1. ACP 身份层不是替代 OpenClaw 身份层，而是补充层（`ACP_IDENTITY.md`）。  
2. 维护主体以 Agent 为主，Owner 做策略约束与审计纠偏。  
3. 使用现有注入点（尤其 `messageToolHints`、`groupIntroHint`）驱动维护行为。  
4. `GroupSystemPrompt` 作为 ACP 上下文注入主路径。

## 3. 文档清单（阅读顺序）

1. `01-会话键与记忆协同实现清单.md`：解决“为什么会忘、怎么不忘”。  
2. `02-目录结构与上下文文件生命周期实现清单.md`：解决“文件怎么建、谁写、何时写”。  
3. `03-Agent自动维护流程与注入约束实现清单.md`：解决“Agent 如何知道该维护什么”。  
4. `04-acp_context工具与权限模型实现清单.md`：解决“可执行工具与权限边界”。  
5. `05-测试验收迁移回滚清单.md`：解决“怎么验证、怎么灰度、怎么回退”。  
6. `06-待确认问题与默认决策建议.md`：收敛未决项，避免实现阻塞。

## 4. 代码落点总览（按模块）

1. `src/monitor.ts`：会话键生成、GroupSystemPrompt 注入、recordInboundSession 调用。  
2. `src/channel.ts`：`messageToolHints` 注入维护 SOP。  
3. `src/group-tools.ts`：群历史与工具行为对齐。  
4. `src/session-rating.ts`：sessionKey 相关逻辑一致性。  
5. `index.ts`：工具注册、启动期 ensure 调用。  
6. 新增模块（建议）：`src/acp-context.ts`、`src/context-tool.ts`、`src/context-templates.ts`、`src/acp-session-key.ts`。

## 5. 与现有文档关系

1. 本目录是本次需求的“执行版拆解”。  
2. 详细背景仍可参考：  
   - `docs/15-ACP上下文Markdown文件体系设计.md`  
   - `docs/16-ACP字段自动维护规范（Agent主维护）.md`
