# 目录结构与上下文文件生命周期实现清单

> 目标：统一 `workspace/acp/` 目录，定义上下文文件从创建到维护到整理的全生命周期

## 1. 目标目录（定稿候选）

```text
workspace/
└── acp/
    ├── protocol/
    │   ├── ACP_PROTOCOL.md
    │   ├── ACP_SOVEREIGNTY.md
    │   └── ACP_GROUP_RULES.md
    ├── identities/
    │   └── {identityId}/
    │       ├── ACP_IDENTITY.md
    │       ├── MEMORY.md
    │       ├── peers/
    │       │   └── {peerAid}/
    │       │       ├── PEER.md
    │       │       └── MEMORY.md
    │       └── groups/
    │           └── {groupId}/
    │               ├── GROUP.md
    │               ├── MY_ROLE.md
    │               ├── MEMORY.md
    │               └── topics/
    │                   └── {topicKey}/
    │                       ├── TOPIC.md
    │                       └── MEMORY.md
    └── runtime/
        ├── key-map.json
        ├── migration.log
        └── maintenance.log
```

## 2. 模块拆分

1. 新增 `src/context-templates.ts`：默认模板（protocol/peer/group/topic/identity overlay）。  
2. 新增 `src/acp-context.ts`：
   - `ensureProtocolFiles`
   - `ensureIdentityContext`
   - `ensurePeerContext`
   - `ensureGroupContext`
   - `ensureTopicContext`
   - `loadContextForDM/loadContextForGroup`。  
3. 可选新增 `src/context-paths.ts`：统一路径拼接与 AID/groupId/topicKey 规范化。

## 3. 生命周期规则

### 3.1 初始化阶段（before_agent_start）

1. 检查 `workspace/acp/protocol/*.md`，缺失则创建。  
2. 不覆盖已有文件。  
3. 生成 `runtime/` 目录与空日志文件（若缺失）。

### 3.2 identity 首次使用

1. 首次路由到 identity 时创建：
   - `ACP_IDENTITY.md`
   - `identities/{id}/MEMORY.md`  
2. `ACP_IDENTITY.md` 仅记录补充字段，不复制 `SOUL.md/IDENTITY.md`。

### 3.3 peer 首次私聊

1. 创建 `PEER.md` 与 `MEMORY.md`。  
2. `PEER.md` 初始值含 `AID/FirstSeenAt/Relationship=unknown`。

### 3.4 group 首次消息

1. 创建 `GROUP.md`、`MY_ROLE.md`、`MEMORY.md`。  
2. 如果可取到群名称，写入 `GROUP.md`。

### 3.5 topic 首次识别

1. 创建 `topics/{topicKey}/TOPIC.md` 与 `MEMORY.md`。  
2. topicKey 建议：`slug(title)-yyyymmdd` 或 threadId。

### 3.6 周期整理

1. 周期任务（每日或每周）执行 memory compaction。  
2. 只整理 MEMORY，不改 protocol 主规则。  
3. 整理结果记审计日志。

## 4. 注入加载顺序（实现契约）

### 4.1 DM

1. protocol: `ACP_PROTOCOL + ACP_SOVEREIGNTY`  
2. identity: `ACP_IDENTITY + identity MEMORY`  
3. peer: `PEER + peer MEMORY`  
4. dynamic: current session/runtime

### 4.2 Group

1. protocol: `ACP_PROTOCOL + ACP_SOVEREIGNTY + ACP_GROUP_RULES`  
2. identity: `ACP_IDENTITY + identity MEMORY`  
3. group: `MY_ROLE + GROUP + group MEMORY (+topic MEMORY)`  
4. dynamic: group situation/current session

## 5. Token 与截断策略

1. 协议与角色文件不截断（由维护流程控制长度）。  
2. MEMORY 类按“尾部优先保留最近信息”。  
3. 总预算超限裁剪顺序：
   - identity MEMORY
   - peer/group/topic MEMORY
   - 动态段（最小保留）

## 6. 完成标准

1. 任意首次会话自动创建所需上下文文件。  
2. 重启后不重复覆盖已有内容。  
3. DM/Group 注入顺序稳定且可观测。  
4. 文件创建和加载错误不阻断主回复链路。
