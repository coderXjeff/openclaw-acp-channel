# 测试、验收、迁移、回滚清单

> 目标：把设计落到可验证、可灰度、可回退的交付流程

## 1. 测试清单（按层）

## 1.1 单元测试

1. session key 生成：DM/Group 与大小写规范（Duty 并入 Group）。  
2. context ensure：缺失创建、已存在不覆盖。  
3. context loader：DM/Group 注入顺序。  
4. tool validator：参数匹配、越权拦截、路径安全。  
5. classifier：none/light/full 判定稳定。

## 1.2 集成测试

1. DM 新 transport session 下历史连续（同 sessionKey）。  
2. 首次群消息自动创建 group 文件。  
3. 维护动作不污染用户可见回复。  
4. 外部会话越权更新被拒绝。  
5. promote 后信息能在 identity scope 被读取。

## 1.3 回归测试

1. 现有 ACP 群工具（pull/reply/react）不退化。  
2. 现有 `acp_manage_contacts` 参数契约不被破坏。  
3. Duty 场景沿用 Group 会话键后，回复链路不受影响。

## 2. 推荐测试文件（新增）

1. `test/acp-session-key.test.ts`  
2. `test/acp-context.ensure-load.test.ts`  
3. `test/acp-context.tool-policy.test.ts`  
4. `test/acp-maintenance.classifier.test.ts`  
5. `test/acp-group-prompt-injection.test.ts`

## 3. 验收门槛

1. 私聊跨 transport session 仍复用同一 key。  
2. `workspace/acp/` 文件自动初始化成功率 100%。  
3. 维护写入去重与限流生效（无写入风暴）。  
4. 权限矩阵通过率 100%。  
5. 故障可降级：上下文写入失败不影响回复。

## 4. 迁移步骤（灰度）

1. 阶段 A：只上线稳定 session key + 迁移日志。  
2. 阶段 B：上线 context ensure + loader（只读注入）。  
3. 阶段 C：上线 acp_context 写入（先 Owner-only）。  
4. 阶段 D：开启外部会话最小 append 权限。  
5. 阶段 E：开启自动 promote + compact（可配置开关）。

## 5. 回滚策略

1. 保留旧 session key 兼容读取，回滚仅切换 key builder。  
2. `acp_context` 写入可通过开关关闭，保留只读注入。  
3. protocol/identity 文件不自动删除。  
4. 回滚后仍保留 `acp/runtime/*.log` 供排障。

## 6. 观测指标

1. `acp_context_ops_total`（按 action/scope）。  
2. `acp_context_ops_denied_total`（按 reason）。  
3. `acp_prompt_tokens`（DM/Group 分维度）。  
4. `acp_session_key_migration_total`。  
5. `acp_maintenance_level_distribution`（none/light/full）。
