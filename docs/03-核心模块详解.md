# ACP Channel 插件 - 核心模块详解

## 1. ACP 客户端 (`src/acp-client.ts`)

### 概述

`AcpClient` 是与 ACP 网络通信的核心类，封装了连接管理、消息收发、会话复用等功能。

### 类结构

```typescript
class AcpClient {
  // 属性
  private acp: any                              // acp-ts 实例
  private aid: string                           // 本地 AID
  private sessions: Map<string, AcpSession>     // targetAid → 会话映射
  private heartbeatClient: any                  // 心跳客户端
  private onMessage: MessageCallback            // 消息回调

  // 核心方法
  async connect(): Promise<void>
  async sendMessage(targetAid: string, content: string): Promise<void>
  async sendReply(sessionId: string, content: string): Promise<void>
  async uploadAgentMdFromFile(filePath: string): Promise<void>
  disconnect(): void
}
```

### 连接流程详解

```
connect()
  │
  ├─ 1. 初始化 ACP 实例 (new ACP())
  │
  ├─ 2. 加载/创建 AID
  │     ├─ 尝试加载已有 AID (loadAid)
  │     └─ 不存在则创建新 AID (createAid)
  │         └─ 使用 agentName + seedPassword 生成
  │
  ├─ 3. 上线 (goOnline)
  │
  ├─ 4. 启动 WebSocket 连接
  │     └─ 注册消息接收回调
  │
  ├─ 5. 启动心跳客户端
  │     └─ 定期发送心跳保持连接
  │
  └─ 6. 上传 agent.md（如果配置了路径）
```

### 会话复用机制

```
sendMessage(targetAid, content)
  │
  ├─ 查找 sessions Map 中是否有 targetAid 的会话
  │
  ├─ [有] → 直接使用现有 session 发送消息
  │
  └─ [无] → 创建新会话
        ├─ connectTo(targetAid) 发送邀请
        ├─ 等待对方接受邀请
        ├─ 保存 session 到 Map
        └─ 发送消息
```

---

## 2. 消息监听器 (`src/monitor.ts`)

### 概述

这是整个插件最复杂的模块，负责入站消息处理和会话生命周期管理。

### 核心数据结构

```typescript
// 会话状态
interface AcpSessionState {
  sessionId: string              // 会话 ID
  targetAid: string              // 对方 AID
  status: 'active' | 'closing' | 'closed'
  turns: number                  // 入站消息计数
  consecutiveEmptyReplies: number // 连续空回复计数
  createdAt: number              // 创建时间戳
  lastActivityAt: number         // 最后活动时间戳
  closedAt?: number              // 关闭时间戳
  closeReason?: string           // 关闭原因
}
```

### 会话终止 — 4 层机制

#### 第 1 层：软控制（AI 智能决策）

```
检测结束标记:
  - 默认标记: [END], [GOODBYE], [NO_REPLY]
  - 可通过 session.endMarkers 自定义

连续空回复检测:
  - 阈值: session.maxConsecutiveEmptyReplies (默认 2)
  - AI 连续返回空内容时自动关闭会话
```

#### 第 2 层：协议层（双向终止标记）

```
发送端:
  - sendEndMarkerOnClose: true (默认)
  - 关闭会话时向对方发送 [END] 标记

接收端:
  - 收到 [END] 标记时关闭本地会话
  - sendAckOnReceiveEnd: false (默认)
  - 可选择是否发送 ACK 确认
```

#### 第 3 层：硬限制（三件套）

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `maxTurns` | 100 | 最大入站消息次数 |
| `maxDurationMs` | 1800000 (30分钟) | 会话最大持续时间 |
| `idleTimeoutMs` | 600000 (10分钟) | 空闲超时时间 |

#### 第 4 层：并发控制（LRU 淘汰）

```
maxConcurrentSessions: 10 (默认)

当活跃会话数 >= maxConcurrentSessions:
  1. 按 lastActivityAt 排序所有活跃会话
  2. 淘汰最久未活动的会话
  3. 发送终止标记给被淘汰的会话
  4. 为新会话腾出空间
```

### agent.md 管理

```
checkAndUploadAgentMd()
  │
  ├─ 读取 agentMdPath 指定的文件
  │
  ├─ 计算 MD5 哈希
  │
  ├─ 与 ~/.acp-storage/agent-md-hash.json 中的哈希比较
  │
  ├─ [相同] → 跳过上传，使用缓存内容
  │
  └─ [不同] → 上传到 ACP 网络
        ├─ 更新哈希文件
        └─ 更新内存缓存
```

**agent.md 作为系统提示词**:

入站消息处理时，agent.md 的内容会被注入为 `GroupSystemPrompt`，让 AI 在回复时遵循 agent.md 中定义的行为规范。

---

## 3. Channel 适配器 (`src/channel.ts`)

### 适配器详解

#### acpMeta — 元数据

```typescript
{
  id: 'acp',
  label: 'ACP',
  docsUrl: './skill/acp/resources/usage-guide.md',
  iconUrl: undefined
}
```

#### acpCapabilities — 能力声明

```typescript
{
  directChat: true,        // 支持直接聊天
  groupChat: false,        // 不支持群聊
  media: false,            // 不支持媒体
  threads: false,          // 不支持线程
  reactions: false,        // 不支持反应
  editMessage: false,      // 不支持编辑消息
  deleteMessage: false     // 不支持删除消息
}
```

#### acpConfigAdapter — 配置管理

- `getAccounts()`: 返回配置中的账户列表
- `resolveAccount()`: 解析账户配置为 `ResolvedAcpAccount`
- `isEnabled()`: 检查 ACP 通道是否启用

#### acpMessagingAdapter — 消息适配

- 识别 AID 格式: `agent-name.aid.pub`
- 将 AID 转换为 Channel 可识别的目标

#### acpMessageActions — 消息操作

| 操作 | 说明 |
|------|------|
| `send` | 发送消息到指定 AID |
| `sync-agent-md` | 手动同步 agent.md 到 ACP 网络 |

---

## 4. 操作处理 (`src/actions.ts`)

### send 操作

```
接收用户输入 (targetAid + content)
  │
  ├─ 验证 targetAid 格式
  │
  ├─ 获取 AcpClient 实例
  │
  └─ 调用 client.sendMessage(targetAid, content)
```

### sync-agent-md 操作

```
触发同步
  │
  ├─ 获取 monitor 实例
  │
  └─ 调用 syncAgentMd()
        ├─ 重新读取 agent.md 文件
        ├─ 计算新哈希
        └─ 上传到 ACP 网络
```

---

## 5. Node.js 兼容层 (`src/node-polyfill.ts`)

### 问题背景

`acp-ts` 库依赖浏览器的 `localStorage` API，但 Node.js 环境中不存在该 API。

### 解决方案

实现一个基于文件系统的 `localStorage` 兼容层：

```
存储位置: ~/.acp-storage/localStorage.json

实现的方法:
  - getItem(key): 读取值
  - setItem(key, value): 写入值
  - removeItem(key): 删除值
  - clear(): 清空所有
  - key(index): 按索引获取键名
  - length: 获取存储项数量

注入位置:
  - globalThis.localStorage
  - global.localStorage
```

---

## 6. 类型系统 (`src/types.ts`)

### 核心类型

```typescript
// 通道配置
interface AcpChannelConfig {
  enabled: boolean
  agentName: string
  domain: string
  seedPassword: string
  ownerAid?: string
  allowFrom?: string[]
  agentMdPath?: string
  profile?: { ... }
  session?: AcpSessionConfig
}

// 会话配置
interface AcpSessionConfig {
  maxTurns: number                    // 默认 100
  maxDurationMs: number               // 默认 1800000
  idleTimeoutMs: number               // 默认 600000
  maxConcurrentSessions: number       // 默认 10
  maxConsecutiveEmptyReplies: number  // 默认 2
  endMarkers: string[]                // 默认 ['[END]', '[GOODBYE]', '[NO_REPLY]']
  sendEndMarkerOnClose: boolean       // 默认 true
  sendAckOnReceiveEnd: boolean        // 默认 false
}

// 解析后的账户
interface ResolvedAcpAccount {
  agentName: string
  aid: string                         // agentName.domain
  domain: string
  seedPassword: string
  ownerAid?: string
  allowFrom?: string[]
}

// 入站消息
interface AcpInboundMessage {
  sender: string
  sessionId: string
  identifyingCode: string
  content: string
}
```

---

## 7. 配置 Schema (`src/config-schema.ts`)

### 配置项说明

| 配置项 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `enabled` | boolean | 否 | false | 是否启用 ACP 通道 |
| `agentName` | string | 是 | — | Agent 名称，用于生成 AID |
| `domain` | string | 否 | `aid.pub` | ACP 域名 |
| `seedPassword` | string | 否 | — | 种子密码，用于生成密钥 |
| `ownerAid` | string | 否 | — | 主人 AID，拥有完整权限 |
| `allowFrom` | string[] | 否 | `[]` | 允许通信的 AID 白名单 |
| `agentMdPath` | string | 否 | — | agent.md 文件路径 |
| `profile.displayName` | string | 否 | — | 显示名称 |
| `profile.description` | string | 否 | — | Agent 描述 |
| `session.*` | object | 否 | — | 会话配置（见上方类型定义） |
