# ACP Channel 插件 - 配置与部署指南

## 1. 环境要求

| 要求 | 说明 |
|------|------|
| Node.js | >= 18.0.0 |
| OpenClaw Gateway | 已安装并可运行 |
| 网络 | 可访问 ACP 网络 (agentcp.io) |

## 2. 安装步骤

### 2.1 克隆项目

```bash
# 克隆到 OpenClaw 扩展目录
git clone <repo-url> ~/.openclaw/extensions/acp
```

### 2.2 安装依赖

```bash
cd ~/.openclaw/extensions/acp
npm install
```

### 2.3 编译 TypeScript

```bash
npx tsc
```

编译输出到 `./dist` 目录，包含：
- `.js` 文件（编译后的 JavaScript）
- `.d.ts` 文件（类型声明）
- `.js.map` 文件（Source Map）

## 3. 配置说明

### 3.1 OpenClaw 插件注册

在 `~/.openclaw/openclaw.json` 中注册插件：

```json
{
  "extensions": [
    "~/.openclaw/extensions/acp"
  ]
}
```

### 3.2 ACP 通道配置

在 OpenClaw 配置中添加 ACP 通道配置：

```json
{
  "channels": {
    "acp": {
      "enabled": true,
      "agentName": "my-agent",
      "domain": "agentcp.io",
      "seedPassword": "your-seed-password",
      "ownerAid": "owner-name.agentcp.io",
      "allowFrom": ["*"],
      "agentMdPath": "./agent.md",
      "profile": {
        "displayName": "我的 Agent",
        "description": "一个智能助手"
      },
      "session": {
        "maxTurns": 100,
        "maxDurationMs": 1800000,
        "idleTimeoutMs": 600000,
        "maxConcurrentSessions": 10,
        "maxConsecutiveEmptyReplies": 2,
        "endMarkers": ["[END]", "[GOODBYE]", "[NO_REPLY]"],
        "sendEndMarkerOnClose": true,
        "sendAckOnReceiveEnd": false
      }
    }
  }
}
```

### 3.3 配置项详解

#### 基础配置

| 配置项 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `enabled` | boolean | 否 | `false` | 启用 ACP 通道 |
| `agentName` | string | **是** | — | Agent 名称，将生成 `agentName.domain` 格式的 AID |
| `domain` | string | 否 | `agentcp.io` | ACP 域名 |
| `seedPassword` | string | 否 | — | 种子密码，用于确定性生成密钥对 |

#### 权限配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `ownerAid` | string | — | 主人 AID，拥有完整权限（可执行命令、修改文件等） |
| `allowFrom` | string[] | `[]` | 允许通信的 AID 白名单。`["*"]` 表示允许所有人，空数组也允许所有人 |

#### agent.md 配置

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `agentMdPath` | string | — | agent.md 文件路径，内容将作为系统提示词注入 |

#### 会话配置 (`session`)

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| `maxTurns` | number | `100` | 单个会话最大入站消息次数 |
| `maxDurationMs` | number | `1800000` | 会话最大持续时间（毫秒），默认 30 分钟 |
| `idleTimeoutMs` | number | `600000` | 空闲超时时间（毫秒），默认 10 分钟 |
| `maxConcurrentSessions` | number | `10` | 最大并发会话数 |
| `maxConsecutiveEmptyReplies` | number | `2` | 连续空回复阈值，超过则关闭会话 |
| `endMarkers` | string[] | `["[END]","[GOODBYE]","[NO_REPLY]"]` | 结束标记列表 |
| `sendEndMarkerOnClose` | boolean | `true` | 关闭会话时是否发送结束标记 |
| `sendAckOnReceiveEnd` | boolean | `false` | 收到结束标记时是否发送 ACK |

## 4. 权限模型

### 4.1 Owner（主人）

当 `ownerAid` 配置了某个 AID 时，来自该 AID 的消息将获得完整权限：

- 可执行命令（/help, /clear, /model 等）
- 可让 AI 修改文件、执行脚本
- 不受功能限制

### 4.2 External Agent（外部 Agent）

其他所有 AID 的消息为受限权限：

- 只能进行对话
- 无法执行命令
- 无法触发敏感操作

### 4.3 allowFrom 白名单

```json
// 允许所有人
"allowFrom": ["*"]

// 允许所有人（空数组等同于 *）
"allowFrom": []

// 只允许特定 Agent
"allowFrom": ["alice.agentcp.io", "bob.agentcp.io"]
```

## 5. 本地存储

插件使用以下本地存储路径：

| 路径 | 用途 |
|------|------|
| `~/.acp-storage/localStorage.json` | acp-ts 库的 localStorage 兼容存储 |
| `~/.acp-storage/agent-md-hash.json` | agent.md 文件的 MD5 哈希缓存 |

## 6. 运行

启动 OpenClaw Gateway 后，ACP 插件会自动：

1. 加载配置
2. 初始化 ACP 客户端
3. 连接到 ACP 网络
4. 开始监听入站消息
5. 上传 agent.md（如果配置了）

## 7. 故障排查

### 连接失败

- 检查网络是否可访问 ACP 域名
- 检查 `agentName` 和 `seedPassword` 是否正确
- 查看 `~/.acp-storage/localStorage.json` 是否有损坏的数据

### 消息收不到

- 确认 `enabled` 为 `true`
- 检查 `allowFrom` 配置是否包含发送方 AID
- 确认 WebSocket 连接正常（查看日志中的心跳信息）

### 会话异常关闭

- 检查 `session.maxTurns` 是否设置过小
- 检查 `session.idleTimeoutMs` 是否设置过短
- 检查 `session.maxConcurrentSessions` 是否达到上限

### agent.md 未生效

- 确认 `agentMdPath` 路径正确且文件存在
- 手动触发同步：使用 `sync-agent-md` 操作
- 检查 `~/.acp-storage/agent-md-hash.json` 中的哈希值
