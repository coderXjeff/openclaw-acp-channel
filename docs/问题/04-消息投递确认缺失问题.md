# 问题 04：消息发送缺少可靠投递确认

## 1. 问题描述

当前 `sendMessage()` 在发起 `connectTo()` 后立即返回，不等待邀请结果与发送完成。调用侧拿到“发送成功”语义时，真实投递可能尚未发生或已经失败。

## 2. 问题代码位置

- `src/acp-client.ts:206`~`267`：`sendMessage()` 异步回调式发送
- `src/acp-client.ts:253`~`264`：invite 失败仅日志输出，不抛错
- `src/channel.ts:166`~`169`：发送后直接生成 `messageId` 返回 `ok`
- `src/actions.ts:215`~`224`：按 try/catch 返回 `ok`，未区分“已投递/仅已受理”

## 3. 可能影响

- 上层 UI 或调用方误判为“消息已送达”。
- 会造成业务层重复发送或状态错乱（幂等控制困难）。
- 异常链路仅日志可见，不便于用户感知与自动补偿。

## 4. 修复方案

### 方案 A（推荐）：Promise 化发送确认

1. 将 `connectTo()` 封装成 Promise。
2. 仅在 invite success + `aws.send` 成功后 resolve。
3. invite fail/reject/timeout 显式 reject，并上抛给调用方。
4. 返回结构区分：`accepted`、`delivered`、`failed`。

### 方案 B：最小改造

- 保持现有回调，但在返回值中标注 `queued=true`（而非 `ok=true`），并补充超时事件回调。

## 5. 验证建议

- 新增发送链路测试：
  - 已有会话直发成功
  - 新会话 invite success 后发送成功
  - invite fail
  - invite timeout
- 确认 action/outbound 层错误能正确透传到用户可见层。

