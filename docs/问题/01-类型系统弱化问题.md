# 问题 01：类型系统被 `any` 和断言削弱

## 1. 问题描述

当前代码虽使用 TypeScript，但在关键边界处使用了 `any`、类型断言和类型绕过，导致编译期无法有效约束行为，增加运行时错误风险。

## 2. 问题代码位置

- `src/plugin-types.ts:76`：`ChannelMessageActionName` 未包含 `manage-contacts`
- `src/actions.ts:50`：通过 `(actions as Set<string>).add("manage-contacts")` 绕过类型
- `src/actions.ts:88`：通过 `(action as string) === "manage-contacts"` 绕过联合类型
- `index.ts:27`：`api.registerChannel({ plugin: acpChannelPlugin as any })`
- `src/acp-client.ts:117`：`(aws as any).acceptInviteFromHeartbeat(...)`

## 3. 可能影响

- 编译器无法发现 action 名称拼写错误、遗漏分支等问题。
- 框架升级后（如 SDK 类型变化）容易在运行时才暴露问题。
- IDE 自动补全和重构能力变弱，后续维护成本提高。
- 安全相关动作（如权限分流）更容易因类型漂移产生隐蔽缺陷。

## 4. 修复方案

### 方案 A（推荐）：补齐类型定义并消除绕过

1. 在 `ChannelMessageActionName` 中显式加入 `"manage-contacts"`。
2. 删除 `actions.ts` 中的强转写法，改为类型内合法添加。
3. `handleAction` 分支使用联合类型直接判断，去除 `(action as string)`。
4. 尽量移除 `index.ts` 的 `as any`，改为补齐 `ChannelPlugin` 与 SDK 对齐类型。
5. 为 `acp-ts` 增补本地声明（`*.d.ts`），替代 `(aws as any)`。

### 方案 B：短期过渡

- 保留个别断言，但在断言处增加 runtime guard（方法存在性判断）和错误日志。

## 5. 验证建议

- 执行 `tsc --noEmit`，确保无新增类型绕过。
- 新增 action 相关单测，验证 `manage-contacts` 在 `listActions` 和 `handleAction` 中类型一致。
- 模拟 `acp-ts` 方法缺失场景，验证 graceful fallback 行为。
