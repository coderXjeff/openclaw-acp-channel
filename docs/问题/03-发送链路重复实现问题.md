# 问题 03：发送链路存在重复实现

## 1. 问题描述

发送逻辑在多个模块重复实现（目标解析、消息包装、发送入口），导致规则分散，后续修改容易出现行为不一致。

## 2. 问题代码位置

- `src/channel.ts:138`~`176`：`outbound.sendText` 内自行解析 `to`
- `src/actions.ts:184`~`225`：`send` action 再次解析 `to` 并拼装参数
- `src/outbound.ts:22`：添加 `[From]/[To]` 消息头
- `src/monitor.ts:723`~`733`：再次暴露 `sendAcpMessage`（与 `outbound.ts` 职责重叠）

## 3. 可能影响

- 规则修改（如目标格式）需要多处同步，容易漏改。
- 不同发送入口行为可能不一致（比如 message header、session 处理）。
- 排障时难以快速定位“究竟哪条链路发送了消息”。

## 4. 修复方案

### 方案 A（推荐）：单一发送服务

1. 建立统一发送服务（例如 `src/send-service.ts`）。
2. 收敛能力：目标解析、安全校验、消息头策略、实际发送。
3. `channel.ts`、`actions.ts`、`monitor.ts` 全部调用统一服务。
4. 为“带消息头/不带消息头”提供显式参数，避免隐式行为。

### 方案 B：保留现状但加契约

- 保留多入口，但通过公共工具函数统一 `parseTarget` 与 `buildMessageEnvelope`。

## 5. 验证建议

- 增加参数化测试：`acp:{aid}:{session}`、纯 AID、非法目标。
- 针对不同入口（action/outbound/monitor）做一致性测试，确保产出相同。

