# 问题 02：配置 Schema 与运行时默认值不一致

## 1. 问题描述

会话配置的默认值在 Schema 层与运行时默认层存在不一致，且必填项约束与启用语义有冲突，容易导致“文档/界面显示值”和“真实生效值”不一致。

## 2. 问题代码位置

- `src/config-schema.ts:97`：`maxDurationMs` 默认 `180000`
- `src/config-schema.ts:103`：`idleTimeoutMs` 默认 `60000`
- `src/config-schema.ts:65`~`109`：`session` 未声明 `maxConcurrentSessions`
- `src/types.ts:99`：`DEFAULT_SESSION_CONFIG.maxDurationMs = 600000`
- `src/types.ts:100`：`DEFAULT_SESSION_CONFIG.idleTimeoutMs = 120000`
- `src/types.ts:102`：`DEFAULT_SESSION_CONFIG.maxConcurrentSessions = 10`
- `src/config-schema.ts:112`：全局 `required: ["agentName"]`

## 3. 可能影响

- 用户在配置 UI 中看到的默认值与实际运行值不一致，排障困难。
- 运维按 Schema 文档调参后，实际效果偏离预期（会话过早/过晚关闭）。
- 缺失 `maxConcurrentSessions` Schema 会让该能力难以被配置发现。
- `agentName` 全局 required 会增加“先禁用再配置”场景的配置负担。

## 4. 修复方案

### 方案 A（推荐）：单一事实源

1. 将 `DEFAULT_SESSION_CONFIG` 作为默认值唯一来源。
2. 生成 Schema 时复用该常量（避免双写）。
3. 在 Schema 中补充 `session.maxConcurrentSessions`。
4. 将 `agentName` 的必填约束改为条件约束（`enabled=true` 时必填），或在 `isConfigured` 层处理。

### 方案 B：文档兜底

- 若暂不改代码，至少在配置文档和 UI help 中明确“最终以运行时默认值为准”。

## 5. 验证建议

- 对比 UI 默认值与 `getSessionConfig()` 返回值，确保一致。
- 增加配置回归测试：空配置、部分配置、非法配置、`enabled=false` 场景。
- 在 `/acp-status` 输出会话配置快照，便于线上核对。

