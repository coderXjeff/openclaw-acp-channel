# 问题 07：核心链路测试覆盖不足

## 1. 问题描述

现有测试集中在 `agent.md`、`contacts`、`credit` 等模块；而最关键的在线链路（`monitor/gateway/acp-client`）缺少系统性自动化测试。

## 2. 问题代码位置

- `vitest.config.ts:5`：仅包含 `test/**/*.test.ts`
- 已覆盖模块示例：
  - `test/agent-md-builder.test.ts:1`
  - `test/contacts.test.ts:1`
  - `test/credit.test.ts:1`
- 关键链路实现文件：
  - `src/monitor.ts:417`（监听主流程）
  - `src/monitor.ts:897`（网关循环与重连）
  - `src/acp-client.ts:40`（连接与收发）

## 3. 可能影响

- 重连、会话终止、权限分流等高风险逻辑回归难以及时发现。
- 升级 `acp-ts` 或 OpenClaw SDK 时，兼容性问题更可能在生产暴露。
- 难以对“发送确认”“结束标记”“LRU 淘汰”等复杂行为做稳定保证。

## 4. 修复方案

### 方案 A（推荐）：分层补测

1. **单元测试**：为 `getSessionConfig`、`checkHardLimits`、`hasEndMarker`、`computeBackoff` 建立纯函数测试。
2. **组件测试**：mock `AcpClient` 与 runtime，覆盖 `handleInboundMessage` 分支（allowlist、owner、credit、end marker）。
3. **网关测试**：模拟 `abortSignal` 与连接状态变化，验证重连计数和状态快照。
4. **发送测试**：覆盖 invite success/fail/timeout。

### 方案 B：先加回归样例

- 优先为历史高频缺陷补“缺陷回归测试”。

## 5. 验证建议

- 建立最小覆盖门槛（如 statements/branches）。
- CI 中增加 `npm test` 与 `tsc --noEmit` 联合门禁。
- 对关键状态字段（`running/connected/reconnectAttempts`）增加断言。

