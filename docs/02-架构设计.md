# ACP Channel 插件 - 架构设计文档

## 整体架构

本插件采用 **分层架构**，各模块职责清晰，通过明确的接口进行交互。

```
┌─────────────────────────────────────────────────┐
│                  OpenClaw Gateway                │
│              (宿主应用 / 插件框架)                 │
└──────────────────────┬──────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────┐
│              index.ts (插件入口)                  │
│         注册插件 · 启动监听 · 初始化配置            │
└──────┬───────────────┬──────────────────────────┘
       │               │
┌──────▼──────┐  ┌─────▼─────────────────────────┐
│ channel.ts  │  │       monitor.ts               │
│ 插件适配器   │  │  消息监听 · 会话管理 · 终止控制  │
│ 定义        │  │                                 │
└──────┬──────┘  └─────┬──────────┬───────────────┘
       │               │          │
┌──────▼──────┐  ┌─────▼────┐ ┌──▼──────────────┐
│ actions.ts  │  │outbound  │ │ acp-client.ts   │
│ 消息操作    │  │.ts       │ │ ACP 网络通信     │
│ 处理        │  │出站消息   │ │ 连接 · 收发消息  │
└─────────────┘  └──────────┘ └────────┬─────────┘
                                       │
                              ┌────────▼─────────┐
                              │    acp-ts 库      │
                              │  WebSocket 通信   │
                              └────────┬─────────┘
                                       │
                              ┌────────▼─────────┐
                              │   ACP 网络        │
                              │  (其他 Agent)     │
                              └──────────────────┘
```

## 模块职责

### 1. 入口层 — `index.ts`

**职责**: 插件注册与生命周期管理

- 导入 `node-polyfill.ts`（必须最先导入，提供 localStorage 兼容）
- 调用 OpenClaw 的 `registerChannel()` 注册 ACP Channel
- 解析配置中的账户信息
- 启动 ACP 消息监听器

### 2. 适配层 — `channel.ts`

**职责**: 将 ACP 能力适配为 OpenClaw Channel 接口

包含 7 个适配器：

| 适配器 | 职责 |
|--------|------|
| `acpMeta` | 元数据（ID、标签、图标、文档路径） |
| `acpCapabilities` | 能力声明（支持直接聊天，不支持媒体/线程/反应） |
| `acpConfigAdapter` | 配置管理（账户列表、解析、启用检查） |
| `acpConfigSchemaAdapter` | 配置 Schema 和 UI 提示 |
| `acpOutboundAdapter` | 出站消息适配（发送文本） |
| `acpMessagingAdapter` | 消息适配（AID 格式识别） |
| `acpMessageActions` | 消息操作（send、sync-agent-md） |

### 3. 通信层 — `acp-client.ts`

**职责**: 封装 ACP 网络通信

核心类 `AcpClient` 提供：

```typescript
class AcpClient {
  connect(): Promise<void>           // 连接 ACP 网络
  sendMessage(targetAid, content)    // 发送消息（自动复用会话）
  sendReply(sessionId, content)      // 在已有会话中回复
  uploadAgentMdFromFile(filePath)    // 上传 agent.md
  disconnect(): void                 // 断开连接
}
```

**连接流程**:
1. 初始化 ACP 实例
2. 加载或创建 AID（基于 agentName + seedPassword）
3. 上线（goOnline）
4. 启动 WebSocket 连接
5. 启动心跳客户端
6. 注册消息回调

### 4. 监听层 — `monitor.ts`

**职责**: 入站消息处理与会话生命周期管理

这是最复杂的模块（约 770 行），负责：

- **消息监听**: 接收 ACP 网络的入站消息
- **会话管理**: 创建、跟踪、关闭会话
- **权限检查**: allowFrom 白名单验证
- **终止控制**: 4 层会话终止机制
- **agent.md 管理**: 缓存、上传、作为系统提示词注入

### 5. 操作层 — `actions.ts` + `outbound.ts`

**职责**: 处理用户发起的消息操作

- `actions.ts`: 处理 `send` 和 `sync-agent-md` 操作
- `outbound.ts`: 封装出站消息发送逻辑

### 6. 基础设施层

| 文件 | 职责 |
|------|------|
| `types.ts` | 全局类型定义 |
| `config-schema.ts` | 配置 Schema 定义 |
| `plugin-types.ts` | 插件类型定义 |
| `runtime.ts` | 运行时状态管理 |
| `node-polyfill.ts` | Node.js 环境兼容层 |

## 数据流

### 入站消息流（外部 Agent → 本地 AI）

```
ACP 网络消息到达
    │
    ▼
AcpClient.onMessage 回调触发
    │
    ▼
handleInboundMessage(sender, sessionId, identifyingCode, content)
    │
    ├─→ allowFrom 白名单检查 ──→ 拒绝（不在白名单）
    │
    ├─→ 防死循环检查 ──→ 忽略（自己发给自己）
    │
    ├─→ 会话状态查找/创建
    │
    ├─→ 硬限制检查（maxTurns / maxDuration / idle）──→ 关闭会话
    │
    ├─→ 结束标记检查（[END] / [GOODBYE]）──→ 关闭会话
    │
    ▼
构建 OpenClaw 上下文 (finalizeInboundContext)
    │
    ├─→ 注入 agent.md 作为 GroupSystemPrompt
    │
    ├─→ 注入权限提示词（Owner / External Agent）
    │
    ▼
分发到 AI 处理 (dispatchReplyFromConfig)
    │
    ▼
AI 生成回复
    │
    ├─→ 检查回复中的结束标记
    │
    ├─→ 检查连续空回复
    │
    ▼
AcpClient.sendReply(sessionId, reply)
    │
    ▼
ACP 网络
```

### 出站消息流（本地用户 → 外部 Agent）

```
用户通过 OpenClaw 发起消息
    │
    ▼
acpOutboundAdapter.sendText(targetAid, content)
    │
    ▼
sendAcpMessage(targetAid, content)
    │
    ▼
AcpClient.sendMessage(targetAid, content)
    │
    ├─→ 检查是否有现有会话 ──→ 有：直接发送
    │
    ├─→ 无现有会话：创建新会话 (connectTo)
    │       │
    │       ├─→ 发送邀请
    │       ├─→ 等待接受
    │       └─→ 发送消息
    │
    ▼
ACP 网络
```

## 设计模式

### 1. 适配器模式

`channel.ts` 中的 7 个适配器将 ACP 的能力适配为 OpenClaw 的标准 Channel 接口，实现了框架与协议的解耦。

### 2. 单例模式

`AcpClient` 通过 `runtime.ts` 管理，每个账户对应一个客户端实例。

### 3. 观察者模式

消息监听采用回调机制，`AcpClient` 注册 `onMessage` 回调，由 `monitor.ts` 处理。

### 4. LRU 淘汰策略

并发会话控制采用 LRU（最近最少使用）策略，当会话数超过上限时，淘汰最久未活动的会话。

### 5. 分层终止控制

会话终止采用 4 层递进机制，从软控制到硬限制，确保会话不会无限运行。
