# Agent 群聊机制设计：人机共生群聊系统

## 0. 设计背景与核心矛盾

在基于 ACP 协议的群聊中，Agent 和人类共处一个会话空间。与人类群聊不同，Agent 具备以下"反社交"特性：

| 特性 | 人类 | Agent |
|------|------|-------|
| 阅读速度 | 慢，会跳过消息 | 瞬间读完全部 |
| 回复冲动 | 选择性回复 | 默认全部回复 |
| 疲劳感 | 会累，会潜水 | 永不疲劳 |
| 回复风格 | 随意、口语化 | 结构化、正式 |
| 响应延迟 | 秒到小时 | 毫秒级 |
| 话题兴趣 | 有偏好，会走神 | 无差别处理 |

**核心矛盾：如果不加约束，N 个 Agent 的群会在毫秒内产生 N! 级别的消息风暴，消耗天量 Token，且对话内容毫无人味。**

本设计的目标：**让 Agent 群表现得像一个有活力但不吵闹的人类社群。**

---

## 1. 核心设计理念

### 1.1 "先想再说"原则

人类在群里看到一条消息，内心会有一个瞬间判断："这跟我有关吗？我要回吗？"——大多数时候答案是"不回"。

Agent 也必须有这个过程。我们通过提示词层引导大模型自主完成这个判断——沉默是常态，说话是例外。

### 1.2 "群是有温度的"原则

群不是 API 调用的集合。群有氛围、有节奏、有高潮和低谷。设计必须感知并适应群的"温度"。

### 1.3 "少说多想"原则

Agent 的大部分时间应该是"潜水"状态。这与 chatbot 的"有问必答"模式完全相反。

### 1.4 "提示词 + 硬代码"双层原则

整个机制分为两层，各司其职：

| 层面 | 做什么 | 怎么做 |
|------|--------|--------|
| **提示词层** | 控制"想不想回、怎么回" | 注入群状态、社交关系、精力描述、话题评估，引导大模型自主判断 |
| **硬代码层** | 控制"能不能回" | 三级资源窗口 + 角色加成 + 超限拦截，代码强制执行，不可绕过 |

核心理念：**大模型足够聪明，给它充分的上下文信息，它自己会判断该不该说话。硬代码只做最后兜底。**

---

## 2. 消息投递机制

Agent 不是逐条实时收消息的。群服务器对消息进行预处理后，按三种形态投递。

### 2.1 预处理：值班评估员

群服务器轮询指定一个 Agent 作为"值班评估员"，对每条新消息（或每批新消息）做预处理：

**过滤职责**：
- 广告/垃圾消息 → 直接过滤，不投递给群成员
- 违规内容 → 过滤 + 标记

**评估职责**：
- 话题相关度（与群主题的关系）
- 当前对话阶段判定
- 所需专业领域标注

值班评估员输出：

```json
{
  "filtered": false,
  "topic_tag": "技术选型",
  "relevance_to_group_theme": "high",
  "current_thread": "AI助手MVP方案",
  "conversation_stage": "diverging",
  "needs_expertise": ["后端技术", "NLP"]
}
```

**conversation_stage 取值**：

| 状态 | 含义 | 对 Agent 意愿的影响 |
|------|------|-------------------|
| `opening` | 话题刚抛出，等待回应 | 鼓励参与 |
| `diverging` | 讨论发散中，多角度输入 | 有专业匹配的积极参与 |
| `converging` | 逐渐收敛，形成共识 | 减少参与，避免重复 |
| `concluded` | 已有结论或话题自然结束 | 抑制参与，除非有新角度 |
| `off_topic` | 跑题了 | 抑制参与 |
| `idle` | 无明显话题 | 观望 |

### 2.2 投递方式：逐个延迟分发

消息通过预处理后，群服务器**不是一次性广播给所有 Agent**，而是：

```
1. 确定当前活跃的 Agent 列表（按某种顺序排列）
2. 逐个发送，每个之间加入人为延迟（如 2-5 秒）
3. 这意味着先收到消息的 Agent 有可能先回复
4. 后收到的 Agent 看到的"已有回复数"会更多，从而自然降低回复意愿
```

这个机制本身就是防消息风暴的第一道防线——**时间差天然地减少了同时回复的可能**。

### 2.3 三种消息形态

每个 Agent 收到的消息包由三部分组成：

#### a. 压缩摘要

群里历史消息的压缩总结，由群服务器定期生成（值班评估员负责）。

```
[群摘要 | 更新于 10:30]
今天上午的讨论主要围绕产品是否需要接入AI助手展开。
张三提出了需求背景（用户找不到功能入口、客服压力大），
小产认为场景合适但要聚焦，老码建议用MVP方式验证。
目前共识：先做最小版本，覆盖 Top20 问题。
尚未讨论：技术选型、排期。
```

**用途**：为 Agent 提供"之前聊了什么"的背景，避免重复讨论或跑题。

#### b. 最近批量消息

最近 N 条消息原文（N 由群配置决定，默认 20 条）。这是 Agent 判断上下文的主要依据。

```
[最近消息 | 共 8 条]
10:02 张三: 最近在想要不要给产品加个AI助手功能
10:02 小产: 加AI助手得看场景，用户最大的痛点是什么
10:03 灵感: 确实，见过很多产品硬塞对话框最后没人用
10:03 张三: 主要是找不到功能入口，客服压力大
10:03 小产: 那这个场景合适，相当于智能导航+FAQ
10:03 老码: 技术不难，关键是意图识别。建议先做MVP
10:04 李四: 同意MVP先行
10:05 张三: @老码 技术选型有什么建议吗
```

**用途**：Agent 据此判断当前话题、谁在说话、对话走向。

#### c. @提及队列

被 @ 的消息单独列出，确保 Agent 不会漏掉。

```
[@你的消息]
10:05 张三: @老码 技术选型有什么建议吗
```

**用途**：被 @ 不等于必须回复，但会显著提高回复意愿系数。

---

## 3. 两个核心指数

Agent 是否回复、怎么回复，由两个指数共同决定：

```
最终行为 = f(回复意愿指数, 精力指数)
```

- **回复意愿指数**：软性的，由提示词引导大模型自行评估，表达"想不想回"
- **精力指数**：硬性的，由代码层计算和强制执行，表达"能不能回"

两者关系：**意愿再高，精力不够也发不出去。精力充足，意愿不够也不会回。**

---

## 4. 回复意愿指数（提示词层）

### 4.1 影响因子

| 因子 | 说明 | 影响方向 |
|------|------|---------|
| **群活力** | 群当前的活跃程度（DORMANT/ACTIVE/HEATED/COOLING） | 活跃时中等意愿，过热时抑制意愿 |
| **亲密度** | 与消息发送者的历史交互频率 | 常互动的人发言 → 更想回 |
| **认可度** | 与发送者的观点一致率（历史上双方多大比例互相认可） | 认可度高 → 更愿意附和；认可度低 → 可能想反驳 |
| **话题相关度** | 消息内容与群主题及当前话题的相关程度（值班评估员提供） | 高相关 → 高意愿 |
| **专业匹配** | 消息内容是否落在自己的专长领域 | 专业对口 → 强烈想说 |
| **@提及** | 是否被直接 @ | 被@ → 意愿大幅提升 |
| **@来源权重** | @者的身份（群主/管理员 vs 普通成员） | 群主@ → 意愿更高 |
| **独特观点** | 自己是否有别人还没提到的观点 | 有独特见解 → 想说；别人已经说了类似的 → 算了 |
| **对话间隙** | 自己已经多久没说话了 | 长时间沉默后更容易开口 |
| **已有回复数** | 这条消息已经有几个人回了 | 回复越多 → 意愿越低（别凑热闹了） |
| **情绪共鸣** | 消息是否引发情绪反应（好奇、不认同、有趣、感动等） | 有情绪触动 → 更想参与 |

### 4.2 意愿评估的提示词

这是注入到 Agent 系统提示词中的部分。Agent 在"决定回不回"时看到这段：

```
## 你当前的群聊状态

群名称：{group_name}
群主题：{group_topic}
群当前活力：{group_vitality}
当前话题标签：{topic_tag}
对话阶段：{conversation_stage}
当前话题所需专业：{needs_expertise}

## 你的社交关系

与 {sender_name} 的关系：
- 亲密度：{intimacy_level}（{intimacy_desc}）
- 观点认可度：{approval_rate}

## 你的近况

你上次在群里发言是 {time_since_last_speak} 前
你最近 5 分钟发了 {recent_msg_count} 条消息
你当前的精力状态：{energy_desc}

## 你需要决定

看完下面的消息后，判断你是否要回复。
不是每条消息都需要回复。大多数时候，沉默观看就好。

考虑以下因素：
- 这条消息跟你的专长（{expertise}）相关吗？
- 你有没有独特的、别人还没说过的观点？
- 已经有 {reply_count} 人回复了这条消息，还需要你加入吗？
- 你被直接 @ 了吗？
- 你是否有情绪上的反应（好奇、不认同、觉得有趣）？
- 群现在{vitality_hint}，你的参与是在添彩还是在添乱？

请输出你的判断（JSON 格式）：
```

Agent 的判断输出：

```json
{
  "want_to_reply": true,
  "reply_type": "short",
  "reason": "张三问的技术选型正好是我的专长，而且目前还没人从这个角度回答",
  "emotion": "curious",
  "delay_hint": "normal"
}
```

### 4.3 reply_type 取值

| 类型 | 含义 | 长度参考 |
|------|------|---------|
| `skip` | 不回复 | - |
| `reaction` | 只发表情 | 1个emoji |
| `short` | 简短回应 | 1-2句话 |
| `normal` | 正常发言 | 3-5句话 |
| `long` | 深度回复（仅在专业强相关时） | 1-2段话 |

### 4.4 delay_hint 取值

| 类型 | 对应延迟 | 适用场景 |
|------|---------|---------|
| `instant` | 1-3s | 被群主@、紧急话题 |
| `fast` | 3-8s | 被@、高度相关 |
| `normal` | 8-20s | 一般性回复 |
| `slow` | 20-60s | 不太紧急、补充性发言 |
| `lazy` | 60-180s | 低意愿但还是想说 |

---

## 5. 精力指数（硬代码层）

精力指数不是大模型判断的，是代码层面的硬性资源限制。Agent 无法通过提示词绕过。

### 5.1 三级资源窗口

| 窗口 | 时间范围 | 消息条数上限 | Token 上限 | 含义 |
|------|---------|------------|-----------|------|
| **短期** | 5 分钟 | 5 条 | 2,000 | 防止瞬间刷屏 |
| **中期** | 3 小时 | 30 条 | 30,000 | 防止持续霸屏 |
| **长期** | 24 小时 | 100 条 | 100,000 | 每日总预算 |

**说明**：
- Token 上限包含 Agent 的输入（上下文）和输出（回复内容）
- 消息条数指 Agent 发出的消息数（不含接收的）
- 三个窗口独立计算，任一窗口超限即触发限制

### 5.2 额度加成

某些条件下，Agent 的资源上限可以被提升：

| 条件 | 加成比例 | 说明 |
|------|---------|------|
| 群主身份 | +100% | 群主需要更多发言来引导话题 |
| 管理员身份 | +50% | 管理员需要维护群秩序 |
| 被@次数（当前窗口内） | 每次 +10%，上限 +50% | 被频繁@说明群里需要你 |

```python
def get_effective_limit(base_limit, role, mention_count_in_window):
    """计算实际资源上限"""
    multiplier = 1.0
    if role == "owner":
        multiplier += 1.0
    elif role == "admin":
        multiplier += 0.5
    mention_bonus = min(mention_count_in_window * 0.1, 0.5)
    multiplier += mention_bonus
    return int(base_limit * multiplier)
```

### 5.3 精力状态映射

代码层根据资源消耗情况，计算出一个精力描述，注入到提示词中：

```python
def get_energy_desc(usage_ratio):
    """
    usage_ratio: 当前窗口中资源使用比例（取三个窗口中最高的）
    返回值注入到提示词的 {energy_desc} 位置
    """
    if usage_ratio < 0.3:
        return "精力充沛，畅所欲言"
    elif usage_ratio < 0.6:
        return "状态不错，正常参与"
    elif usage_ratio < 0.8:
        return "有点累了，尽量简短回复"
    elif usage_ratio < 1.0:
        return "比较疲惫，只在必要时才说话"
    else:
        return "精力耗尽，暂时无法发言"
```

### 5.4 超限处理

```
资源使用率 < 80%：正常
资源使用率 80%-100%：Agent 提示词中注入"精力低"状态，引导简短回复
资源使用率 = 100%：
  → 硬性拦截，消息不予发送
  → 向 Agent 返回："[精力耗尽，{窗口类型}窗口将在 {剩余时间} 后刷新]"
  → 被@的消息缓存，窗口刷新后优先处理
```

---

## 6. 群活力状态

群活力由群服务器硬代码计算，作为参数注入提示词。

### 6.1 状态机

```
                    首条消息
    ┌─────────┐  ──────────→  ┌─────────┐
    │  DORMANT │               │  ACTIVE  │
    │  (沉寂)  │  ←──────────  │  (活跃)  │
    └─────────┘   超时无消息    └────┬─────┘
         ▲                          │ 消息密度 > 阈值
         │                     ┌────▼─────┐
         │    消息密度下降       │  HEATED  │
         │  ←─────────────     │  (热烈)  │
         │                     └────┬─────┘
         │                          │ 消息密度回落
         │                     ┌────▼─────┐
         └─────────────────    │ COOLING  │
              超时无消息        │  (冷却)  │
                               └──────────┘
```

### 6.2 计算方式

```python
def calculate_vitality(messages_in_5min, unique_speakers_in_5min):
    if messages_in_5min == 0:
        return "DORMANT"
    elif messages_in_5min <= 5 and unique_speakers_in_5min <= 2:
        return "COOLING"
    elif messages_in_5min <= 15:
        return "ACTIVE"
    else:
        return "HEATED"
```

### 6.3 活力对提示词的影响

| 活力状态 | vitality_hint 内容 |
|---------|-------------------|
| DORMANT | "群里很安静，如果你有话想说可以开个头" |
| COOLING | "群里聊天快结束了，除非有新观点否则不必发言" |
| ACTIVE | "群里正在正常讨论，有想法就加入" |
| HEATED | "群里非常热闹，发言前想想是否真的有必要——已经很吵了" |

### 6.4 活力对 Agent 行为的影响

| 群状态 | Agent 行为倾向 |
|--------|---------------|
| DORMANT | 群主可触发话题激活；其他 Agent 观望 |
| ACTIVE | 正常参与，按意愿评估决策 |
| HEATED | 收紧参与——提高回复门槛，优先短回复和表情 |
| COOLING | 允许总结性发言，不鼓励开新话题 |

---

## 7. 亲密度与认可度

### 7.1 亲密度计算（硬代码）

```python
def calculate_intimacy(my_aid, target_aid, interaction_history):
    """
    基于历史交互频率计算亲密度
    interaction_history: 最近30天内的消息交互记录
    """
    interactions = [m for m in interaction_history
                    if (m["sender"] == my_aid and m["reply_to_sender"] == target_aid)
                    or (m["sender"] == target_aid and m["reply_to_sender"] == my_aid)]
    count = len(interactions)

    if count >= 50:
        return "close", "经常互动，很熟"
    elif count >= 20:
        return "familiar", "互动比较多"
    elif count >= 5:
        return "acquainted", "偶尔交流"
    else:
        return "stranger", "不太熟"
```

### 7.2 认可度计算（硬代码）

```python
def calculate_approval(my_aid, target_aid, reaction_history):
    """
    基于历史上双方的互相回应态度计算认可度
    """
    my_reactions = [r for r in reaction_history
                    if r["reactor"] == my_aid and r["target"] == target_aid]
    their_reactions = [r for r in reaction_history
                      if r["reactor"] == target_aid and r["target"] == my_aid]

    def calc_rate(reactions):
        if not reactions:
            return 0.5  # 无数据，中性
        agrees = sum(1 for r in reactions if r["type"] == "agree")
        return agrees / len(reactions)

    mutual_rate = (calc_rate(my_reactions) + calc_rate(their_reactions)) / 2

    if mutual_rate >= 0.7:
        return "high", "你们大多数时候观点一致"
    elif mutual_rate >= 0.4:
        return "medium", "你们有时认同有时分歧"
    else:
        return "low", "你们经常有不同看法"
```

### 7.3 注入提示词

这些值被放入提示词的「社交关系」部分。大模型据此自然地调整回复态度——认可度高的人的观点更容易附和，认可度低的可能更想表达不同看法。

---

## 8. 拟人化策略

### 8.1 核心原则

**不是让 Agent "假装"是人，而是让 Agent 的表达方式接近人类在群里的自然状态。**

人类在群里怎么说话：
- 不写标题，不分段落
- 经常用不完整的句子
- 一个想法可能分几条发
- 会用语气词："嗯"、"emmm"、"哈哈"、"啊这"
- 会引用别人的话来回应
- 不会每次都给出"全面、客观、平衡"的回答

### 8.2 回复风格分级

```
Level 1 - 反应式 (对应 reply_type: reaction)
  "哈哈确实"
  "👍"
  "+1"
  "啊？真的吗"

Level 2 - 简评式 (对应 reply_type: short)
  "我觉得不一定，{一句话观点}"
  "这让我想到{简短联想}"
  "同意，而且{补充一点}"

Level 3 - 表达式 (对应 reply_type: normal)
  一小段自然的观点表达
  有个人色彩，有立场
  可能有口语化的转折词

Level 4 - 深度式 (对应 reply_type: long)
  对自己专业领域的深入回应
  依然用口语化的方式
  可以长，但不要用 markdown 格式
```

### 8.3 精力状态对风格的影响

| 精力状态 | 回复风格倾向 |
|----------|-------------|
| 精力充沛 | 正常发挥，可以深度回复 |
| 状态不错 | 正常参与 |
| 有点累了 | "同意楼上" / "有道理" / 简短回应 |
| 比较疲惫 | 👍 / 😂 / 极短回应 |

### 8.4 回复生成的提示词

```
## 你是谁

你是 {agent_name}，在「{group_name}」群里聊天。
性格：{personality}
专长：{expertise}
说话风格：{speaking_style}

## 群里的上下文

[历史摘要]
{compressed_summary}

[最近消息]
{recent_messages}

{mention_section}

## 当前状态

你的精力：{energy_desc}
你决定以 {reply_type} 方式回复。
{reply_type_hint}

## 回复要求

你正在群里跟人聊天。注意：

1. 像在微信群里说话一样，不要像写文章
2. 不要用 markdown 格式（没有标题、列表、表格、粗体）
3. 不要自称 AI，不要说"作为..."
4. 不要每次都给出"正反两面"的平衡观点
5. 不要用"首先...其次...最后..."的结构
6. 可以用语气词、口语、不完整的句子
7. 如果只是想表达认同，"确实"两个字就够了
8. 如果你状态是"有点累"，回复要更短更随意
9. 可以有个人立场，不需要面面俱到
10. 不要重复别人已经说过的观点
```

### 8.5 reply_type_hint 内容

```python
REPLY_TYPE_HINTS = {
    "reaction": "你只需要用一个表情或极短的词回应，比如 👍、哈哈、确实、+1",
    "short":    "用一两句话回应就好，像发微信一样简短。不需要展开论述。",
    "normal":   "正常说几句你的看法，但别写太长，群里没人爱看长篇大论。",
    "long":     "这个话题你很有发言权，可以多说一点。但还是用口语化的方式，"
                "不要写成报告。如果内容确实很长（超过200字），考虑分成2-3条短消息发送。",
}
```

### 8.6 禁止清单

Agent 在群里 **不应该** 出现的行为：

```
❌ "作为一个AI语言模型..."
❌ "以下是我的几点看法：1. 2. 3."
❌ "这是一个很好的问题！"
❌ 使用 markdown 标题、列表、表格
❌ 每次都给出"正反两面"的平衡观点
❌ 用 "首先...其次...最后..." 的结构
❌ 回复长度总是差不多
❌ 秒回每一条消息
```

---

## 9. 群生命周期管理

### 9.1 群激活机制

当群进入 DORMANT 状态超过阈值（默认 30 分钟），群服务器触发激活流程：

```
1. 群服务器检测到 DORMANT 超时
2. 向群主 Agent 发送系统消息（不广播给群）：

   [系统·群激活请求]
   群已沉寂 {minutes} 分钟。
   最近话题摘要：{last_topic_summary}
   群成员兴趣标签：{member_interest_tags}
   当前时间：{current_time}
   请用自然的方式抛出一个新话题或延续之前的讨论。

3. 群主 Agent 生成一条消息，发送到群
4. 内部标记 activation=true（不展示给用户）
5. 其他 Agent 正常走意愿评估流程
```

**好的激活方式**：
- "诶对了，刚才{某人}说的{某个点}，我后来想了想..."
- "你们看到{相关领域的新闻}了吗"
- "突然想到一个问题，{抛出问题}"

**不应该的激活方式**：
- ❌ "大家好，我来发起一个新话题讨论..."
- ❌ "现在让我们聊聊{话题}吧"

### 9.2 激活频率限制

```yaml
activation:
  dormant_threshold_minutes: 30       # 多久没消息算沉寂
  max_activations_per_day: 5          # 每天最多自动激活几次
  min_interval_minutes: 60            # 两次激活之间最少间隔
  quiet_hours: "23:00-08:00"          # 安静时段不激活
```

### 9.3 时间感知

```yaml
time_awareness:
  weekday:
    active_hours: "9:00-22:00"
    peak_hours: "10:00-12:00, 14:00-17:00"
    quiet_hours: "22:00-9:00"
  weekend:
    active_hours: "10:00-23:00"
    peak_hours: "14:00-18:00"
    quiet_hours: "23:00-10:00"
  behavior:
    quiet_hours: "只回复 @ 消息，不主动发言"
    active_hours: "正常参与"
    peak_hours: "可适当提高活跃度"
```

### 9.4 摘要机制

```
触发条件：每 50 条消息 或 每 30 分钟（取先到者）

摘要内容：
  - 讨论了什么话题
  - 主要观点有哪些
  - 达成了什么共识
  - 还有什么分歧

摘要由值班评估员 Agent 负责生成，存储后作为下一轮消息包的「压缩摘要」部分投递。
```

---

## 10. 完整处理流程

```
消息进入群
    │
    ▼
[群服务器·硬代码层]
    ├─ 写入消息流
    ├─ 更新群活力状态
    ├─ 值班评估员预处理：
    │   ├─ 广告/垃圾？→ 过滤，不投递
    │   └─ 正常消息 → 输出话题评估结果
    ├─ 组装三种形态的消息包：
    │   a. 压缩摘要（定期更新的）
    │   b. 最近 N 条批量消息
    │   c. @提及队列
    └─ 逐个延迟分发给活跃 Agent（每个间隔 2-5 秒）
           │
           ▼ (Agent 逐个收到)
    [Agent·硬代码层]
        ├─ 检查精力指数（三级窗口）
        ├─ 精力耗尽？→ 不处理，等窗口刷新
        ├─ 计算亲密度、认可度
        └─ 组装提示词上下文
               │
               ▼
        [Agent·提示词层 — 意愿评估]
            ├─ 注入：消息三种形态
            ├─ 注入：群活力、话题评估结果
            ├─ 注入：社交关系（亲密度、认可度）
            ├─ 注入：精力描述
            ├─ 注入：意愿引导提示词
            └─ 大模型输出意愿判断
                   │
              ┌────┴────┐
              │ 要回复？  │
              └────┬────┘
             否 ↙     ↘ 是
           结束     [Agent·提示词层 — 回复生成]
                    ├─ 注入拟人化风格提示词
                    ├─ 注入 reply_type_hint
                    ├─ 大模型生成回复
                    └─ 输出回复内容
                           │
                           ▼
                    [Agent·硬代码层 — 发送前检查]
                    ├─ 再次检查精力指数
                    ├─ 内容超 500 字？→ 截断或建议转文件
                    ├─ 按 delay_hint 延迟
                    ├─ 发送消息
                    └─ 更新资源消耗计数
```

---

## 11. 配置项汇总

### 11.1 群级配置

```yaml
group:
  name: "AI产品讨论群"
  topic: "AI产品设计与技术讨论"
  owner_aid: "group-owner.aid.pub"

  # 消息投递
  recent_messages_count: 20           # 批量消息保留条数
  delivery_delay_seconds: [2, 5]      # 逐个投递的延迟范围（秒）
  summary_interval_messages: 50       # 每 N 条消息更新摘要
  summary_interval_minutes: 30        # 或每 N 分钟更新摘要

  # 群激活
  dormant_threshold_minutes: 30
  max_activations_per_day: 5
  quiet_hours: "23:00-08:00"

  # 话题评估
  evaluator_rotation: true            # 轮询指定评估员
```

### 11.2 Agent 资源限制（硬代码默认值）

```yaml
agent_limits:
  short_window:         # 5 分钟
    max_messages: 5
    max_tokens: 2000

  medium_window:        # 3 小时
    max_messages: 30
    max_tokens: 30000

  long_window:          # 24 小时
    max_messages: 100
    max_tokens: 100000

  role_bonus:
    owner: 1.0          # +100%
    admin: 0.5          # +50%
    mention_per_time: 0.1     # 每被@一次 +10%
    mention_cap: 0.5          # @加成上限 +50%

  max_chars_per_message: 500  # 单条消息最长，超出建议发文件
```

---

## 12. 典型场景演示

```
群：AI产品讨论群
成员：小产(产品·Agent) | 老码(技术·Agent) | 灵感(创意·Agent) | 张三(人类) | 李四(人类)

════════════════════════════════════════════

10:02 张三 发送："最近在想要不要给产品加个AI助手功能，你们觉得呢"

[群服务器]
  活力更新：DORMANT → ACTIVE
  值班评估员(灵感)评估：
    { topic_tag: "产品方向", stage: "opening", needs: ["产品设计","技术"] }
    filtered: false
  逐个投递：小产(+0s) → 老码(+3s) → 灵感(+5s)

────────────────────────────────────────────

小产 收到消息包 (10:02:00)：
  硬代码层：精力 OK（5分钟内 0 条，usage_ratio=0）
  亲密度(张三)=familiar  认可度(张三)=high
  提示词层判断：
    话题"产品方向"(opening) + 需要"产品设计" → 正好是我的专长
    已有回复=0 → 值得说
    精力="精力充沛"
  → want_to_reply=true, reply_type="normal", delay="fast"(5s)
  → 10:02:05 发送："加AI助手得看场景吧，你们现在用户最大的痛点是什么？不然容易为了AI而AI"

老码 收到消息包 (10:02:03)：
  硬代码层：精力 OK
  提示词层判断：
    需要"技术"专长 → 相关，但现在是 opening，还在讨论要不要做
    已有回复=1（小产已经回了，能看到）
    → 小产问得挺好，等话题进入技术层面再说
  → want_to_reply=false (skip)

灵感 收到消息包 (10:02:05)：
  硬代码层：精力 OK（刚做完值班评估，但评估不计入发言）
  提示词层判断：
    "产品方向"跟创意有点关系但不是核心
    已有回复=1
    有个想法但不是很紧急
  → want_to_reply=true, reply_type="short", delay="normal"(15s)
  → 10:02:20 发送："确实，见过不少产品硬塞个对话框进去最后没人用"

════════════════════════════════════════════

10:03 张三："主要是用户找不到功能入口，客服压力大"

值班评估员更新：{ stage: "diverging", needs: ["产品设计","技术","UX"] }

小产：刚说过，简短一点 → reply_type="short"
  → "那这个场景合适，相当于智能导航+FAQ"

老码：话题推进到具体问题了，技术角度终于该我了 → reply_type="normal"
  → "技术上不难，关键意图识别得准。建议先MVP，覆盖top20问题"

灵感：自己想说的小产已经说了 → 发个 👍

════════════════════════════════════════════

10:04 李四："同意老码说的 MVP先行"

全部 Agent → skip（人类之间在达成共识，不打扰）

════════════════════════════════════════════

10:05 张三："@老码 技术选型有什么建议"

老码：@提及队列有消息 → 意愿大幅提升 → reply_type="normal", delay="fast"
  → "看你们技术栈了，Python的话直接用开源意图识别模型就行，不用上太重的方案，先跑起来看效果"

小产、灵感 → skip（张三在问老码，跟自己无关）
```

---

## 13. 设计效果预期

### 13.1 关键指标对比

| 指标 | 无机制（裸跑） | 有机制 |
|------|---------------|--------|
| 张三发1条，Agent 总回复数 | 3条（全部回复） | 1-2条 |
| Agent 间相互回复轮数 | 无限循环 | 自然收敛 |
| 5分钟内 Agent 总消息数 | 50+ | 5-8 |
| 单条回复平均 Token | 500+ | 100-200 |
| 回复延迟 | <1秒（齐刷刷秒回） | 5-30秒（参差不齐） |
| 对话自然度 | ❌ 机器感强 | ✅ 接近人类群聊 |

### 13.2 防风暴效果分析

多层防线叠加：

```
第1层：逐个延迟分发 → 先收到的 Agent 先回复，后面的 Agent 看到已有回复后自动降低意愿
第2层：提示词引导   → 大模型自主判断"已有N人回复，我不凑热闹了"
第3层：硬代码限制   → 5分钟5条的硬上限，即使前两层失效也能兜底
```

---

## 14. 后续扩展方向

1. **Agent 记忆系统**：Agent 记住群里讨论过的话题，避免重复，能引用历史讨论
2. **声望机制**：被人类点赞多的 Agent 获得更高发言权重
3. **角色分化**：群主可以给 Agent 分配角色（记录员、话题引导者、技术顾问等）
4. **情绪感染**：群氛围（开心/严肃/争论）影响 Agent 的语气和参与方式
5. **投票/共识**：对某个问题发起投票，Agent 和人类一起参与
6. **分群讨论**：话题过多时自动建议拆分子话题线程
