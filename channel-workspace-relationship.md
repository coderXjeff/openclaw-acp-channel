# Channel ä¸ Workspace çš„å…³ç³»

æ ¸å¿ƒç»“è®ºï¼š**Channel å’Œ Workspace æ²¡æœ‰ç›´æ¥ç»‘å®šå…³ç³»ã€‚Workspace æ˜¯ Agent çº§åˆ«çš„æ¦‚å¿µï¼ŒChannel æ˜¯æ¶ˆæ¯å…¥å£ï¼ŒäºŒè€…é€šè¿‡è·¯ç”±ï¼ˆBindingï¼‰é—´æ¥å…³è”ã€‚**

---

## ä¸€ã€å…³ç³»æ€»è§ˆå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¶ˆæ¯æµå…¥æ–¹å‘                                â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Telegram â”‚  â”‚ Discord  â”‚  â”‚  Slack   â”‚  â”‚ WhatsApp â”‚   â”‚
â”‚  â”‚ (channel)â”‚  â”‚ (channel)â”‚  â”‚ (channel)â”‚  â”‚ (channel)â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚              â”‚              â”‚              â”‚         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                             â”‚                                â”‚
â”‚                    resolveAgentRoute()                        â”‚
â”‚                    (bindings è·¯ç”±åŒ¹é…)                         â”‚
â”‚                             â”‚                                â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚              â–¼              â–¼              â–¼                 â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â”‚ Agent   â”‚    â”‚ Agent   â”‚    â”‚ Agent    â”‚           â”‚
â”‚       â”‚ "main"  â”‚    â”‚"researchâ”‚    â”‚ "work"   â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜           â”‚
â”‚            â”‚              â”‚              â”‚                   â”‚
â”‚            â–¼              â–¼              â–¼                   â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â”‚~/clawd/ â”‚    â”‚~/clawd-  â”‚   â”‚~/clawd-  â”‚           â”‚
â”‚       â”‚         â”‚    â”‚research/ â”‚   â”‚work/     â”‚           â”‚
â”‚       â”‚AGENTS.mdâ”‚    â”‚AGENTS.md â”‚   â”‚AGENTS.md â”‚           â”‚
â”‚       â”‚SOUL.md  â”‚    â”‚SOUL.md   â”‚   â”‚SOUL.md   â”‚           â”‚
â”‚       â”‚MEMORY.mdâ”‚    â”‚MEMORY.md â”‚   â”‚MEMORY.md â”‚           â”‚
â”‚       â”‚skills/  â”‚    â”‚skills/   â”‚   â”‚skills/   â”‚           â”‚
â”‚       â”‚...      â”‚    â”‚...       â”‚   â”‚...       â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       (workspace)    (workspace)    (workspace)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€Channel å®‰è£…ä½ç½®

Channel ä¸å®‰è£…åœ¨ workspace ä¸­ï¼Œè€Œæ˜¯å®‰è£…åœ¨**ä»£ç å±‚**ï¼š

| ç±»å‹ | å®‰è£…ä½ç½® | åŠ è½½æ–¹å¼ | ç¤ºä¾‹ |
|------|---------|---------|------|
| **æ ¸å¿ƒ Channel** | `src/<channel>/` â†’ ç¼–è¯‘åˆ° `dist/` | å†…ç½®ï¼Œéšä¸»ç¨‹åºåŠ è½½ | telegram, whatsapp, discord, slack, signal, imessage, googlechat |
| **æ‰©å±• Channel** | `extensions/<channel>/` â†’ ç¼–è¯‘åˆ°åŒ…ä¸­ | æ’ä»¶ç³»ç»ŸåŠ¨æ€åŠ è½½ | bluebubbles, googlechat, line, matrix, teams, zalo |
| **ç”¨æˆ·è‡ªè£… Channel** | `~/.clawdbot/extensions/` | æ’ä»¶ç³»ç»ŸåŠ¨æ€å‘ç° | ç”¨æˆ·è‡ªè¡Œå¼€å‘/ä¸‹è½½çš„ channel æ’ä»¶ |

### æ ¸å¿ƒ Channel æ³¨å†Œè¡¨

å®šä¹‰åœ¨ `src/channels/registry.ts:7`ï¼š

```typescript
CHAT_CHANNEL_ORDER = [
  "telegram", "whatsapp", "discord", "googlechat", "slack", "signal", "imessage"
]
```

### æ‰©å±• Channel åŠ è½½æµç¨‹

1. **å‘ç°** (`src/plugins/discovery.ts`)ï¼šæ‰«æ `~/.clawdbot/extensions/` + `extensions/` + é…ç½®çš„æ’ä»¶è·¯å¾„
2. **åŠ è½½** (`src/plugins/loader.ts`)ï¼šé€šè¿‡ `jiti`ï¼ˆTypeScript è¿è¡Œæ—¶åŠ è½½å™¨ï¼‰åŠ è½½æ’ä»¶
3. **æ³¨å†Œ**ï¼šæ¯ä¸ªæ’ä»¶è°ƒç”¨ `api.registerChannel({ plugin })` æ³¨å†Œåˆ° `PluginRegistry`

```typescript
// extensions/bluebubbles/index.ts ç¤ºä¾‹
const plugin = {
  id: "bluebubbles",
  name: "BlueBubbles",
  register(api: ClawdbotPluginApi) {
    api.registerChannel({ plugin: bluebubblesPlugin });
    api.registerHttpHandler(handleBlueBubblesWebhookRequest);
  },
};
```

### Channel è¿è¡Œæ—¶é…ç½®

å­˜å‚¨åœ¨ `~/.clawdbot/clawdbot.json` çš„ `channels.<channelId>` èŠ‚ï¼š

```json
{
  "channels": {
    "telegram": { "default": { "token": "bot123:xxx" } },
    "discord": { "default": { "token": "xxx" } }
  }
}
```

---

## ä¸‰ã€Workspace è§£æé€»è¾‘

Workspace å®Œå…¨ç”± Agent å†³å®šï¼Œæºç åœ¨ `src/agents/agent-scope.ts:136`ï¼š

```
resolveAgentWorkspaceDir(cfg, agentId):
  1. æ£€æŸ¥ agents.list[agentId].workspace â†’ è‹¥é…ç½®äº†ï¼Œç”¨å®ƒ
  2. è‹¥æ˜¯é»˜è®¤ Agent â†’ æ£€æŸ¥ agents.defaults.workspace â†’ å¦åˆ™ç”¨ ~/clawd/
  3. è‹¥éé»˜è®¤ Agent â†’ ç”¨ ~/clawd-{agentId}/
```

é…ç½®ç¤ºä¾‹ï¼š

```json
{
  "agents": {
    "defaults": { "workspace": "~/.clawd" },
    "list": [
      { "id": "main", "default": true, "workspace": "~/.clawd" },
      { "id": "research", "workspace": "~/clawd-research" }
    ]
  }
}
```

---

## å››ã€è·¯ç”±ï¼šChannel å¦‚ä½•å…³è”åˆ° Agentï¼ˆè¿›è€Œå…³è”åˆ° Workspaceï¼‰

æ¶ˆæ¯ä» Channel åˆ° Agent çš„è·¯ç”±å‘ç”Ÿåœ¨ `resolveAgentRoute()` (`src/routing/resolve-route.ts:142`)ã€‚

### è·¯ç”±åŒ¹é…ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | åŒ¹é…ç±»å‹ | åŒ¹é…æ¡ä»¶ | ç¤ºä¾‹é…ç½® | åœºæ™¯ |
|--------|---------|---------|---------|------|
| 1 (æœ€é«˜) | `binding.peer` | ç²¾ç¡®åˆ°ç”¨æˆ·/ç¾¤ç»„ | `{ agentId: "work", match: { channel: "telegram", peer: { kind: "dm", id: "user_123" } } }` | æŒ‡å®šç”¨æˆ·çš„æ¶ˆæ¯å‘ç»™ç‰¹å®š Agent |
| 2 | `binding.guild` | Discord æœåŠ¡å™¨çº§ | `{ agentId: "research", match: { channel: "discord", guildId: "123456" } }` | æŸä¸ª Discord æœåŠ¡å™¨çš„æ‰€æœ‰æ¶ˆæ¯å‘ç»™ research Agent |
| 3 | `binding.team` | Teams/Slack å›¢é˜Ÿçº§ | `{ agentId: "work", match: { channel: "slack", teamId: "T123" } }` | æŸä¸ª Slack å›¢é˜Ÿå‘ç»™ work Agent |
| 4 | `binding.account` | ç²¾ç¡®è´¦å· | `{ agentId: "main", match: { channel: "telegram", accountId: "default" } }` | æŸä¸ª Telegram bot è´¦å·çš„æ‰€æœ‰æ¶ˆæ¯ |
| 5 | `binding.channel` | é€šé…è´¦å· | `{ agentId: "main", match: { channel: "telegram", accountId: "*" } }` | è¯¥æ¸ é“æ‰€æœ‰è´¦å· |
| 6 (æœ€ä½) | `default` | æ— åŒ¹é… | æ— éœ€é…ç½® | å›é€€åˆ°é»˜è®¤ Agent |

### Binding é…ç½®ç¤ºä¾‹

```json
{
  "bindings": [
    {
      "agentId": "research",
      "match": { "channel": "discord", "guildId": "123456789" }
    },
    {
      "agentId": "main",
      "match": { "channel": "*", "accountId": "*" }
    }
  ]
}
```

---

## äº”ã€Session Key ç¼–ç  Channel ä¿¡æ¯

è·¯ç”±å®Œæˆåç”Ÿæˆ session keyï¼Œç¼–ç äº† channel + peer ä¿¡æ¯ï¼š

```
agent:main:main                              â† ä¸»ä¼šè¯ï¼ˆWebChat ç›´æ¥å¯¹è¯ï¼‰
agent:main:telegram:dm:user_123              â† Telegram ç§èŠ (per-channel-peer æ¨¡å¼)
agent:main:discord:group:channel_456         â† Discord ç¾¤ç»„
agent:research:discord:dm:user_789           â† research Agent çš„ Discord ç§èŠ
agent:main:dm:user_123                       â† è·¨æ¸ é“åˆå¹¶ (per-peer æ¨¡å¼)
```

DM éš”ç¦»æ¨¡å¼ç”± `config.session.dmScope` æ§åˆ¶ï¼š

| dmScope | è¡Œä¸º | Session Key ç¤ºä¾‹ |
|---------|------|-----------------|
| `"main"` (é»˜è®¤) | æ‰€æœ‰ DM åˆå¹¶åˆ°ä¸»ä¼šè¯ | `agent:main:main` |
| `"per-peer"` | æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ä¼šè¯ï¼Œè·¨æ¸ é“åˆå¹¶ | `agent:main:dm:user_123` |
| `"per-channel-peer"` | æ¯ä¸ªæ¸ é“+ç”¨æˆ·ç‹¬ç«‹ä¼šè¯ | `agent:main:telegram:dm:user_123` |

Session key å†³å®šäº†ä¼šè¯å†å²çš„éš”ç¦»ç²’åº¦ï¼Œä½†**ä¸å½±å“ workspace**â€”â€”åŒä¸€ Agent çš„æ‰€æœ‰ session å…±äº«åŒä¸€ä¸ª workspaceã€‚

---

## å…­ã€å®Œæ•´æ¶ˆæ¯æµè½¬é“¾è·¯

```
Channel (å®‰è£…åœ¨ä»£ç /æ’ä»¶å±‚)
  â”‚
  â”‚ 1. æ¥æ”¶æ¶ˆæ¯ï¼Œæå– channel + accountId + peer
  â”‚
  â–¼
è·¯ç”±å±‚ resolveAgentRoute()
  â”‚
  â”‚ 2. æŒ‰ bindings åŒ¹é…ï¼Œå†³å®š agentId
  â”‚ 3. ç”Ÿæˆ sessionKey (å« channel+peer ä¿¡æ¯)
  â”‚
  â–¼
Agent å±‚
  â”‚
  â”‚ 4. resolveAgentWorkspaceDir(agentId) â†’ workspace ç›®å½•
  â”‚ 5. åŠ è½½ workspace æ–‡ä»¶ (SOUL.md, AGENTS.md, ...)
  â”‚ 6. åŠ è½½ session å†å² (æŒ‰ sessionKey éš”ç¦»)
  â”‚
  â–¼
LLM è°ƒç”¨ (workspace æ–‡ä»¶æ³¨å…¥ system prompt, session å†å²æ³¨å…¥ messages)
```

---

## ä¸ƒã€Channel ç‰¹å®šæç¤ºè¯æ³¨å…¥æœºåˆ¶

è™½ç„¶ Channel å’Œ Workspace æ²¡æœ‰ç›´æ¥ç»‘å®šï¼Œä½†ä¸åŒ Channel ä¼šå‘ LLM çš„ System Prompt æ³¨å…¥**ä¸åŒçš„ Channel ç‰¹å®šæç¤ºè¯**ã€‚è¿™äº›æç¤ºè¯é€šè¿‡ 5 ä¸ªæ³¨å…¥ç‚¹è¿›å…¥ä¸Šä¸‹æ–‡çª—å£ã€‚

### 7.1 æ³¨å…¥ç‚¹æ€»è§ˆ

```
System Prompt ç»„è£…æ—¶
  â”‚
  â”œâ”€ ## Messaging æ®µè½
  â”‚    â””â”€ resolveChannelMessageToolHints()   â† æ³¨å…¥ç‚¹ 1: messageToolHints
  â”‚
  â”œâ”€ ## Reactions æ®µè½
  â”‚    â””â”€ resolveTelegramReactionLevel()     â† æ³¨å…¥ç‚¹ 2: reactionGuidance
  â”‚    â””â”€ resolveSignalReactionLevel()
  â”‚
  â”œâ”€ ## Runtime è¡Œ
  â”‚    â””â”€ resolveChannelCapabilities()       â† æ³¨å…¥ç‚¹ 3: capabilities
  â”‚    â””â”€ listChannelSupportedActions()      â† æ³¨å…¥ç‚¹ 4: channelActions
  â”‚
  â””â”€ ## Group Chat Context (extraSystemPrompt)
       â””â”€ buildGroupIntro()                  â† æ³¨å…¥ç‚¹ 5: groupIntroHint
            â””â”€ dock.groups.resolveGroupIntroHint()
```

### 7.2 æ³¨å…¥ç‚¹ 1: `messageToolHints` â€” Channel ä¸“å± message å·¥å…·æŒ‡å—

**æ³¨å…¥ä½ç½®**: System Prompt â†’ `## Messaging` â†’ `### message tool` æœ«å°¾

æ¯ä¸ª Channel æ’ä»¶å¯é€šè¿‡ `ChannelPlugin.agentPrompt.messageToolHints` æ¥å£æä¾›ç‰¹å®šçš„æ¶ˆæ¯æ ¼å¼æŒ‡å¯¼ã€‚ä»£ç å…¥å£åœ¨ `src/agents/channel-tools.ts:52`ï¼Œé€šè¿‡ `resolveChannelMessageToolHints()` è°ƒç”¨å½“å‰ Channel çš„ dockã€‚

**å½“å‰å·²å®ç°çš„ Channel**:

| Channel | æ³¨å…¥å†…å®¹ | æ¥æºæ–‡ä»¶ | é¢„ä¼° Token |
|---------|---------|---------|-----------|
| **LINE** | ~48 è¡Œå¯Œæ¶ˆæ¯æŒ‡å—ï¼š`[[quick_replies:...]]`ã€`[[location:...]]`ã€`[[confirm:...]]`ã€`[[buttons:...]]`ã€`[[media_player:...]]`ã€`[[event:...]]`ã€`[[agenda:...]]`ã€`[[device:...]]`ã€`[[appletv_remote:...]]` ç­‰ LINE Flex å¡ç‰‡è¯­æ³• | `extensions/line/src/channel.ts:724` | ~400 |
| **MS Teams** | 2 è¡Œï¼šAdaptive Cards å‘é€æ–¹å¼ + target æ ¼å¼ï¼ˆ`user:ID`ã€`conversation:19:...@thread.tacv2`ï¼‰ | `extensions/msteams/src/channel.ts:68` | ~60 |
| å…¶ä»– Channel | æš‚æ— å®ç°ï¼Œä½†**æ¥å£å·²é¢„ç•™**ï¼Œä»»ä½•æ’ä»¶éƒ½å¯é€šè¿‡å®ç° `agentPrompt.messageToolHints` æ³¨å…¥ | `types.plugin.ts:77` | - |

**LINE æ³¨å…¥å†…å®¹ç¤ºä¾‹**:

```
### LINE Rich Messages
LINE supports rich visual messages. Use these directives in your reply when appropriate:

**Quick Replies** (bottom button suggestions):
  [[quick_replies: Option 1, Option 2, Option 3]]

**Location** (map pin):
  [[location: Place Name | Address | latitude | longitude]]

**Confirm Dialog** (yes/no prompt):
  [[confirm: Question text? | Yes Label | No Label]]

**Button Menu** (title + text + buttons):
  [[buttons: Title | Description | Btn1:action1, Btn2:https://url.com]]
...
```

### 7.3 æ³¨å…¥ç‚¹ 2: `reactionGuidance` â€” Emoji ååº”è¡Œä¸ºæŒ‡å¯¼

**æ³¨å…¥ä½ç½®**: System Prompt â†’ `## Reactions` æ®µè½ (`system-prompt.ts:470-492`)

ä»… **Telegram** å’Œ **Signal** æœ‰æ­¤æœºåˆ¶ï¼Œé€šè¿‡å„è‡ªçš„ `resolveXxxReactionLevel()` å‡½æ•°è¯»å–é…ç½®ã€‚

| Channel | é…ç½®è·¯å¾„ | çº§åˆ« | æ³¨å…¥çš„æç¤ºè¯ |
|---------|---------|------|------------|
| **Telegram** | `channels.telegram.reactionLevel` | `off` | ä¸æ³¨å…¥ä»»ä½•å†…å®¹ |
| | | `ack` | ä¸æ³¨å…¥ agent ååº”æŒ‡å¯¼ï¼ˆä»…å¯ç”¨å¤„ç†ä¸­çš„ ğŸ‘€ ååº”ï¼‰ |
| | | `minimal` (é»˜è®¤) | "React sparingly â€” at most once per 5â€“10 exchanges. Only when genuinely relevant." |
| | | `extensive` | "Feel free to react liberallyâ€¦react whenever it feels natural." |
| **Signal** | `channels.signal.reactionLevel` | åŒä¸Š | åŒä¸Šè§„åˆ™ |
| å…¶ä»– Channel | - | - | ä¸æ³¨å…¥ååº”æŒ‡å¯¼ |

æ¥æº: `src/telegram/reaction-level.ts`, `src/signal/reaction-level.ts`

### 7.4 æ³¨å…¥ç‚¹ 3: `capabilities` â€” æ¸ é“èƒ½åŠ›å£°æ˜

**æ³¨å…¥ä½ç½®**: System Prompt â†’ `## Runtime` è¡Œçš„ `capabilities=...` éƒ¨åˆ†

æ¯ä¸ª Channel åœ¨ `dock.capabilities` ä¸­å£°æ˜è‡ªèº«æ”¯æŒçš„èƒ½åŠ›ï¼ˆ`src/channels/dock.ts`ï¼‰ã€‚è¿™äº›èƒ½åŠ›å­—ç¬¦ä¸²è¢«æ‹¼å…¥ Runtime è¡Œï¼ŒåŒæ—¶å½±å“ `## Messaging` æ®µè½ä¸­çš„ inline buttons åˆ¤æ–­ã€‚

| Channel | å£°æ˜çš„ capabilities | æ¥æº |
|---------|-------------------|------|
| **Telegram** | `chatTypes: [direct, group, channel, thread]`, `nativeCommands`, `blockStreaming` | `dock.ts:94-98` |
| **Telegram** (é…ç½®å) | + `inlineButtons`ï¼ˆè§¦å‘ Messaging æ®µè½ä¸­ inline buttons ç”¨æ³•æ³¨å…¥ï¼‰ | `config.channels.telegram.capabilities` |
| **WhatsApp** | `chatTypes: [direct, group]`, `polls`, `reactions`, `media` | `dock.ts:131-135` |
| **Discord** | `chatTypes: [direct, channel, thread]`, `polls`, `reactions`, `media`, `nativeCommands`, `threads` | `dock.ts:179-185` |
| **Slack** | `chatTypes: [direct, channel, thread]`, `reactions`, `media`, `nativeCommands`, `threads` | `dock.ts:276-282` |
| **Signal** | `chatTypes: [direct, group]`, `reactions`, `media` | `dock.ts:305-309` |
| **iMessage** | `chatTypes: [direct, group]`, `reactions`, `media` | `dock.ts:340-344` |
| **Google Chat** | `chatTypes: [direct, group, thread]`, `reactions`, `media`, `threads`, `blockStreaming` | `dock.ts:219-224` |

**Runtime è¡Œç¤ºä¾‹**:

```
Runtime: agent=main | host=my-mac | channel=telegram | capabilities=nativeCommands,blockStreaming,inlineButtons | thinking=off
```

### 7.5 æ³¨å…¥ç‚¹ 4: `channelActions` â€” æ”¯æŒçš„æ¶ˆæ¯åŠ¨ä½œ

**æ³¨å…¥ä½ç½®**: ä¼ å…¥ `buildSystemPromptParams()` â†’ `runtimeInfo.channelActions`

`listChannelSupportedActions()` (`src/agents/channel-tools.ts:11`) æŸ¥è¯¢å½“å‰ Channel æ’ä»¶æ”¯æŒå“ªäº›æ¶ˆæ¯åŠ¨ä½œï¼ˆå¦‚ `react`, `edit`, `unsend`, `pin`, `set_topic` ç­‰ï¼‰ï¼Œæ³¨å…¥åˆ°è¿è¡Œæ—¶ä¿¡æ¯ä¸­ï¼Œè®© Agent çŸ¥é“å¯ä»¥å¯¹æ¶ˆæ¯æ‰§è¡Œå“ªäº›æ“ä½œã€‚

### 7.6 æ³¨å…¥ç‚¹ 5: `groupIntroHint` â€” ç¾¤èŠä¸Šä¸‹æ–‡ä¸­çš„ Channel ç‰¹å®šæç¤º

**æ³¨å…¥ä½ç½®**: System Prompt â†’ `## Group Chat Context` (`extraSystemPrompt`)

å½“æ¶ˆæ¯æ¥è‡ªç¾¤èŠæ—¶ï¼Œ`buildGroupIntro()` (`src/auto-reply/reply/groups.ts:56`) æ„å»ºç¾¤èŠä¸Šä¸‹æ–‡ã€‚å…¶ä¸­è°ƒç”¨ `dock.groups.resolveGroupIntroHint()` æ³¨å…¥ Channel ç‰¹å®šä¿¡æ¯ï¼š

| Channel | ç¾¤èŠæç¤ºå†…å®¹ | æ¥æº |
|---------|------------|------|
| **WhatsApp** | `"WhatsApp IDs: SenderId is the participant JID; [message_id: ...] is the message id for reactions (use SenderId as participant)."` | `dock.ts:154` |
| å…¶ä»– Channel | æ— é¢å¤–ç¾¤èŠæç¤º | - |

**å®Œæ•´ç¾¤èŠä¸Šä¸‹æ–‡ç¤ºä¾‹ï¼ˆWhatsApp ç¾¤ï¼‰**:

```
You are replying inside the WhatsApp group "å®¶åº­ç¾¤".
Group members: Alice, Bob, Charlie.
Activation: always-on (you receive every group message).
WhatsApp IDs: SenderId is the participant JID; [message_id: ...] is the message id for reactions (use SenderId as participant).
If no response is needed, reply with exactly ":::CLAWDBOT_SILENT:::" (and nothing else)...
Be extremely selective: reply only when directly addressed or clearly helpful. Otherwise stay silent.
Be a good group participant: mostly lurk and follow the conversation; reply only when directly addressed or you can add clear value...
Write like a human. Avoid Markdown tables. Don't type literal \n sequences; use real line breaks sparingly.
Address the specific sender noted in the message context.
```

### 7.7 Channel ç‰¹å®šæç¤ºè¯å…¨æ™¯å¯¹ç…§è¡¨

| æç¤ºè¯æ³¨å…¥ç‚¹ | Telegram | Discord | WhatsApp | Slack | Signal | LINE | MS Teams | iMessage | Google Chat |
|-------------|----------|---------|----------|-------|--------|------|----------|----------|-------------|
| **messageToolHints** | - | - | - | - | - | 48è¡Œå¯Œæ¶ˆæ¯æŒ‡å— | 2è¡Œ Adaptive Cards | - | - |
| **reactionGuidance** | minimal/extensive | - | - | - | minimal/extensive | - | - | - | - |
| **inlineButtons æŒ‡å¯¼** | é…ç½®åæ³¨å…¥ | - | - | - | - | - | - | - | - |
| **groupIntroHint** | - | - | WhatsApp JID æ ¼å¼ | - | - | - | - | - | - |
| **capabilities** | nativeCommands, blockStreaming | polls, reactions, media, nativeCommands, threads | polls, reactions, media | reactions, media, nativeCommands, threads | reactions, media | (æ’ä»¶å®šä¹‰) | (æ’ä»¶å®šä¹‰) | reactions, media | reactions, media, threads, blockStreaming |
| **channelActions** | æ’ä»¶å®šä¹‰ | æ’ä»¶å®šä¹‰ | æ’ä»¶å®šä¹‰ | æ’ä»¶å®šä¹‰ | æ’ä»¶å®šä¹‰ | æ’ä»¶å®šä¹‰ | æ’ä»¶å®šä¹‰ | æ’ä»¶å®šä¹‰ | æ’ä»¶å®šä¹‰ |
| **groupIntro provider æ ‡ç­¾** | "Telegram group" | "Discord channel" | "WhatsApp group" | "Slack channel" | "Signal group" | "LINE group" | "Teams channel" | "iMessage group" | "Google Chat group" |

### 7.8 æ‰©å±•ç‚¹ï¼šå¦‚ä½•ä¸ºæ–° Channel æ·»åŠ æç¤ºè¯

Channel æ’ä»¶é€šè¿‡å®ç° `ChannelPlugin` æ¥å£ï¼ˆ`src/channels/plugins/types.plugin.ts:48`ï¼‰çš„ä»¥ä¸‹å­—æ®µæ³¨å…¥æç¤ºè¯ï¼š

```typescript
const myChannelPlugin: ChannelPlugin = {
  id: "my-channel",
  // ...
  capabilities: {                      // â†’ æ³¨å…¥ç‚¹ 3: Runtime capabilities
    chatTypes: ["direct", "group"],
    reactions: true,
    media: true,
  },
  agentPrompt: {                       // â†’ æ³¨å…¥ç‚¹ 1: messageToolHints
    messageToolHints: ({ cfg }) => [
      "My channel supports special [[card:...]] syntax.",
    ],
  },
  groups: {                            // â†’ æ³¨å…¥ç‚¹ 5: groupIntroHint
    resolveGroupIntroHint: () =>
      "My channel uses special ID format: user@domain.",
  },
  actions: {                           // â†’ æ³¨å…¥ç‚¹ 4: channelActions
    listActions: ({ cfg }) => ["react", "edit", "unsend"],
    // ...
  },
};
```

æ³¨å…¥ç‚¹ 2 (reactionGuidance) ç›®å‰æ˜¯ç¡¬ç¼–ç åœ¨ `system-prompt.ts` ä¸­ä»…å¯¹ Telegram/Signal ç”Ÿæ•ˆï¼Œæ–° Channel éœ€è¦ä¿®æ”¹ `system-prompt.ts` æˆ–é€šè¿‡ `capabilities` é—´æ¥å½±å“ã€‚

---

## å…«ã€æ¦‚å¿µéš”ç¦»å¯¹ç…§è¡¨ï¼ˆå« Channel æç¤ºè¯ï¼‰

| æ¦‚å¿µ | éš”ç¦»ç²’åº¦ | å­˜å‚¨ä½ç½® | è¯´æ˜ |
|------|---------|---------|------|
| **Channel** | å…¨å±€å…±äº« | ä»£ç å±‚ (`src/`, `extensions/`, `~/.clawdbot/extensions/`) | æ¶ˆæ¯é€šé“ï¼Œä¸æŒæœ‰ workspace |
| **Channel é…ç½®** | å…¨å±€ | `~/.clawdbot/clawdbot.json` â†’ `channels.*` | Tokenã€è´¦å·ç­‰è¿è¡Œæ—¶é…ç½® |
| **Channel æç¤ºè¯** | æŒ‰ Channel ç±»å‹ | ç¡¬ç¼–ç åœ¨ Channel æ’ä»¶ä¸­ (`dock.ts`, `extensions/*/channel.ts`) | ä¸åŒ Channel å‘ System Prompt æ³¨å…¥ä¸åŒçš„æ ¼å¼æŒ‡å¯¼ã€èƒ½åŠ›å£°æ˜ã€ååº”è§„åˆ™ |
| **Agent** | æŒ‰ agentId | `config.agents.list[]` | ä¸€ä¸ª Agent = ä¸€ä¸ªäººæ ¼ + ä¸€ä¸ª workspace |
| **Workspace** | æŒ‰ Agent | `~/clawd/` æˆ– `~/clawd-{agentId}/` | Agent çš„"å®¶"â€”â€”äººæ ¼ã€è®°å¿†ã€æŠ€èƒ½éƒ½åœ¨è¿™é‡Œ |
| **Session** | æŒ‰ channel + peer + agent | `~/.clawdbot/sessions/<sessionKey>.jsonl` | å¯¹è¯å†å²ï¼Œéš”ç¦»åˆ°å…·ä½“çš„ç”¨æˆ·/ç¾¤ç»„/æ¸ é“ç»„åˆ |
| **Binding** | è·¯ç”±è§„åˆ™ | `config.bindings[]` | å°† channel æ¶ˆæ¯è·¯ç”±åˆ°ç‰¹å®š Agent |

---

## ä¹ã€å…³é”®æºç æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `src/channels/registry.ts` | æ ¸å¿ƒ Channel æ³¨å†Œè¡¨ä¸å…ƒæ•°æ® |
| `src/channels/dock.ts` | Channel Dock å®šä¹‰ï¼šcapabilitiesã€threadingã€groupIntroHintã€agentPrompt |
| `src/channels/plugins/index.ts` | Channel æ’ä»¶åŠ è½½/åˆ—è¡¨ |
| `src/channels/plugins/types.plugin.ts` | `ChannelPlugin` æ¥å£å®šä¹‰ï¼ˆå« `agentPrompt` æ‰©å±•ç‚¹ï¼‰ |
| `src/channels/plugins/types.core.ts` | `ChannelAgentPromptAdapter`ã€`ChannelCapabilities` ç±»å‹å®šä¹‰ |
| `src/agents/channel-tools.ts` | `resolveChannelMessageToolHints()`ã€`listChannelSupportedActions()` |
| `src/agents/system-prompt.ts` | System Prompt ç»„è£…ï¼ŒReactions æ®µè½ç¡¬ç¼–ç  |
| `src/config/channel-capabilities.ts` | `resolveChannelCapabilities()` â€” è¯»å–æ¸ é“èƒ½åŠ›é…ç½® |
| `src/telegram/reaction-level.ts` | Telegram Emoji ååº”çº§åˆ«è§£æ |
| `src/signal/reaction-level.ts` | Signal Emoji ååº”çº§åˆ«è§£æ |
| `src/auto-reply/reply/groups.ts` | `buildGroupIntro()` â€” æ„å»ºç¾¤èŠä¸Šä¸‹æ–‡ï¼ˆå« Channel ç‰¹å®šæç¤ºï¼‰ |
| `src/routing/resolve-route.ts` | æ¶ˆæ¯ â†’ Agent è·¯ç”±è§£æ |
| `src/routing/session-key.ts` | Session Key æ„å»ºä¸è§£æ |
| `src/routing/bindings.ts` | Binding è§„åˆ™è¯»å– |
| `src/gateway/server-channels.ts` | Channel ç”Ÿå‘½å‘¨æœŸç®¡ç† (start/stop) |
| `src/plugins/discovery.ts` | æ’ä»¶å‘ç°ï¼ˆæ‰«ææ‰©å±•ç›®å½•ï¼‰ |
| `src/plugins/loader.ts` | æ’ä»¶åŠ è½½ï¼ˆjiti è¿è¡Œæ—¶åŠ è½½ï¼‰ |
| `src/plugins/registry.ts` | æ’ä»¶æ³¨å†Œè¡¨ |
| `src/agents/agent-scope.ts` | Agent é…ç½®ä¸ Workspace è§£æ |
| `src/agents/workspace.ts` | Workspace å¼•å¯¼æ–‡ä»¶ç®¡ç† |
| `extensions/line/src/channel.ts` | LINE Channel æ’ä»¶ï¼ˆmessageToolHints å®ç°ç¤ºä¾‹ï¼‰ |
| `extensions/msteams/src/channel.ts` | MS Teams Channel æ’ä»¶ï¼ˆmessageToolHints å®ç°ç¤ºä¾‹ï¼‰ |

---

## åã€ç±»æ¯”æ€»ç»“

**Channel æ˜¯"é—¨"ï¼ˆæ¶ˆæ¯å…¥å£ï¼‰ï¼ŒWorkspace æ˜¯"å®¶"ï¼ˆAgent çš„æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚**

- å¤šä¸ª"é—¨"å¯ä»¥é€šå¾€åŒä¸€ä¸ª"å®¶"ï¼ˆå¤šä¸ª Channel è·¯ç”±åˆ°åŒä¸€ä¸ª Agentï¼‰
- å“ªä¸ª"é—¨"é€šå‘å“ªä¸ª"å®¶"ç”± bindings è·¯ç”±è§„åˆ™å†³å®š
- "å®¶"é‡Œçš„ä¸œè¥¿ï¼ˆSOUL.mdã€MEMORY.mdã€skills/ï¼‰è·Ÿ"é—¨"æ— å…³ï¼Œåªè·Ÿä½åœ¨"å®¶"é‡Œçš„ Agent æœ‰å…³
- å¯¹è¯è®°å½•ï¼ˆSessionï¼‰æŒ‰"é—¨+æ¥è®¿è€…"éš”ç¦»å­˜å‚¨ï¼Œä½†è®¿é—®çš„"å®¶"å–å†³äº Agent
