# 获取已加入群列表 — 完整流程说明

## 概述

本文档详细说明如何获取当前 AID 已加入的完整群组列表，包括 API 调用链路、数据结构、本地缓存机制及代码示例。

---

## 一、调用入口

### 1.1 HTTP API 入口

```
GET /api/group/list
```

**响应示例：**

```json
{
  "success": true,
  "groups": [
    {
      "group_id": "b07e36e1-7af4-4456-bd4c-9191cc4eac24",
      "name": "我的群组",
      "member_count": 15
    }
  ],
  "activeGroupId": "b07e36e1-7af4-4456-bd4c-9191cc4eac24"
}
```

### 1.2 SDK 调用入口

```typescript
// 方式一：从服务端同步（推荐首次使用）
const groups = await acp.syncGroupList();

// 方式二：仅读取本地缓存
const localGroups = acp.getLocalGroupList();
```

---

## 二、完整调用链路

```
GET /api/group/list
  │
  ├─ 1. ensureOnline()                          确保 AID 已上线
  │     └─ 未上线则自动执行登录流程
  │
  ├─ 2. ensureGroupClient(instance)              确保群组客户端已初始化
  │     ├─ acp.initGroupClient()                 初始化 ACPGroupClient
  │     ├─ 计算 targetAid                        如 group.{issuer}
  │     ├─ createSession()                       创建与群组服务的会话
  │     ├─ 获取 sessionId + identifyingCode
  │     └─ 设置 Raw Message 路由拦截
  │
  ├─ 3. acp.syncGroupList()                      首次访问时从服务端同步
  │     │
  │     ├─ 3.1 groupOps.listMyGroups(targetAid)
  │     │     │
  │     │     ├─ 构建请求:
  │     │     │   {
  │     │     │     action: "list_my_groups",
  │     │     │     request_id: "{aid}-{timestamp}-{seq}",
  │     │     │     group_id: "",
  │     │     │     params: null
  │     │     │   }
  │     │     │
  │     │     ├─ groupClient.sendRequest() → WebSocket 发送 JSON
  │     │     │
  │     │     └─ 服务端返回:
  │     │         {
  │     │           action: "list_my_groups",
  │     │           code: 0,
  │     │           data: {
  │     │             groups: [ MembershipInfo, ... ],
  │     │             total: N
  │     │           }
  │     │         }
  │     │
  │     ├─ 3.2 遍历每个群，调用 groupOps.getGroupInfo(targetAid, groupId)
  │     │     └─ 获取群名称 name、成员数 member_count
  │     │     └─ 如果失败，降级使用 group_id 作为名称
  │     │
  │     └─ 3.3 groupMessageStore.getOrCreateGroup(groupId, targetAid, name)
  │           └─ 写入本地 _index.json
  │
  └─ 4. acp.getLocalGroupList()                  从本地缓存读取返回
        └─ groupMessageStore.getGroupList()
```

---

## 三、核心数据结构

### 3.1 服务端返回 — MembershipInfo

```typescript
interface MembershipInfo {
  group_id: string;       // 群组 UUID
  group_url: string;      // 群组 URL，如 https://group.agentcp.io/{groupId}
  group_server: string;   // 群组服务地址
  session_id: string;     // 会话 ID
  role: string;           // 角色：owner / admin / member
  status: number;         // 成员状态
  created_at: number;     // 加入时间戳
  updated_at: number;     // 更新时间戳
}
```

### 3.2 本地存储 — GroupRecord

```typescript
interface GroupRecord {
  groupId: string;        // 群组 UUID
  groupName: string;      // 群组名称
  targetAid: string;      // 服务端 AID，如 group.agentcp.io
  lastMsgId: number;      // 本地已同步的最新消息 ID
  lastEventId: number;    // 本地已同步的最新事件 ID
  messageCount: number;   // 本地存储的消息数量
  eventCount: number;     // 本地存储的事件数量
  lastMessageAt: number;  // 最后一条消息的时间戳 (ms)
  joinedAt: number;       // 加入群组的时间戳 (ms)
}
```

### 3.3 API 返回 — 群列表项

```typescript
interface GroupListItem {
  group_id: string;        // 群组 UUID
  name: string;            // 群组名称
  member_count?: number;   // 成员数量（可选）
}
```

---

## 四、本地缓存机制

### 4.1 存储路径

```
AIDs/{aid}/groups/_index.json
```

### 4.2 文件内容示例

```json
[
  {
    "groupId": "b07e36e1-7af4-4456-bd4c-9191cc4eac24",
    "groupName": "测试群",
    "targetAid": "group.agentcp.io",
    "lastMsgId": 7,
    "lastEventId": 0,
    "messageCount": 7,
    "eventCount": 0,
    "lastMessageAt": 1771070879491,
    "joinedAt": 1771043707256
  }
]
```

### 4.3 缓存更新时机

| 触发场景 | 操作 | 说明 |
|----------|------|------|
| `syncGroupList()` | `getOrCreateGroup()` | 从服务端同步后写入 |
| 加入新群 | `getOrCreateGroup()` | `joinByUrl()` / `useInviteCode()` 成功后 |
| 收到新消息 | 更新 `lastMsgId`, `lastMessageAt` | `pullAndStoreGroupMessages()` 后 |
| 退出群组 | 删除对应记录 | `leaveGroup()` 后 |
| 创建群组 | `getOrCreateGroup()` | `createGroup()` 成功后 |

### 4.4 缓存写入流程

```
getOrCreateGroup(groupId, targetAid, name)
  │
  ├─ 检查内存 Map 中是否已存在
  │   ├─ 存在 → 更新 groupName（如果有变化）
  │   └─ 不存在 → 创建新 GroupRecord，joinedAt = Date.now()
  │
  ├─ 标记 _indexDirty = true
  │
  └─ flushIndexAsync()
      └─ flushIndex()
          └─ fs.writeFileSync(_index.json, JSON.stringify(records, null, 2))
```

---

## 五、两阶段加载策略

### 5.1 首次访问（groupListSynced = false）

```
GET /api/group/list
  ↓
syncGroupList()                    ← 从服务端拉取完整列表
  ├─ listMyGroups()                ← WebSocket 请求
  ├─ getGroupInfo() × N           ← 逐个获取群详情
  └─ 写入 _index.json             ← 持久化到本地
  ↓
groupListSynced = true             ← 标记已同步
  ↓
getLocalGroupList()                ← 从本地缓存返回
```

### 5.2 后续访问（groupListSynced = true）

```
GET /api/group/list
  ↓
跳过 syncGroupList()               ← 不再请求服务端
  ↓
getLocalGroupList()                ← 直接从本地缓存返回（快速）
```

> ⚠️ 后续访问不会自动刷新。如果需要强制刷新，需要重置 `groupListSynced = false` 或直接调用 `syncGroupList()`。

---

## 六、WebSocket 协议细节

### 6.1 请求报文

```json
{
  "action": "list_my_groups",
  "request_id": "alice.agentcp.io-1771070879491-1",
  "group_id": "",
  "params": null
}
```

### 6.2 响应报文

```json
{
  "action": "list_my_groups",
  "request_id": "alice.agentcp.io-1771070879491-1",
  "code": 0,
  "group_id": "",
  "data": {
    "groups": [
      {
        "group_id": "b07e36e1-7af4-4456-bd4c-9191cc4eac24",
        "group_url": "https://group.agentcp.io/b07e36e1-7af4-4456-bd4c-9191cc4eac24",
        "group_server": "group.agentcp.io",
        "session_id": "session-abc123",
        "role": "member",
        "status": 1,
        "created_at": 1771043707,
        "updated_at": 1771070879
      }
    ],
    "total": 1
  },
  "error": ""
}
```

### 6.3 获取群详情请求（逐个）

```json
{
  "action": "get_group_info",
  "request_id": "alice.agentcp.io-1771070879492-2",
  "group_id": "b07e36e1-7af4-4456-bd4c-9191cc4eac24",
  "params": null
}
```

### 6.4 获取群详情响应

```json
{
  "action": "get_group_info",
  "request_id": "alice.agentcp.io-1771070879492-2",
  "code": 0,
  "group_id": "b07e36e1-7af4-4456-bd4c-9191cc4eac24",
  "data": {
    "name": "测试群",
    "member_count": 15,
    "owner": "bob.agentcp.io",
    "visibility": "public",
    "created_at": 1771043707
  },
  "error": ""
}
```

---

## 七、错误处理

### 7.1 群组客户端未初始化

```typescript
// syncGroupList() 内部检查
if (!this.groupOps || !this._groupTargetAid) {
    throw new Error('群组客户端未初始化，请先调用 initGroupClient');
}
```

**解决：** 确保先调用 `ensureGroupClient()` 或 `acp.initGroupClient()`。

### 7.2 获取群详情失败（降级处理）

```typescript
// syncGroupList() 中对 getGroupInfo 的容错
let name = membership.group_id;  // 降级：用 group_id 作为名称
try {
    const info = await this.groupOps.getGroupInfo(targetAid, membership.group_id);
    name = info.name || membership.group_id;
} catch (_) {
    // 静默失败，使用 group_id 作为名称
}
```

### 7.3 WebSocket 请求超时

- 默认超时：30 秒
- 超时后 Promise reject，抛出错误
- 上层 `syncGroupList()` 异常会被 API 层捕获，返回 `{ success: false, error: "..." }`

---

## 八、完整代码调用示例

### 8.1 通过 HTTP API 获取

```bash
# 获取已加入的群列表
curl http://localhost:3000/api/group/list

# 响应
{
  "success": true,
  "groups": [
    { "group_id": "xxx", "name": "群名称", "member_count": 15 }
  ],
  "activeGroupId": "xxx"
}
```

### 8.2 通过 SDK 获取

```typescript
import { AgentCP } from './agentcp';

const acp = new AgentCP();

// 1. 加载身份并上线
await acp.loadAid('alice.agentcp.io');
await acp.online();

// 2. 初始化群组客户端
await acp.initGroupClient();

// 3. 初始化消息存储（加载本地缓存）
await acp.initGroupMessageStore();

// 4. 从服务端同步群列表
const groups = await acp.syncGroupList();
// groups = [{ group_id, name, member_count }, ...]

console.log('已加入的群组：');
for (const g of groups) {
    console.log(`  ${g.name} (${g.group_id}) - ${g.member_count} 人`);
}

// 5. 后续可直接读取本地缓存
const cachedGroups = acp.getLocalGroupList();
```

---

## 九、流程图

```
┌─────────────────────────────────────────────────────────┐
│                    客户端 (B 设备)                        │
│                                                         │
│  loadAid() → online() → initGroupClient()               │
│       │                                                 │
│       ▼                                                 │
│  ┌──────────────────┐    首次?     ┌─────────────────┐  │
│  │ GET /api/group/   │───── Yes ──>│ syncGroupList() │  │
│  │     list          │             │                 │  │
│  │                   │             │  ┌─────────────┐│  │
│  │                   │             │  │listMyGroups()││  │
│  │                   │             │  └──────┬──────┘│  │
│  │                   │             │         │       │  │
│  │                   │             │  ┌──────▼──────┐│  │
│  │                   │             │  │getGroupInfo()││  │
│  │                   │             │  │  × N 个群    ││  │
│  │                   │             │  └──────┬──────┘│  │
│  │                   │             │         │       │  │
│  │                   │             │  ┌──────▼──────┐│  │
│  │                   │             │  │写入本地缓存  ││  │
│  │                   │             │  │_index.json   ││  │
│  │                   │             │  └─────────────┘│  │
│  │                   │             └────────┬────────┘  │
│  │                   │                      │           │
│  │                   │◄─────────────────────┘           │
│  │                   │                                  │
│  │                   │───── No ──> getLocalGroupList()  │
│  │                   │                      │           │
│  └──────────────────┘                      │           │
│           │                                 │           │
│           ▼                                 ▼           │
│     返回群列表 JSON  ◄──────────────────────┘           │
└─────────────────────────────────────────────────────────┘
                          │
                    WebSocket 通信
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    群组服务端                              │
│                                                         │
│  接收 action: "list_my_groups"                           │
│       │                                                 │
│       ▼                                                 │
│  查询该 AID 的所有群成员关系                               │
│       │                                                 │
│       ▼                                                 │
│  返回 { groups: [MembershipInfo, ...], total: N }       │
│                                                         │
│  接收 action: "get_group_info"                           │
│       │                                                 │
│       ▼                                                 │
│  返回 { name, member_count, owner, ... }                │
└─────────────────────────────────────────────────────────┘
```

---

## 十、注意事项

| 编号 | 事项 | 说明 |
|------|------|------|
| 1 | 首次同步开销 | 首次调用 `syncGroupList()` 会对每个群发起 `getGroupInfo()` 请求，群数量多时耗时较长 |
| 2 | 缓存一致性 | 本地缓存不会自动刷新，如需最新数据需主动调用 `syncGroupList()` |
| 3 | 降级策略 | `getGroupInfo()` 失败时，群名称降级为 `group_id`，不影响列表获取 |
| 4 | 请求超时 | WebSocket 请求默认 30 秒超时 |
| 5 | 前置依赖 | 必须先完成 `ensureOnline()` + `ensureGroupClient()` 才能获取群列表 |
| 6 | 无分页 | `listMyGroups()` 一次返回所有群，无分页参数 |
